<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garahe ni Hulyo POS</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF-AutoTable for generating tables in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome for icons (e.g., bell icon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar for a metallic look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* Dark gray for track */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* Medium gray for thumb */
            border-radius: 4px;
            border: 1px solid #374151; /* Darker border */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter gray on hover */
        }

        body {
            font-family: "Inter", sans-serif;
            background-color: #1a202c; /* Darker background to match the overall theme */
        }

        /* Styles for active tab button */
        .tab-button.active {
            background-color: #3b82f6; /* Blue-600 */
            color: #ffffff;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
        }

        /* Styles for modal internal tab button */
        .modal-tab-button.active {
            background-color: #3b82f6; /* Blue-600 */
            color: #ffffff;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
        }

        /* Loading spinner styles */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Adjust main container to fill screen and use grid for layout */
        #main-app-container {
            display: grid;
            grid-template-rows: auto 1fr; /* Header row, then main content row */
            grid-template-columns: 250px 1fr 350px; /* Left sidebar, main content, right sidebar */
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevent overall scrollbars */
        }

        /* Header spans all columns */
        #main-header {
            grid-column: 1 / -1; /* Spans from first to last column line */
            background-color: #1f2937; /* Dark gray */
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #374151; /* Darker border */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10; /* Ensure it stays on top */
        }

        /* Left Sidebar */
        #left-sidebar {
            grid-column: 1;
            grid-row: 2; /* Below the header */
            background-color: #1f2937;
            padding: 1.5rem;
            border-right: 1px solid #374151;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling for navigation if needed */
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 5;
        }

        /* Main Content Area (Inventory) */
        #main-content-area {
            grid-column: 2;
            grid-row: 2;
            background-color: #2d3748; /* Slightly lighter than sidebars */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling for inventory list */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        /* Right Sidebar (Cart) */
        #right-sidebar {
            grid-column: 3;
            grid-row: 2;
            background-color: #1f2937;
            padding: 1.5rem;
            border-left: 1px solid #374151;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling for cart items */
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 5;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            #main-app-container {
                grid-template-rows: auto auto 1fr auto; /* Header, Nav, Main, Cart */
                grid-template-columns: 1fr; /* Single column */
                height: auto; /* Allow natural height for scrolling */
                overflow-y: auto;
            }

            #main-header {
                grid-column: 1;
                grid-row: 1;
                flex-direction: column;
                padding-bottom: 0.5rem;
                border-bottom: none;
                box-shadow: none;
            }

            #left-sidebar {
                grid-column: 1;
                grid-row: 2; /* Below header */
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #374151;
                padding-top: 0.5rem;
                box-shadow: none;
            }

            #main-content-area {
                grid-column: 1;
                grid-row: 3; /* Below left sidebar */
                width: 100%;
                padding-top: 1rem;
                box-shadow: none;
            }

            #right-sidebar {
                grid-column: 1;
                grid-row: 4; /* Below main content */
                width: 100%;
                border-left: none;
                border-top: 1px solid #374151;
                padding-top: 1rem;
                box-shadow: none;
            }
        }

        /* Notification styles */
        #notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 300px;
        }
        .notification-item {
            background-color: #333;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            opacity: 0;
            transform: translateY(-20px);
        }
        .notification-item.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification-item .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 1rem;
            opacity: 0.7;
        }
        .notification-item .close-btn:hover {
            opacity: 1;
        }
        .notification-item.new-sale {
            background-color: #16a34a; /* Green-600 */
        }
        .notification-item.info {
            background-color: #2563eb; /* Blue-600 */
        }
        .notification-item.success {
            background-color: #059669; /* Emerald-600 */
        }
        .notification-item.error {
            background-color: #b91c1c; /* Red-700 */
        }

        /* Styles for Notification Bell */
        #notification-bell-container {
            position: relative;
            margin-left: 1.5rem; /* Space from other header elements */
        }

        #notification-bell {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.8rem; /* Larger bell icon */
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        #notification-bell:hover {
            background-color: #374151; /* Darker gray on hover */
        }

        #notification-count-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ef4444; /* Red-500 */
            color: white;
            border-radius: 9999px; /* Full rounded */
            padding: 0.1rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 1.5rem; /* Ensure it's round even for single digit */
            text-align: center;
            transform: translate(50%, -50%); /* Offset to top-right corner */
            display: none; /* Hidden by default */
        }

    </style>

    <!-- Firebase SDK Imports (type="module" is crucial) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase objects globally for use in the main script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            createUserWithEmailAndPassword, // Added for admin to create users
            signInWithEmailAndPassword,     // Added for manual login
            signOut,                        // Added for logout
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            addDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            runTransaction,     // Added for transactions (e.g., voiding sale)
            serverTimestamp     // Added for server timestamps
        };
    </script>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <!-- Main application container with grid layout -->
    <div id="app-content-wrapper" class="hidden"> <!-- Initially hidden until login -->
        <div id="main-app-container">

            <!-- Top Header Panel -->
            <header id="main-header">
                <div class="flex items-center space-x-4">
                    <!-- Custom logo added based on user request -->
                    <img src="https://placehold.co/48x48/000000/FFFFFF?text=Logo"
                         onerror="this.onerror=null;this.src='https://placehold.co/48x48/000000/FFFFFF?text=Logo';"
                         alt="Garahe ni Hulyo Logo" class="rounded-full w-12 h-12 object-cover">
                    <h1 class="text-3xl font-extrabold text-white">Garahe ni Hulyo POS System</h1>
                </div>
                <!-- Notification Bell Icon -->
                <div id="notification-bell-container">
                    <button id="notification-bell" title="View Low Stock Items">
                        <i class="fas fa-bell"></i>
                    </button>
                    <span id="notification-count-badge" class="hidden">0</span>
                </div>
            </header>

            <!-- Left Sidebar: Navigation & Management -->
            <div id="left-sidebar">
                <!-- Navigation Bar for Main Tabs -->
                <div class="flex flex-col space-y-4 mb-6 bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700">
                    <button id="tab-inventory" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 active">Dashboard</button>
                    <button id="tab-manage-products" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Manage Products</button>
                    <button id="tab-inventory-master" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Inventory Master</button>
                    <button id="tab-report-logs" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Report Logs</button>
                    <button id="tab-sales-report" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Sales Report</button>
                    <button id="tab-coupon-management" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Coupon Management</button>
                    <button id="tab-user-management" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">User Management</button>
                </div>

                <!-- Login/Logout Section (moved to lower left) -->
                <div class="mt-auto pt-4 border-t border-gray-700">
                    <p id="current-user-role" class="text-xs text-gray-500 mb-2 text-center">Role: Not Logged In</p>
                    <button id="login-logout-button"
                            class="w-full py-2 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                   focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Login
                    </button>
                </div>
            </div>

            <!-- Main Content Area: Inventory/Product Listing (adapting from original left panel) -->
            <div id="main-content-area">
                <!-- Inventory Content Area -->
                <div id="inventory-content" class="tab-content flex-1 flex flex-col">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">Product Listing</h1>
                    <!-- Search and Filter Bar -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="inventory-search" placeholder="Search for parts..."
                               class="w-full sm:flex-1 p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                      focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                        <select id="category-filter"
                                class="w-full sm:w-auto p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200
                                       focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                            <!-- Categories will be dynamically loaded here -->
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <!-- Loading Indicator for Inventory -->
                    <div id="inventory-loading" class="flex justify-center items-center h-full hidden">
                        <div class="spinner"></div>
                        <p class="ml-3 text-gray-400">Loading Inventory...</p>
                    </div>
                    <!-- Inventory List -->
                    <div id="inventory-list" class="flex-1 overflow-y-auto pr-2">
                        <!-- Inventory items will be rendered here by JavaScript -->
                        <p class="text-gray-400 text-center py-8" id="empty-inventory-message">No inventory items found. Add some from 'Manage Products'!</p>
                    </div>
                </div>

                <!-- Inventory Master Content Area -->
                <div id="inventory-master-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">Inventory Master List</h1>
                    <!-- Search Bar for Master List -->
                    <div class="mb-6">
                        <input type="text" id="master-list-search" placeholder="Search master list items..."
                               class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                      focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                    </div>
                    <!-- Loading Indicator for Master List -->
                    <div id="master-list-loading" class="flex justify-center items-center h-full hidden">
                        <div class="spinner"></div>
                        <p class="ml-3 text-gray-400">Loading Master List...</p>
                    </div>
                    <!-- Master List -->
                    <div id="master-list" class="flex-1 overflow-y-auto pr-2">
                        <!-- Master list items will be rendered here by JavaScript -->
                    </div>
                </div>


                <!-- Report Logs Content Area -->
                <div id="report-logs-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h3 class="text-2xl font-bold text-white mb-4 text-center">Sales Report Logs</h3>
                    <!-- Loading Indicator for Sales Logs -->
                    <div id="sales-log-loading" class="flex justify-center items-center h-full hidden">
                        <div class="spinner"></div>
                        <p class="ml-3 text-gray-400">Loading Sales Logs...</p>
                    </div>
                    <div id="sales-log-list" class="flex-1 overflow-y-auto pr-2">
                        <!-- Sales logs will be rendered here by JavaScript -->
                        <p class="text-gray-400 text-center py-8" id="empty-logs-message">No sales records available yet.</p>
                    </div>
                </div>

                <!-- Sales Report Content Area -->
                <div id="sales-report-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h3 class="text-2xl font-bold text-white mb-4 text-center">Total Sales Report</h3>
                    <div class="flex justify-center space-x-4 mb-6">
                        <button id="filter-daily" class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 active">Daily</button>
                        <button id="filter-weekly" class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600">Weekly</button>
                        <button id="filter-monthly" class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600">Monthly</button>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6 text-center">
                        <h4 class="text-xl font-semibold text-blue-300 mb-2">Total Sales for Period:</h4>
                        <span id="report-total-sales" class="text-4xl font-extrabold text-white">₱0.00</span>
                        <p id="report-period-info" class="text-gray-400 text-sm mt-2"></p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6 flex-1 overflow-y-auto">
                        <h4 class="text-xl font-semibold text-blue-300 mb-4">Items Sold Summary:</h4>
                        <div id="report-items-summary">
                            <!-- Items sold summary will be rendered here as a table -->
                            <p class="text-gray-400 text-center py-8" id="empty-items-summary-message">No items sold in this period.</p>
                        </div>
                    </div>

                    <!-- Added div for individual sales logs in the sales report -->
                    <div id="report-details-list" class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6 flex-1 overflow-y-auto">
                        <!-- Individual sales logs will be rendered here as a table -->
                        <p class="text-gray-400 text-center py-8" id="empty-details-list-message">No individual sales data for this period.</p>
                    </div>

                    <button id="download-report-pdf"
                            class="w-full py-3 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105 mt-6
                                   focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Download Report (PDF)
                    </button>
                </div>

                <!-- Coupon Management Content Area -->
                <div id="coupon-management-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">Coupon Management</h1>
                    <div class="mb-6 p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Create New Coupon</h3>
                        <div class="mb-4">
                            <label for="new-coupon-code" class="block text-gray-300 text-sm font-bold mb-2">Coupon Code:</label>
                            <input type="text" id="new-coupon-code" placeholder="e.g., SAVE10, FREESHIP"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-4">
                            <label for="new-coupon-type" class="block text-gray-300 text-sm font-bold mb-2">Discount Type:</label>
                            <select id="new-coupon-type"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="fixed">Fixed Amount (₱)</option>
                                <option value="percentage">Percentage (%)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="new-coupon-value" class="block text-gray-300 text-sm font-bold mb-2">Discount Value:</label>
                            <input type="number" id="new-coupon-value" min="0" step="0.01" placeholder="e.g., 10.00 or 5"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-4">
                            <label for="new-coupon-valid-from" class="block text-gray-300 text-sm font-bold mb-2">Valid From:</label>
                            <input type="date" id="new-coupon-valid-from"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-6">
                            <label for="new-coupon-valid-until" class="block text-gray-300 text-sm font-bold mb-2">Valid Until:</label>
                            <input type="date" id="new-coupon-valid-until"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-6">
                            <label for="new-coupon-usage-limit" class="block text-gray-300 text-sm font-bold mb-2">Usage Limit (0 for unlimited):</label>
                            <input type="number" id="new-coupon-usage-limit" min="0" value="0"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <button id="create-new-coupon-btn"
                                class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                                       rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                       focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Create Coupon
                        </button>
                    </div>

                    <div class="p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700 flex-1 overflow-y-auto">
                        <h3 class="text-xl font-bold text-white mb-4">Existing Coupons</h3>
                        <div id="existing-coupons-list">
                            <p class="text-gray-400 text-center py-8" id="empty-coupons-message">No coupons created yet.</p>
                            <!-- Existing coupons will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- User Management Content Area -->
                <div id="user-management-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">User Management</h1>
                    <div class="mb-6 p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Add New User</h3>
                        <div class="mb-4">
                            <label for="new-user-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="new-user-email" placeholder="user@example.com"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-4">
                            <label for="new-user-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                            <input type="password" id="new-user-password" placeholder="Min 6 characters"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-6">
                            <label for="new-user-role" class="block text-gray-300 text-sm font-bold mb-2">Role:</label>
                            <select id="new-user-role"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="user">User</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <button id="add-new-user-btn"
                                class="w-full py-3 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold
                                       rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                       focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Add User
                        </button>
                    </div>

                    <!-- Existing Users Table -->
                    <div class="p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700 flex-1 overflow-y-auto">
                        <h3 class="text-xl font-bold text-white mb-4">Existing Users</h3>
                        <div id="user-list-loading" class="flex justify-center items-center h-24 hidden">
                            <div class="spinner"></div>
                            <p class="ml-3 text-gray-400">Loading Users...</p>
                        </div>
                        <div id="user-list">
                            <p class="text-gray-400 text-center py-8" id="empty-users-message">No users created yet.</p>
                            <!-- Users will be rendered here by JavaScript -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Sidebar: Cart & Totals -->
            <div id="right-sidebar">
                <h1 class="text-3xl font-bold text-white mb-6 text-center">Cart List</h1>

                <!-- Cart Items List -->
                <div id="cart-list" class="flex-1 overflow-y-auto pr-2 mb-6">
                    <!-- Cart items will be rendered here by JavaScript -->
                    <p id="empty-cart-message" class="text-gray-400 text-center py-8">Your cart is empty. Add some items!</p>
                </div>

                <!-- Totals Section -->
                <div class="border-t border-gray-700 pt-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg text-gray-300">Subtotal:</span>
                        <span id="subtotal" class="text-xl font-semibold text-white">₱0.00</span>
                    </div>
                    <!-- Tax (10%) div removed -->
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-2xl font-bold text-blue-400">Total:</span>
                        <span id="total" class="text-3xl font-extrabold text-blue-300">₱0.00</span>
                    </div>

                    <!-- Coupon application section -->
                    <div class="mb-4 p-3 bg-gray-700 rounded-lg border border-gray-600">
                        <label for="coupon-code-input" class="block text-gray-300 text-sm font-bold mb-2">Apply Coupon:</label>
                        <div class="grid grid-cols-5 gap-2">
                            <input type="text" id="coupon-code-input" placeholder="Enter code"
                                   class="col-span-3 p-2 rounded-md bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                          focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <button id="apply-coupon-btn"
                                    class="col-span-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 active:bg-blue-700 transition duration-200">
                                Apply
                            </button>
                        </div>
                        <p id="coupon-status-message" class="text-xs mt-2 text-gray-400"></p>
                        <div class="flex justify-between items-center mt-2 hidden" id="applied-discount-display-row">
                            <span class="text-md text-gray-300">Discount:</span>
                            <span id="applied-discount" class="text-lg font-semibold text-green-400">₱0.00</span>
                        </div>
                    </div>


                    <!-- Checkout Button -->
                    <button id="checkout-button"
                            class="w-full py-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Process Sale
                    </button>
                    <!-- Clear Cart Button -->
                    <button id="clear-cart-button"
                            class="w-full py-3 bg-gray-600 hover:bg-gray-700 active:bg-gray-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105 mt-2
                                   focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Clear Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box Container (for alerts/confirmations) -->
    <div id="message-box-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-96">
            <h3 id="message-box-title" class="text-xl font-bold text-white mb-4"></h3>
            <p id="message-box-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="message-box-cancel" class="px-5 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition duration-200">Cancel</button>
                <button id="message-box-ok" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">OK</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container">
        <!-- Notifications will be appended here -->
    </div>

    <!-- Low Stock Notification Modal -->
    <div id="low-stock-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                <h2 class="text-2xl font-bold text-white">Low Stock Items</h2>
                <button id="low-stock-modal-close-btn"
                        class="text-gray-400 hover:text-white text-3xl leading-none font-semibold">
                    &times;
                </button>
            </div>
            <div id="low-stock-list" class="flex-1 overflow-y-auto pr-2">
                <!-- Low stock items will be rendered here -->
                <p class="text-gray-400 text-center py-8" id="empty-low-stock-message">No items currently low on stock.</p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 w-96">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Login to Garahe ni Hulyo</h2>
            <div class="mb-4">
                <label for="login-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="login-email" placeholder="admin@example.com"
                       class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                <input type="password" id="login-password" placeholder="********"
                       class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
            </div>
            <button id="login-submit-btn"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                           rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Login
            </button>
        </div>
    </div>

    <!-- Manage Products Modal (for Add/Restock) -->
    <div id="manage-product-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-2xl h-5/6 flex flex-col">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                <h2 class="text-2xl font-bold text-white">Manage Products</h2>
                <button id="manage-product-modal-close-btn"
                        class="text-gray-400 hover:text-white text-3xl leading-none font-semibold">
                    &times;
                </button>
            </div>

            <!-- Modal Tab Navigation -->
            <div class="flex justify-center mb-6 bg-gray-700 p-2 rounded-lg shadow-inner border border-gray-600">
                <button id="modal-tab-add-product" class="modal-tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-600 hover:text-white transition duration-200 active">Add Product</button>
                <button id="modal-tab-restock-product" class="modal-tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-600 hover:text-white transition duration-200">Restock Product</button>
            </div>

            <!-- Modal Content Areas -->
            <div id="modal-add-product-content" class="modal-tab-content flex-1 flex flex-col overflow-y-auto pr-2">
                <h3 class="text-xl font-bold text-white mb-4 text-center">Add New Product</h3>
                <div class="mb-4">
                    <label for="modal-new-product-name" class="block text-gray-300 text-sm font-bold mb-2">Product Name:</label>
                    <input type="text" id="modal-new-product-name"
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="modal-new-product-category" class="block text-gray-300 text-sm font-bold mb-2">Category:</label>
                    <input type="text" id="modal-new-product-category" placeholder="e.g., Engine Parts, Accessories"
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="modal-new-product-price" class="block text-gray-300 text-sm font-bold mb-2">Price (₱):</label>
                    <input type="number" id="modal-new-product-price" step="0.01" min="0"
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="modal-new-product-stock" class="block text-gray-300 text-sm font-bold mb-2">Initial Stock:</label>
                    <input type="number" id="modal-new-product-stock" min="0"
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="modal-new-product-restock-level" class="block text-gray-300 text-sm font-bold mb-2">Restock Level:</label>
                    <input type="number" id="modal-new-product-restock-level" min="0" value="10"
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="modal-new-product-image-url" class="block text-gray-300 text-sm font-bold mb-2">Product Image URL:</label>
                    <input type="url" id="modal-new-product-image-url" placeholder="https://example.com/image.jpg"
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                    <div class="mt-4 flex justify-center">
                        <img id="modal-image-preview" class="max-w-full max-h-48 rounded-md border border-gray-700 object-contain hidden" alt="Image Preview">
                    </div>
                </div>
                <button id="modal-add-product-btn"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                               rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                               focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                    Add Product
                </button>
            </div>

            <div id="modal-restock-product-content" class="modal-tab-content hidden flex-1 flex-col overflow-y-auto pr-2">
                <h3 class="text-xl font-bold text-white mb-4 text-center">Restock Products</h3>
                <!-- Restock Search Bar -->
                <div class="mb-6">
                    <input type="text" id="modal-restock-search" placeholder="Search products to restock..."
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div id="modal-restock-list" class="flex-1 overflow-y-auto pr-2 mb-6">
                    <!-- Restock items will be rendered here by JavaScript -->
                </div>
                <button id="modal-apply-restock-btn"
                        class="w-full py-3 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold
                               rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                               focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                    Apply Restock
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Product Details Modal -->
    <div id="edit-product-details-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-lg flex flex-col">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                <h2 class="text-2xl font-bold text-white">Edit Product</h2>
                <button id="edit-product-details-modal-close-btn"
                        class="text-gray-400 hover:text-white text-3xl leading-none font-semibold">
                    &times;
                </button>
            </div>

            <div class="flex-1 flex flex-col overflow-y-auto pr-2">
                <div class="mb-4">
                    <label for="edit-product-name" class="block text-gray-300 text-sm font-bold mb-2">Product Name:</label>
                    <input type="text" id="edit-product-name"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="edit-product-category" class="block text-gray-300 text-sm font-bold mb-2">Category:</label>
                    <input type="text" id="edit-product-category"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="edit-product-price" class="block text-gray-300 text-sm font-bold mb-2">Price (₱):</label>
                    <input type="number" id="edit-product-price" step="0.01" min="0"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="edit-product-stock" class="block text-gray-300 text-sm font-bold mb-2">Current Stock:</label>
                    <input type="number" id="edit-product-stock" min="0"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="edit-product-restock-level" class="block text-gray-300 text-sm font-bold mb-2">Restock Level:</label>
                    <input type="number" id="edit-product-restock-level" min="0"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="edit-product-image-url" class="block text-gray-300 text-sm font-bold mb-2">Product Image URL:</label>
                    <input type="url" id="edit-product-image-url" placeholder="https://example.com/image.jpg"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500
                                  focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                    <div class="mt-4 flex justify-center">
                        <img id="edit-image-preview" class="max-w-full max-h-48 rounded-md border border-gray-700 object-contain hidden" alt="Image Preview">
                    </div>
                </div>
                <button id="edit-product-save-btn"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                               rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                               focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                    Save Changes
                </button>
            </div>
        </div>
    </div>


    <!-- Sale Summary Modal -->
    <div id="sale-summary-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-xl max-h-[90vh] flex flex-col overflow-y-auto">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                <h2 class="text-2xl font-bold text-white">Sale Summary</h2>
                <button id="sale-summary-modal-close-btn"
                        class="text-gray-400 hover:text-white text-3xl leading-none font-semibold">
                    &times;
                </button>
            </div>

            <!-- Customer Information -->
            <div class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h3 class="text-xl font-bold text-blue-300 mb-3">Customer Information</h3>
                <div class="mb-3">
                    <label for="customer-name" class="block text-gray-300 text-sm font-bold mb-1">Name:</label>
                    <input type="text" id="customer-name" placeholder="Customer Name"
                           class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div class="mb-3">
                    <label for="customer-address" class="block text-gray-300 text-sm font-bold mb-1">Address:</label>
                    <input type="text" id="customer-address" placeholder="Customer Address"
                           class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label for="customer-contact" class="block text-gray-300 text-sm font-bold mb-1">Contact No.:</label>
                    <input type="text" id="customer-contact" placeholder="Customer Contact Number"
                           class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>
            </div>

            <!-- Sale Items Summary -->
            <div class="flex-1 overflow-y-auto pr-2 mb-6 border border-gray-700 rounded-lg p-4 bg-gray-900">
                <h3 class="text-xl font-bold text-blue-300 mb-3">Items</h3>
                <div id="sale-summary-items-list">
                    <!-- Cart items for summary will be rendered here -->
                </div>
            </div>

            <!-- Sale Totals Summary -->
            <div class="border-t border-gray-700 pt-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg text-gray-300">Subtotal:</span>
                    <span id="summary-subtotal" class="text-xl font-semibold text-white">₱0.00</span>
                </div>
                <!-- Tax div removed from summary modal -->
                <div class="flex justify-between items-center mt-2" id="summary-discount-display-row">
                    <span class="text-lg text-gray-300">Discount:</span>
                    <span id="summary-applied-discount" class="text-xl font-semibold text-green-400">₱0.00</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-2xl font-bold text-blue-400">Total:</span>
                    <span id="summary-total" class="text-3xl font-extrabold text-blue-300">₱0.00</span>
                </div>

                <div class="flex justify-end space-x-3">
                    <button id="sale-summary-cancel-btn" class="px-5 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition duration-200">Cancel</button>
                    <button id="sale-summary-checkout-btn"
                            class="px-5 py-2 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal - This will now be a main app modal, not just a hidden template -->
    <div id="receipt-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div id="receipt-modal-content" class="bg-gray-800 text-gray-900 p-8 rounded-lg shadow-xl border border-gray-700 w-full max-w-sm flex flex-col">
            <div id="receipt-header" class="text-center mb-6">
                <h2 class="text-2xl font-extrabold text-white mb-2">Garahe ni Hulyo Receipt</h2>
                <p class="text-sm text-gray-400">Invoice ID: <span id="receipt-invoice-id"></span></p>
                <p class="text-sm text-gray-400">Date: <span id="receipt-date"></span></p>
                <p class="text-sm text-gray-400">Time: <span id="receipt-time"></span></p>
            </div>

            <div id="receipt-customer-info" class="mb-6 border-b border-gray-700 pb-4 text-gray-200">
                <h3 class="text-lg font-bold text-blue-300 mb-2">Customer Details:</h3>
                <p><strong>Name:</strong> <span id="receipt-customer-name"></span></p>
                <p><strong>Address:</strong> <span id="receipt-customer-address"></span></p>
                <p><strong>Contact:</strong> <span id="receipt-customer-contact"></span></p>
            </div>

            <div id="receipt-items-list" class="flex-1 overflow-y-auto mb-6 border-b border-gray-700 pb-4 text-gray-200">
                <h3 class="text-lg font-bold text-blue-300 mb-2">Items:</h3>
                <!-- Receipt items will be rendered here -->
            </div>

            <div id="receipt-totals" class="mb-6">
                <div class="flex justify-between text-lg mb-1 text-gray-300">
                    <span>Subtotal:</span>
                    <span id="receipt-subtotal" class="font-semibold text-white"></span>
                </div>
                <!-- Discount row on receipt -->
                <div class="flex justify-between text-lg mb-1 text-gray-300" id="receipt-discount-row">
                    <span>Discount:</span>
                    <span id="receipt-discount" class="font-semibold text-green-400"></span>
                </div>
                <!-- Tax div removed from receipt -->
                <div class="flex justify-between text-xl font-bold mt-2 text-blue-400">
                    <span>Total:</span>
                    <span id="receipt-total" class="text-white"></span>
                </div>
            </div>

            <div class="text-center text-sm text-gray-400 mb-6">
                <p>Thank you for your purchase!</p>
                <p>Garahe ni Hulyo - Your Go-To for Motorcycle Parts</p>
            </div>

            <!-- Buttons for decision - KEPT VISIBLE IN MODAL -->
            <div class="flex justify-end space-x-3">
                <button id="receipt-print-btn" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 font-bold">Print</button>
                <button id="receipt-new-sale-btn" class="px-5 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition duration-200">New Sale</button>
            </div>
             <!-- Dedicated Close button for the modal -->
             <button id="receipt-close-btn" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 font-bold self-end mt-4">Close Receipt</button>
        </div>
    </div>

    <!-- Edit User Role Modal -->
    <div id="edit-user-role-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-96">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                <h2 class="text-xl font-bold text-white">Edit User Role</h2>
                <button id="edit-user-role-modal-close-btn"
                        class="text-gray-400 hover:text-white text-3xl leading-none font-semibold">
                    &times;
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-300 mb-2">Editing user: <span id="edit-user-email-display" class="font-semibold text-white"></span></p>
            </div>
            <div class="mb-6">
                <label for="edit-user-role-select" class="block text-gray-300 text-sm font-bold mb-2">New Role:</label>
                <select id="edit-user-role-select"
                        class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                    <option value="user">User</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            <button id="save-user-role-btn"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                           rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Save Role
            </button>
        </div>
    </div>


    <script>
        // Global Firebase objects (will be populated by the module script)
        let firebaseApp, db, auth;
        let userId = 'Not Logged In'; // Default until authenticated
        let userRole = 'guest'; // Default role, 'guest' means not logged in
        let isFirebaseReady = false;

        // Data Models - These will now be synchronized with Firestore
        let inventory = []; // Fetched from Firestore
        let cart = []; // Still in-memory for current transaction
        let salesLogs = []; // Fetched from Firestore
        let coupons = [];   // New: Fetched from Firestore for coupon management
        let users = []; // New: Fetched from Firestore for user management
        let lowStockItems = []; // New: Array to hold items currently low on stock

        const TAX_RATE = 0; // Changed to 0 as per request
        let salesInvoiceCounter = 1001; // Will be determined by existing Firestore sales log IDs
        let currentReportFilter = 'daily'; // Default filter for sales report
        let appliedCoupon = null; // New: Stores the currently applied coupon object


        // --- DOM Elements (Declared with 'let' and assigned inside window.onload) ---
        let appContentWrapperEl; // New wrapper element
        let inventoryListEl, cartListEl, emptyCartMessageEl, subtotalEl, totalEl, inventorySearchEl, checkoutButtonEl, clearCartButtonEl; // Added clearCartButtonEl
        let tabInventoryBtn, tabManageProductsBtn, tabInventoryMasterBtn, tabReportLogsBtn, tabSalesReportBtn, tabUserManagementBtn, tabCouponManagementBtn; // Added coupon tab
        let inventoryContentEl, inventoryMasterContentEl, masterListEl, masterListSearchEl, masterListLoadingEl;
        let reportLogsContentEl, salesLogListEl, emptyLogsMessageEl, inventoryLoadingEl, salesLogLoadingEl, userIdDisplayEl;
        let messageBoxContainerEl, messageBoxTitleEl, messageBoxTextEl, messageBoxOkBtn, messageBoxCancelBtn;
        let notificationContainerEl; // New: Notification container
        let notificationBellEl, notificationCountBadgeEl; // New: Notification bell elements
        let lowStockModalContainerEl, lowStockModalCloseBtn, lowStockListEl, emptyLowStockMessageEl; // New: Low stock modal elements
        let manageProductModalContainer, manageProductModalCloseBtn;
        let modalTabAddProductBtn, modalTabRestockProductBtn;
        let modalAddProductContent, modalRestockProductContent;
        let modalNewProductNameEl, modalNewProductCategoryEl, modalNewProductPriceEl, modalNewProductStockEl, modalNewProductRestockLevelEl, modalNewProductImageUrlEl, modalImagePreviewEl, modalAddProductBtn; // Changed to modalNewProductImageUrlEl
        let modalRestockSearchEl, modalRestockListEl, modalApplyRestockBtn;
        let editProductDetailsModalContainer, editProductDetailsModalCloseBtn, editProductNameEl, editProductCategoryEl, editProductPriceEl, editProductStockEl, editProductRestockLevelEl, editProductImageUrlEl, editImagePreviewEl, editProductSaveBtn; // Changed to editProductImageUrlEl
        let saleSummaryModalContainer, saleSummaryModalCloseBtn, customerNameEl, customerAddressEl, customerContactEl, saleSummaryItemsListEl, summarySubtotalEl, summaryTotalEl, saleSummaryCancelBtn, saleSummaryCheckoutBtn, summaryAppliedDiscountEl; // Added summary applied discount
        let receiptModalContainer, receiptModalContentTemplate, activeReceiptPrintBtn, activeReceiptNewSaleBtn, receiptCloseBtn, receiptDiscountEl, receiptDiscountRowEl; // Added receipt discount
        let salesReportContentEl, filterDailyBtn, filterWeeklyBtn, filterMonthlyBtn, reportTotalSalesEl, reportPeriodInfoEl, reportDetailsListEl, emptyReportMessageEl, emptyItemsSummaryMessageEl, emptyDetailsListMessageEl, downloadReportPdfBtn, reportItemsSummaryEl; // Added emptyDetailsListMessageEl
        let loginLogoutButtonEl, loginModalContainerEl, loginEmailEl, loginPasswordEl, loginSubmitBtnEl, currentUserRoleEl; // New elements for login
        let userManagementContentEl, newUserEmailEl, newUserPasswordEl, newUserRoleEl, addNewUserBtnEl; // New elements for user management
        let couponCodeInputEl, applyCouponBtn, couponStatusMessageEl, appliedDiscountEl, appliedDiscountDisplayRowEl; // New coupon application elements
        let couponManagementContentEl, newCouponCodeEl, newCouponTypeEl, newCouponValueEl, newCouponValidFromEl, newCouponValidUntilEl, newCouponUsageLimitEl, createNewCouponBtn; // New coupon creation elements
        let existingCouponsListEl, emptyCouponsMessageEl; // Existing coupons display
        let emptyInventoryMessageEl; // New: Empty inventory message element
        let categoryFilterEl; // New: Category filter dropdown element

        // New DOM elements for User Management Table and Modal
        let userListEl, emptyUsersMessageEl, userListLoadingEl;
        let editUserRoleModalContainer, editUserRoleModalCloseBtn, editUserEmailDisplayEl, editUserRoleSelectEl, saveUserRoleBtn;


        // --- Helper Functions ---

        /**
         * Formats a number as a currency string (PHP).
         * @param {number} amount
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            // Use toLocaleString for comma separation and ensure 2 decimal places
            return `₱${parseFloat(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        /**
         * Formats a number with comma separators.
         * @param {number} num
         * @returns {string} Formatted number string.
         */
        function formatNumber(num) {
            return parseFloat(num).toLocaleString('en-US');
        }

        /**
         * Shows a custom message box instead of alert/confirm.
         * @param {string} title - The title of the message box.
         * @param {string} message - The message to display.
         * @param {boolean} [isConfirm=false] - If true, shows OK and Cancel buttons. Otherwise, just OK.
         * @returns {Promise<boolean>} Resolves true if OK is clicked, false if Cancel is clicked or for simple alerts.
         */
        function showMessageBox(title, message, isConfirm = false) {
            return new Promise(resolve => {
                messageBoxTitleEl.textContent = title;
                messageBoxTextEl.textContent = message;
                messageBoxContainerEl.classList.remove('hidden');

                if (isConfirm) {
                    messageBoxCancelBtn.classList.remove('hidden');
                    messageBoxOkBtn.textContent = 'Confirm';
                } else {
                    messageBoxCancelBtn.classList.add('hidden');
                    messageBoxOkBtn.textContent = 'OK';
                }

                const handleOk = () => {
                    messageBoxContainerEl.classList.add('hidden');
                    messageBoxOkBtn.removeEventListener('click', handleOk);
                    messageBoxCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    messageBoxContainerEl.classList.add('hidden');
                    messageBoxOkBtn.removeEventListener('click', handleOk);
                    messageBoxCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                messageBoxOkBtn.addEventListener('click', handleOk);
                messageBoxCancelBtn.addEventListener('click', handleCancel);
            });
        }

        /**
         * Displays a non-blocking notification toast.
         * @param {string} message - The message to display.
         * @param {string} type - 'info', 'success', 'error', 'new-sale'
         * @param {number} [duration=3000] - Duration in milliseconds before auto-dismissing. 0 for permanent.
         * Default changed to 3000ms for faster disappearance.
         */
        function showNotification(message, type = 'info', duration = 3000) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification-item ${type}`;
            notificationDiv.innerHTML = `
                <span>${message}</span>
                <button class="close-btn">&times;</button>
            `;
            notificationContainerEl.prepend(notificationDiv); // Add to top

            // Animate in
            setTimeout(() => {
                notificationDiv.classList.add('show');
            }, 10); // Small delay for CSS transition to work

            const dismiss = () => {
                notificationDiv.classList.remove('show');
                notificationDiv.addEventListener('transitionend', () => notificationDiv.remove());
            };

            notificationDiv.querySelector('.close-btn').addEventListener('click', dismiss);

            if (duration > 0) {
                setTimeout(dismiss, duration);
            }
        }


        // --- Render Functions ---

        /**
         * Renders the inventory list in the left panel.
         * @param {Array<Object>} items - The list of inventory items to display.
         */
        function renderInventory(items = inventory) {
            inventoryListEl.innerHTML = ''; // Clear existing items

            const currentSearchTerm = inventorySearchEl.value.toLowerCase().trim();
            const selectedCategory = categoryFilterEl.value;

            // Filter items based on search term and selected category
            const filteredAndCategorizedItems = items.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(currentSearchTerm) ||
                                      (item.category && item.category.toLowerCase().includes(currentSearchTerm));
                const matchesCategory = selectedCategory === 'all' || (item.category && item.category.toLowerCase() === selectedCategory.toLowerCase());
                return matchesSearch && matchesCategory;
            });


            if (filteredAndCategorizedItems.length === 0) {
                emptyInventoryMessageEl.classList.remove('hidden'); // Show empty message
                return;
            } else {
                emptyInventoryMessageEl.classList.add('hidden'); // Hide empty message
            }

            // Sort items alphabetically by name
            const sortedItems = [...filteredAndCategorizedItems].sort((a, b) => a.name.localeCompare(b.name));

            sortedItems.forEach(item => {
                // Calculate effective stock considering items already in cart for ADD button logic
                const itemInCart = cart.find(cartItem => cartItem.id === item.id);
                const quantityInCart = itemInCart ? itemInCart.quantity : 0;
                const availableForAdding = item.stock - quantityInCart; // This is for the button's disabled state

                const itemDiv = document.createElement('div');
                itemDiv.className = `
                    bg-gray-800 rounded-lg p-3 mb-2 shadow-md border border-gray-700
                    flex items-center justify-between transition-all duration-200
                    hover:scale-[1.01] hover:bg-gray-700
                `;
                itemDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${item.imageUrl || 'https://placehold.co/48x48/555555/EEEEEE?text=Img'}"
                             onerror="this.onerror=null;this.src='https://placehold.co/48x48/555555/EEEEEE?text=Img';"
                             alt="${item.name}" class="w-12 h-12 rounded-full object-cover border border-gray-600">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-300">${item.name}</h3>
                            <p class="text-sm text-gray-400">Category: <span class="font-medium text-gray-200">${item.category || 'N/A'}</span></p>
                            <p class="text-sm text-gray-400">Stock: <span class="font-medium text-gray-200">${formatNumber(item.stock)}</span></p> <!-- Display actual stock -->
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-white">${formatCurrency(item.price)}</span>
                        <button data-item-id="${item.id}"
                                class="add-to-cart-btn px-3 py-1 bg-blue-600 text-white rounded-lg
                                       hover:bg-blue-700 active:bg-blue-800 transition duration-200
                                       shadow-md text-sm ${availableForAdding <= 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${availableForAdding <= 0 ? 'disabled' : ''}>
                            Add
                        </button>
                    </div>
                `;
                inventoryListEl.appendChild(itemDiv);
            });

            // Add event listeners for "Add to Cart" buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const itemId = event.target.dataset.itemId;
                    await addItemToCart(itemId);
                });
            });
        }

        /**
         * Populates the category filter dropdown with unique categories from the inventory.
         */
        function populateCategoryFilter() {
            const categories = new Set();
            inventory.forEach(item => {
                if (item.category && item.category.trim() !== '') {
                    categories.add(item.category.trim());
                }
            });

            // Clear existing options, but keep the "All Categories" option if it exists
            const currentSelectedValue = categoryFilterEl.value;
            categoryFilterEl.innerHTML = '<option value="all">All Categories</option>'; // Always reset with 'All'

            const sortedCategories = Array.from(categories).sort((a, b) => a.localeCompare(b));
            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilterEl.appendChild(option);
            });

            // Restore previous selection if it's still a valid category
            if (currentSelectedValue && (currentSelectedValue === 'all' || categories.has(currentSelectedValue))) {
                categoryFilterEl.value = currentSelectedValue;
            } else {
                categoryFilterEl.value = 'all'; // Default to all if previous is invalid
            }
        }


        /**
         * Renders the cart list and updates totals in the right panel.
         */
        function renderCart() {
            cartListEl.innerHTML = ''; // Clear existing cart items

            if (cart.length === 0) {
                emptyCartMessageEl.classList.remove('hidden');
                checkoutButtonEl.disabled = true;
                checkoutButtonEl.classList.add('opacity-50', 'cursor-not-allowed');
                clearCartButtonEl.disabled = true; // Disable clear cart button
                clearCartButtonEl.classList.add('opacity-50', 'cursor-not-allowed');
                appliedCoupon = null; // Clear applied coupon if cart is empty
                couponCodeInputEl.value = '';
                couponStatusMessageEl.textContent = '';
                appliedDiscountDisplayRowEl.classList.add('hidden'); // Hide discount row
                calculateTotals(); // Ensure totals are zeroed out
                renderInventory(getFilteredInventory()); // Re-render inventory to update available stock display
                return;
            } else {
                emptyCartMessageEl.classList.add('hidden'); // Hide empty message if items exist
                checkoutButtonEl.disabled = false;
                checkoutButtonEl.classList.remove('opacity-50', 'cursor-not-allowed');
                clearCartButtonEl.disabled = false; // Enable clear cart button
                clearCartButtonEl.classList.remove('opacity-50', 'cursor-not-allowed');
                // Show discount row only if a coupon is applied
                if (appliedCoupon) {
                    appliedDiscountDisplayRowEl.classList.remove('hidden');
                } else {
                    appliedDiscountDisplayRowEl.classList.add('hidden');
                }
            }


            cart.forEach(item => {
                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = `
                    bg-gray-900 rounded-lg p-1.5 mb-2 shadow-sm border border-gray-700
                    flex items-center justify-between transition-all duration-200
                    hover:scale-[1.01] hover:bg-gray-900/90
                `;
                cartItemDiv.innerHTML = `
                    <div class="flex items-center space-x-1 flex-grow min-w-0">
                        <img src="${item.imageUrl || 'https://placehold.co/40x40/444444/DDDDDD?text=Img'}"
                             onerror="this.onerror=null;this.src='https://placehold.co/40x40/444444/DDDDDD?text=Img';"
                             alt="${item.name}" class="w-10 h-10 rounded-full object-cover border border-gray-600 flex-shrink-0">
                        <div class="min-w-0">
                            <h3 class="text-sm font-semibold text-blue-300 truncate">${item.name}</h3>
                            <p class="text-xs text-gray-400">Price: ${formatCurrency(item.price)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-0.5 flex-shrink-0">
                        <input type="number" data-item-id="${item.id}" value="${item.quantity}" min="1"
                               class="cart-quantity-input w-12 p-0.5 rounded-md bg-gray-700 border border-gray-600
                                      text-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500 text-center text-xs">
                        <span class="text-sm font-bold text-white w-16 text-right flex-shrink-0">${formatCurrency(item.price * item.quantity)}</span>
                        <button data-item-id="${item.id}"
                                class="remove-from-cart-btn w-6 h-6 flex items-center justify-center bg-red-600 text-white rounded-md
                                       hover:bg-red-700 active:bg-red-800 transition duration-200 shadow-md text-xs">X</button>
                    </div>
                `;
                cartListEl.appendChild(cartItemDiv);
            });

            // Add event listeners for quantity input and remove buttons
            document.querySelectorAll('.cart-quantity-input').forEach(input => {
                input.addEventListener('change', async (event) => { // Use 'change' event for when input loses focus or Enter is pressed
                    const itemId = event.target.dataset.itemId;
                    const newQuantity = parseInt(event.target.value);
                    await setCartQuantity(itemId, newQuantity);
                });
            });

            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const itemId = event.target.dataset.itemId;
                    await removeItemFromCart(itemId);
                });
            });

            calculateTotals();
            renderInventory(getFilteredInventory()); // Re-render inventory to reflect changes in available stock
        }

        /**
         * Clears all items from the cart.
         */
        async function clearCart() {
            if (!isFirebaseReady || !auth.currentUser) {
                showMessageBox('Login Required', 'Please log in to clear the cart.');
                return;
            }

            if (cart.length === 0) {
                showMessageBox('Cart Empty', 'Your cart is already empty.');
                return;
            }

            const confirmed = await showMessageBox(
                'Confirm Clear Cart',
                'Are you sure you want to clear all items from the cart?',
                true
            );

            if (confirmed) {
                cart = []; // Clear the cart array
                appliedCoupon = null; // Clear any applied coupon
                couponCodeInputEl.value = ''; // Clear coupon input field
                couponStatusMessageEl.textContent = ''; // Clear coupon status message
                renderCart(); // Re-render the cart UI
                showNotification('Cart Cleared', 'info', 2000); // Faster disappearance
            }
        }


        /**
         * Renders the inventory master list for editing and deletion.
         * @param {Array<Object>} items - The list of inventory items to display.
         */
        function renderMasterList(items = inventory) {
            masterListEl.innerHTML = ''; // Clear existing items

            const searchTerm = masterListSearchEl.value.toLowerCase().trim();
            const filteredItems = items.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                (item.category && item.category.toLowerCase().includes(searchTerm))
            );

            if (filteredItems.length === 0) {
                masterListEl.innerHTML = `
                    <p class="text-gray-400 text-center py-8">No inventory items found matching your search.</p>
                `;
                return;
            }

            // Sort items alphabetically by name
            const sortedItems = [...filteredItems].sort((a, b) => a.name.localeCompare(b.name));

            sortedItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `
                    bg-gray-800 rounded-lg p-3 mb-2 shadow-md border border-gray-700
                    flex items-center justify-between transition-all duration-200
                    hover:scale-[1.01] hover:bg-gray-700
                `;
                itemDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${item.imageUrl || 'https://placehold.co/48x48/555555/EEEEEE?text=Img'}"
                             onerror="this.onerror=null;this.src='https://placehold.co/48x48/555555/EEEEEE?text=Img';"
                             alt="${item.name}" class="w-12 h-12 rounded-full object-cover border border-gray-600">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-300">${item.name}</h3>
                            <p class="text-sm text-gray-400">Category: <span class="font-medium text-gray-200">${item.category || 'N/A'}</span></p>
                            <p class="text-sm text-gray-400">Stock: <span class="font-medium text-gray-200">${formatNumber(item.stock)}</span> | Restock: <span class="font-medium text-gray-200">${formatNumber(item.restockLevel || 0)}</span></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-bold text-white">${formatCurrency(item.price)}</span>
                        <button data-item-id="${item.id}"
                                class="edit-item-btn px-3 py-1 bg-yellow-600 text-white rounded-lg
                                       hover:bg-yellow-700 active:bg-yellow-800 transition duration-200
                                       shadow-md text-sm">
                            Edit
                        </button>
                        <button data-item-id="${item.id}"
                                class="delete-item-btn px-3 py-1 bg-red-600 text-white rounded-lg
                                       hover:bg-red-700 active:bg-red-800 transition duration-200
                                       shadow-md text-sm">
                            Delete
                        </button>
                    </div>
                `;
                masterListEl.appendChild(itemDiv);
            });

            // Add event listeners for "Edit" and "Delete" buttons
            document.querySelectorAll('.edit-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = event.target.dataset.itemId;
                    openEditProductDetailsModal(itemId);
                });
            });

            document.querySelectorAll('.delete-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = event.target.dataset.itemId;
                    deleteProduct(itemId);
                });
            });
        }


        /**
         * Renders the restock list in the "Restock Product" tab within the modal.
         * @param {Array<Object>} items - The list of inventory items to display for restock.
         */
        function renderModalRestockList(items = inventory) {
            modalRestockListEl.innerHTML = ''; // Clear existing items

            const searchTerm = modalRestockSearchEl.value.toLowerCase().trim();
            const filteredItems = items.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                (item.category && item.category.toLowerCase().includes(searchTerm))
            );

            if (filteredItems.length === 0) {
                modalRestockListEl.innerHTML = `
                    <p class="text-gray-400 text-center py-8">No products found matching your search for restock.</p>
                `;
                return;
            }

            // Sort items alphabetically by name
            const sortedItems = [...filteredItems].sort((a, b) => a.name.localeCompare(b.name));

            sortedItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `
                    bg-gray-900 rounded-lg p-4 mb-3 shadow-sm border border-gray-700
                    flex flex-col sm:flex-row justify-between items-center transition-all duration-200
                    hover:scale-[1.01] hover:bg-gray-900/90
                `;
                itemDiv.innerHTML = `
                    <div class="flex items-center gap-4 text-left mb-3 sm:mb-0 flex-1">
                        <img src="${item.imageUrl || 'https://placehold.co/60x60/444444/DDDDDD?text=No+Img'}"
                             onerror="this.onerror=null;this.src='https://placehold.co/60x60/444444/DDDDDD?text=No+Img';"
                             alt="${item.name}" class="w-16 h-16 rounded-md object-cover border border-gray-600">
                        <div>
                            <h3 class="text-xl font-semibold text-blue-300">${item.name}</h3>
                            <p class="text-gray-400">Category: <span class="font-medium text-gray-200">${item.category || 'N/A'}</span></p>
                            <p class="text-400">Current Stock: <span class="font-medium text-gray-200">${formatNumber(item.stock)}</span></p>
                            <p class="text-gray-500 text-sm">Restock Level: <span class="font-medium text-gray-400">${formatNumber(item.restockLevel || 0)}</span></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 w-32 sm:w-48">
                        <label for="modal-restock-qty-${item.id}" class="sr-only">Quantity for ${item.name}</label>
                        <input type="number" id="modal-restock-qty-${item.id}" data-item-id="${item.id}" min="0" value="0"
                               class="restock-quantity-input w-full p-2 rounded-md bg-gray-700 border border-gray-600
                                      text-gray-200 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                `;
                modalRestockListEl.appendChild(itemDiv);
            });
        }

        /**
         * Renders the items list within the Sale Summary modal.
         */
        function renderSaleSummaryItems() {
            saleSummaryItemsListEl.innerHTML = '';
            if (cart.length === 0) {
                saleSummaryItemsListEl.innerHTML = '<p class="text-gray-400 text-center py-4">No items in cart.</p>';
                return;
            }
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `
                    flex justify-between items-center py-2 border-b border-gray-800 last:border-b-0
                `;
                itemDiv.innerHTML = `
                    <span class="text-gray-200">${item.name} (x${formatNumber(item.quantity)})</span>
                    <span class="text-white font-semibold">${formatCurrency(item.price * item.quantity)}</span>
                `;
                saleSummaryItemsListEl.appendChild(itemDiv);
            });
        }

        /**
         * Renders the sales log list in the Report Logs section.
         */
        function renderReportLogs() {
            salesLogListEl.innerHTML = ''; // Clear existing logs

            if (salesLogs.length === 0) {
                emptyLogsMessageEl.classList.remove('hidden');
                return;
            } else {
                emptyLogsMessageEl.classList.add('hidden');
            }

            // Sort logs by timestamp, newest first
            const sortedLogs = [...salesLogs].sort((a, b) => {
                const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB - dateA;
            });

            sortedLogs.forEach(log => {
                const logDate = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleDateString();
                const logTime = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleTimeString();
                const isVoided = log.isVoided ? true : false; // Ensure boolean
                const voidedBadge = isVoided ? '<span class="ml-2 px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full">VOIDED</span>' : '';
                const voidButtonHtml = (userRole === 'admin' && !isVoided) ?
                    `<button data-invoice-id="${log.salesInvoiceId}"
                            class="void-sale-btn px-3 py-1 bg-red-600 text-white rounded-lg
                                   hover:bg-red-700 active:bg-red-800 transition duration-200
                                   shadow-md text-sm mt-2 sm:mt-0">
                        Void Sale
                    </button>` : '';

                const logItemDiv = document.createElement('div');
                logItemDiv.className = `
                    bg-gray-800 rounded-lg p-4 mb-4 shadow-md border border-gray-700
                    flex flex-col sm:flex-row justify-between items-center transition-all duration-200
                    hover:scale-[1.01] hover:bg-gray-700 ${isVoided ? 'opacity-70 border-red-500' : ''}
                `;
                logItemDiv.innerHTML = `
                    <div class="flex-1 text-left mb-2 sm:mb-0">
                        <p class="text-gray-300 text-sm">Invoice ID:
                            <span class="sales-invoice-id font-bold text-blue-400 cursor-pointer hover:underline"
                                  data-invoice-id="${log.salesInvoiceId}">${log.salesInvoiceId}</span>
                            ${voidedBadge}
                        </p>
                        <p class="text-gray-400 text-sm">Date: ${logDate} | Time: ${logTime}</p>
                        <p class="text-gray-200 font-semibold">Customer: ${log.customer.name}</p>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <p class="text-2xl font-bold text-white">${formatCurrency(log.total)}</p>
                        ${log.couponApplied ? `<p class="text-sm text-green-400">(Discount: ${formatCurrency(log.discountAmount)})</p>` : ''}
                        ${voidButtonHtml}
                    </div>
                `;
                salesLogListEl.appendChild(logItemDiv);
            });

            // Add event listeners to the clickable invoice IDs
            document.querySelectorAll('.sales-invoice-id').forEach(span => {
                span.addEventListener('click', (event) => {
                    const invoiceId = event.target.dataset.invoiceId;
                    const selectedLog = salesLogs.find(log => log.salesInvoiceId === invoiceId);
                    if (selectedLog) {
                        displayReceiptModal(selectedLog); // Display the receipt in the main app modal
                    } else {
                        showMessageBox('Error', 'Sales record not found.');
                    }
                });
            });

            // Add event listeners for Void Sale buttons
            document.querySelectorAll('.void-sale-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const invoiceId = event.target.dataset.invoiceId;
                    await voidSale(invoiceId);
                });
            });
        }


        /**
         * Renders the receipt details into the displayed modal.
         * @param {Object} saleData - The sale data to render (can be currentSale or a historical salesLog).
         */
        function renderReceiptContent(saleData) {
            console.log("Rendering receipt content with saleData:", saleData);

            // Populate the receipt modal content template (receiptModalContentTemplate is the div itself)
            const saleDateTime = saleData.timestamp.toDate ? saleData.timestamp.toDate() : new Date(saleData.timestamp);
            receiptModalContentTemplate.querySelector('#receipt-invoice-id').textContent = saleData.salesInvoiceId || 'N/A';
            receiptModalContentTemplate.querySelector('#receipt-date').textContent = saleDateTime.toLocaleDateString();
            receiptModalContentTemplate.querySelector('#receipt-time').textContent = saleDateTime.toLocaleTimeString();

            receiptModalContentTemplate.querySelector('#receipt-customer-name').textContent = saleData.customer.name || 'N/A';
            receiptModalContentTemplate.querySelector('#receipt-customer-address').textContent = saleData.customer.address || 'N/A';
            receiptModalContentTemplate.querySelector('#receipt-customer-contact').textContent = saleData.customer.contact || 'N/A';

            const receiptItemsListEl = receiptModalContentTemplate.querySelector('#receipt-items-list');
            receiptItemsListEl.innerHTML = '<h3 class="text-lg font-bold text-blue-300 mb-2">Items:</h3>'; // Clear and add heading
            saleData.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `
                    flex justify-between items-center py-2 border-b border-gray-800 last:border-b-0
                `;
                itemDiv.innerHTML = `
                    <span class="text-gray-200">${item.name} x ${formatNumber(item.quantity)}</span>
                    <span class="font-semibold text-white">${formatCurrency(item.price * item.quantity)}</span>
                `;
                receiptItemsListEl.appendChild(itemDiv);
            });

            receiptModalContentTemplate.querySelector('#receipt-subtotal').textContent = formatCurrency(saleData.subtotal);

            // Render discount row on receipt - ALWAYS show the row, even if discount is zero
            receiptDiscountRowEl.classList.remove('hidden'); // Ensure the row is visible

            // Check for saleData.discountAmount directly, which should be correct
            const discountValue = saleData.discountAmount !== undefined ? saleData.discountAmount : 0;
            receiptDiscountEl.textContent = formatCurrency(discountValue);

            console.log("Receipt discount amount set to:", formatCurrency(discountValue));


            receiptModalContentTemplate.querySelector('#receipt-total').textContent = formatCurrency(saleData.total);
        }


        /**
         * Calculates subtotal, tax, and total based on cart items and updates the display.
         */
        function calculateTotals() {
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            const tax = subtotal * TAX_RATE; // TAX_RATE is now 0
            let total = subtotal + tax;
            let discountAmount = 0;

            if (appliedCoupon) {
                if (appliedCoupon.type === 'percentage') {
                    discountAmount = total * (appliedCoupon.value / 100);
                } else if (appliedCoupon.type === 'fixed') {
                    discountAmount = appliedCoupon.value;
                }
                // Ensure discount doesn't make total negative
                total = Math.max(0, total - discountAmount);
            }

            subtotalEl.textContent = formatCurrency(subtotal);
            totalEl.textContent = formatCurrency(total);
            appliedDiscountEl.textContent = formatCurrency(discountAmount); // Update discount display in cart

            // Also update summary modal totals
            summarySubtotalEl.textContent = formatCurrency(subtotal);
            summaryAppliedDiscountEl.textContent = formatCurrency(discountAmount); // Update discount display in summary
            summaryTotalEl.textContent = formatCurrency(total);
        }

        // --- Cart Management Logic ---

        /**
         * Adds an item to the cart or increments its quantity if already present.
         * Stock deduction is now only on finalizeSale.
         * @param {string} itemId - The ID of the item to add.
         */
        async function addItemToCart(itemId) {
            if (!isFirebaseReady || !auth.currentUser) {
                showMessageBox('Login Required', 'Please log in to add items to the cart.');
                return;
            }
            try {
                // Get the current true stock from the global inventory
                const inventoryItem = inventory.find(item => item.id === itemId);

                if (!inventoryItem) {
                    showMessageBox('Error', 'Item not found in inventory.');
                    return;
                }

                const cartItem = cart.find(item => item.id === itemId);
                let currentQuantityInCart = cartItem ? cartItem.quantity : 0;
                let availableStockForAdding = inventoryItem.stock - currentQuantityInCart;

                if (availableStockForAdding <= 0) {
                    showNotification('Out of Stock: ' + inventoryItem.name, 'error', 4000);
                    return;
                }

                if (cartItem) {
                    // If item is already in cart, increment quantity
                    cartItem.quantity++;
                } else {
                    // Add category to cart item
                    cart.push({
                        id: inventoryItem.id,
                        name: inventoryItem.name,
                        price: inventoryItem.price,
                        quantity: 1,
                        imageUrl: inventoryItem.imageUrl,
                        category: inventoryItem.category // Include category
                    });
                }
                renderCart(); // Re-render cart. Inventory UI will update based on its listener.
                showNotification(`Added ${inventoryItem.name} to cart.`, 'success', 2000);
            } catch (error) {
                console.error("Error adding item to cart:", error);
                showMessageBox('Error', 'Failed to add item to cart. Please try again.');
            }
        }

        /**
         * Sets the quantity of an item in the cart.
         * @param {string} itemId - The ID of the item.
         * @param {number} newQuantity - The desired new quantity for the item.
         */
        async function setCartQuantity(itemId, newQuantity) {
            if (!isFirebaseReady || !auth.currentUser) {
                showMessageBox('Login Required', 'Please log in to modify cart items.');
                return;
            }

            try {
                const cartItem = cart.find(item => item.id === itemId);
                if (!cartItem) return;

                const inventoryItem = inventory.find(item => item.id === itemId);
                if (!inventoryItem) {
                    showMessageBox('Error', 'Item not found in inventory for quantity update.');
                    renderCart();
                    return;
                }

                let quantityToSet = parseInt(newQuantity);
                if (isNaN(quantityToSet) || quantityToSet < 0) {
                    quantityToSet = 0;
                }

                // Calculate the max allowed quantity based on actual inventory stock
                const maxAllowed = inventoryItem.stock;
                if (quantityToSet > maxAllowed) {
                    quantityToSet = maxAllowed;
                    showNotification(`Only ${formatNumber(maxAllowed)} of ${inventoryItem.name} available.`, 'error', 4000);
                }

                if (quantityToSet === 0) {
                    cart.splice(cart.findIndex(item => item.id === itemId), 1);
                    showNotification(`Removed ${inventoryItem.name} from cart.`, 'info', 2000);
                } else {
                    cartItem.quantity = quantityToSet;
                    showNotification(`Updated ${inventoryItem.name} quantity to ${formatNumber(quantityToSet)}.`, 'info', 2000);
                }

                renderCart();
            } catch (error) {
                console.error("Error setting cart quantity:", error);
                showMessageBox('Error', 'Failed to update item quantity. Please try again.');
                renderCart();
            }
        }

        /**
         * Removes an item completely from the cart.
         * @param {string} itemId - The ID of the item to remove.
         */
        async function removeItemFromCart(itemId) {
            if (!isFirebaseReady || !auth.currentUser) {
                showMessageBox('Login Required', 'Please log in to remove items from the cart.');
                return;
            }
            try {
                const itemIndex = cart.findIndex(item => item.id === itemId);
                if (itemIndex > -1) {
                    const removedItemName = cart[itemIndex].name;
                    cart.splice(itemIndex, 1); // Remove item from local cart array
                    showNotification(`Removed ${removedItemName} from cart.`, 'info', 2000);
                }
                renderCart();
            }
            catch (error) {
                console.error("Error removing item from cart:", error);
                showMessageBox('Error', 'Failed to remove item from cart. Please try again.');
            }
        }

        /**
         * Initiates the checkout process by opening the sale summary modal.
         */
        async function initiateCheckout() {
            if (!auth.currentUser) {
                showMessageBox('Login Required', 'Please log in to process a sale.');
                return;
            }
            if (cart.length === 0) {
                showMessageBox('Cart Empty', 'Please add items to the cart before checking out.');
                return;
            }

            openSaleSummaryModal();
        }

        /**
         * Filters the inventory based on the search input and selected category.
         * @returns {Array<Object>} Filtered inventory items.
         */
        function getFilteredInventory() {
            const searchTerm = inventorySearchEl.value.toLowerCase().trim();
            const selectedCategory = categoryFilterEl.value;

            return inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                      (item.category && item.category.toLowerCase().includes(searchTerm));
                const matchesCategory = selectedCategory === 'all' || (item.category && item.category.toLowerCase() === selectedCategory.toLowerCase());
                return matchesSearch && matchesCategory;
            });
        }


        /**
         * Filters the master list based on the search input.
         * @returns {Array<Object>} Filtered master list items.
         */
        function getFilteredMasterList() {
            const searchTerm = masterListSearchEl.value.toLowerCase().trim();
            if (!searchTerm) {
                return inventory;
            }
            return inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                (item.category && item.category.toLowerCase().includes(searchTerm))
            );
        }

        // --- Management Functions (used within modal) ---

        /**
         * Normalizes a category string to ensure correct spelling for common terms like "Accessories".
         * @param {string} category The category string to normalize.
         * @returns {string} The normalized category string.
         */
        function normalizeCategory(category) {
            const lowerCaseCategory = category.toLowerCase();
            if (lowerCaseCategory === 'accesories' || lowerCaseCategory === 'acessories') {
                return 'Accessories';
            }
            // You can add more normalization rules here if needed
            return category;
        }

        /**
         * Handles adding a new product to the inventory in Firestore.
         */
        async function addNewProduct() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to add products.');
                return;
            }
            const name = modalNewProductNameEl.value.trim();
            const category = normalizeCategory(modalNewProductCategoryEl.value.trim()); // Normalize category
            const price = parseFloat(modalNewProductPriceEl.value);
            const stock = parseInt(modalNewProductStockEl.value);
            const restockLevel = parseInt(modalNewProductRestockLevelEl.value);
            const imageUrl = modalNewProductImageUrlEl.value.trim(); // Get URL from input

            if (!name) {
                showMessageBox('Input Error', 'Product Name cannot be empty.');
                return;
            }
            if (!category) {
                showMessageBox('Input Error', 'Category cannot be empty.');
                return;
            }
            if (isNaN(price) || price <= 0) {
                showMessageBox('Input Error', 'Please enter a valid price greater than 0.');
                return;
            }
            if (isNaN(stock) || stock < 0) {
                showMessageBox('Input Error', 'Please enter a valid initial stock (0 or greater).');
                return;
            }
            if (isNaN(restockLevel) || restockLevel < 0) {
                showMessageBox('Input Error', 'Please enter a valid restock level (0 or greater).');
                return;
            }
            if (imageUrl && !/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg)$/i.test(imageUrl)) {
                 showMessageBox('Input Error', 'Please enter a valid image URL (must start with http/https and end with a common image extension).');
                 return;
            }

            const newProductData = {
                name: name,
                category: category, // Save normalized category
                price: price,
                stock: stock,
                restockLevel: restockLevel,
                imageUrl: imageUrl // Use the URL directly
            };

            try {
                // Add the new product to Firestore, let Firestore generate the ID
                const docRef = await firebase.addDoc(firebase.collection(db, `artifacts/${currentAppId}/public/data/inventory`), newProductData);

                // Clear form
                modalNewProductNameEl.value = '';
                modalNewProductCategoryEl.value = ''; // Clear category
                modalNewProductPriceEl.value = '';
                modalNewProductStockEl.value = '';
                modalNewProductRestockLevelEl.value = '10'; // Reset to default
                modalNewProductImageUrlEl.value = ''; // Clear URL input
                modalImagePreviewEl.src = ''; // Clear preview
                modalImagePreviewEl.classList.add('hidden'); // Hide preview

                showNotification('Product Added', 'success', 2000); // Faster disappearance
                closeManageProductModal();
            } catch (error) {
                console.error("Error adding new product to Firestore:", error);
                showMessageBox('Error', 'Failed to add new product. Please try again.');
            }
        }

        /**
         * Handles applying restock quantities to multiple products in Firestore.
         */
        async function applyRestock() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to restock products.');
                return;
            }
            const restockInputs = document.querySelectorAll('#modal-restock-list .restock-quantity-input');
            let restockedCount = 0;
            let totalRestockedUnits = 0;
            const updates = [];

            restockInputs.forEach(input => {
                const itemId = input.dataset.itemId;
                const quantity = parseInt(input.value);
                const inventoryItem = inventory.find(item => item.id === itemId);

                if (inventoryItem && !isNaN(quantity) && quantity > 0) {
                    // Use currentAppId for the Firestore path
                    const itemDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/inventory`, itemId);
                    updates.push(firebase.updateDoc(itemDocRef, { stock: inventoryItem.stock + quantity }));
                    restockedCount++;
                    totalRestockedUnits += quantity;
                    input.value = '0'; // Reset input field
                }
            });

            if (restockedCount > 0) {
                try {
                    await Promise.all(updates); // Execute all updates concurrently
                    showNotification(`Successfully restocked ${restockedCount} product(s) with a total of ${formatNumber(totalRestockedUnits)} units.`, 'success', 3000); // Faster disappearance
                    closeManageProductModal();
                } catch (error) {
                    console.error("Error applying restock:", error);
                    showMessageBox('Error', 'Failed to apply restock. Please try again.');
                }
            } else {
                showMessageBox('No Restock Applied', 'Please enter a valid positive quantity for at least one item to restock.');
            }
        }

        /**
         * Opens the modal to edit a specific product's details.
         * @param {string} itemId - The ID of the product to edit.
         */
        function openEditProductDetailsModal(itemId) {
            if (userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to edit products.');
                return;
            }
            const itemToEdit = inventory.find(item => item.id === itemId);

            if (!itemToEdit) {
                showMessageBox('Error', 'Product not found for editing.');
                return;
            }

            // Populate form fields
            editProductNameEl.value = itemToEdit.name;
            editProductCategoryEl.value = itemToEdit.category || ''; // Populate category
            editProductPriceEl.value = itemToEdit.price;
            editProductStockEl.value = itemToEdit.stock;
            editProductRestockLevelEl.value = itemToEdit.restockLevel || '';
            editProductImageUrlEl.value = itemToEdit.imageUrl || ''; // Populate URL input

            // Display current image or a placeholder
            if (itemToEdit.imageUrl) {
                editImagePreviewEl.src = itemToEdit.imageUrl;
                editImagePreviewEl.classList.remove('hidden');
            } else {
                editImagePreviewEl.src = '';
                editImagePreviewEl.classList.add('hidden');
            }

            // Store the ID of the item being edited on the save button
            editProductSaveBtn.dataset.editingItemId = itemId;

            // Show the modal
            editProductDetailsModalContainer.classList.remove('hidden');
        }

        /**
         * Closes the edit product details modal.
         */
        function closeEditProductDetailsModal() {
            editProductDetailsModalContainer.classList.add('hidden');
            // Clear fields and data attribute
            editProductNameEl.value = '';
            editProductCategoryEl.value = ''; // Clear category
            editProductPriceEl.value = '';
            editProductStockEl.value = '';
            editProductRestockLevelEl.value = '';
            editProductImageUrlEl.value = ''; // Clear URL input
            editImagePreviewEl.src = '';
            editImagePreviewEl.classList.add('hidden');
            delete editProductSaveBtn.dataset.editingItemId; // Remove the stored ID
        }

        /**
         * Saves the edited product details to Firestore.
         */
        async function saveEditedProduct() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to save product changes.');
                return;
            }

            const itemId = editProductSaveBtn.dataset.editingItemId;
            if (!itemId) {
                showMessageBox('Error', 'No product selected for editing.');
                return;
            }

            const name = editProductNameEl.value.trim();
            const category = normalizeCategory(editProductCategoryEl.value.trim()); // Normalize category
            const price = parseFloat(editProductPriceEl.value);
            const stock = parseInt(editProductStockEl.value);
            const restockLevel = parseInt(editProductRestockLevelEl.value);
            const imageUrl = editProductImageUrlEl.value.trim(); // Get URL from input

            if (!name) {
                showMessageBox('Input Error', 'Product Name cannot be empty.');
                return;
            }
            if (!category) {
                showMessageBox('Input Error', 'Category cannot be empty.');
                return;
            }
            if (isNaN(price) || price <= 0) {
                showMessageBox('Input Error', 'Please enter a valid price greater than 0.');
                return;
            }
            if (isNaN(stock) || stock < 0) {
                showMessageBox('Input Error', 'Please enter a valid current stock (0 or greater).');
                return;
            }
            if (isNaN(restockLevel) || restockLevel < 0) {
                showMessageBox('Input Error', 'Please enter a valid restock level (0 or greater).');
                return;
            }
            if (imageUrl && !/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp|svg)$/i.test(imageUrl)) {
                 showMessageBox('Input Error', 'Please enter a valid image URL (must start with http/https and end with a common image extension).');
                 return;
            }


            const updatedProductData = {
                name: name,
                category: category, // Save normalized category
                price: price,
                stock: stock,
                restockLevel: restockLevel,
                imageUrl: imageUrl // Use the URL directly
            };

            try {
                // Use currentAppId for the Firestore path
                const docRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/inventory`, itemId);
                await firebase.updateDoc(docRef, updatedProductData);

                showNotification(`${name} updated successfully.`, 'success', 2000); // Faster disappearance
                closeEditProductDetailsModal();
            } catch (error) {
                console.error("Error updating product:", error);
                showMessageBox('Error', 'Failed to update product. Please try again.');
            }
        }

        /**
         * Deletes a product from Firestore.
         * @param {string} itemId - The ID of the product to delete.
         */
        async function deleteProduct(itemId) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to delete products.');
                return;
            }

            const itemToDelete = inventory.find(item => item.id === itemId);
            const confirmed = await showMessageBox(
                'Confirm Deletion',
                `Are you sure you want to delete "${itemToDelete ? itemToDelete.name : 'this item'}"? This action cannot be undone.`,
                true
            );

            if (confirmed) {
                try {
                    // Use currentAppId for the Firestore path
                    const docRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/inventory`, itemId);
                    await firebase.deleteDoc(docRef);
                    showNotification('Product deleted successfully.', 'success', 2000); // Faster disappearance
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showMessageBox('Error', 'Failed to delete product. Please try again.');
                }
            }
        }


        // --- Main Tab Switching Logic ---

        /**
         * Switches the active main tab and displays the corresponding content.
         * @param {string} tabName - The name of the tab to activate ('inventory', 'manage-products', 'inventory-master', 'report-logs', 'sales-report', 'user-management', 'coupon-management').
         */
        function switchMainTab(tabName) {
            // Hide all main content divs
            inventoryContentEl.classList.add('hidden');
            inventoryMasterContentEl.classList.add('hidden');
            reportLogsContentEl.classList.add('hidden');
            salesReportContentEl.classList.add('hidden');
            userManagementContentEl.classList.add('hidden');
            couponManagementContentEl.classList.add('hidden'); // Hide coupon management

            // Deactivate all main tab buttons
            tabInventoryBtn.classList.remove('active');
            tabManageProductsBtn.classList.remove('active');
            tabInventoryMasterBtn.classList.remove('active');
            tabReportLogsBtn.classList.remove('active');
            tabSalesReportBtn.classList.remove('active');
            tabCouponManagementBtn.classList.remove('active'); // Deactivate coupon tab
            tabUserManagementBtn.classList.remove('active');

            // Show relevant content and activate relevant button
            if (tabName === 'inventory') {
                inventoryContentEl.classList.remove('hidden');
                tabInventoryBtn.classList.add('active');
            } else if (tabName === 'manage-products') {
                if (userRole === 'admin') {
                    tabManageProductsBtn.classList.add('active');
                    openManageProductModal();
                } else {
                    showMessageBox('Access Denied', 'You do not have permission to manage products.');
                    switchMainTab('inventory'); // Go back to default if no access
                }
            } else if (tabName === 'inventory-master') {
                if (userRole === 'admin') {
                    inventoryMasterContentEl.classList.remove('hidden');
                    tabInventoryMasterBtn.classList.add('active');
                    renderMasterList(getFilteredMasterList());
                } else {
                    showMessageBox('Access Denied', 'You do not have permission to view inventory master.');
                    switchMainTab('inventory');
                }
            } else if (tabName === 'report-logs') {
                if (userRole === 'admin') {
                    reportLogsContentEl.classList.remove('hidden');
                    tabReportLogsBtn.classList.add('active');
                } else {
                    showMessageBox('Access Denied', 'You do not have permission to view report logs.');
                    switchMainTab('inventory');
                }
            } else if (tabName === 'sales-report') {
                if (userRole === 'admin') {
                    salesReportContentEl.classList.remove('hidden');
                    tabSalesReportBtn.classList.add('active');
                    document.querySelectorAll('#sales-report-content button').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(`filter-${currentReportFilter}`).classList.add('active');
                    renderSalesReport();
                } else {
                    showMessageBox('Access Denied', 'You do not have permission to view sales reports.');
                    switchMainTab('inventory');
                }
            } else if (tabName === 'coupon-management') { // New case for Coupon Management
                if (userRole === 'admin') {
                    couponManagementContentEl.classList.remove('hidden');
                    tabCouponManagementBtn.classList.add('active');
                    renderCoupons(); // Render coupons when this tab is opened
                } else {
                    showMessageBox('Access Denied', 'You do not have permission to manage coupons.');
                    switchMainTab('inventory');
                }
            } else if (tabName === 'user-management') {
                if (userRole === 'admin') {
                    userManagementContentEl.classList.remove('hidden');
                    tabUserManagementBtn.classList.add('active');
                    renderUsers(); // Render users when this tab is opened
                } else {
                    showMessageBox('Access Denied', 'You do not have permission to manage users.');
                    switchMainTab('inventory');
                }
            }
        }

        // --- Modal Control Functions ---

        /**
         * Opens the "Manage Products" modal.
         */
        function openManageProductModal() {
            manageProductModalContainer.classList.remove('hidden');
            switchModalTab('add-product'); // Default to 'Add Product' tab inside modal
        }

        /**
         * Closes the "Manage Products" modal.
         */
        function closeManageProductModal() {
            manageProductModalContainer.classList.add('hidden');
            // Clear Add Product form fields
            modalNewProductNameEl.value = '';
            modalNewProductCategoryEl.value = ''; // Clear category
            modalNewProductPriceEl.value = '';
            modalNewProductStockEl.value = '';
            modalNewProductRestockLevelEl.value = '10'; // Reset to default
            modalNewProductImageUrlEl.value = ''; // Clear URL input
            modalImagePreviewEl.src = ''; // Clear preview
            modalImagePreviewEl.classList.add('hidden'); // Hide preview

            // Clear restock search and re-render restock list in case modal is opened again
            modalRestockSearchEl.value = '';
            switchMainTab('inventory'); // Re-activate the Inventory tab in the main view
        }

        /**
         * Switches the active tab inside the "Manage Products" modal.
         * @param {string} tabName - The name of the modal tab to activate ('add-product', 'restock-product').
         */
        function switchModalTab(tabName) {
            // Hide all modal content divs
            modalAddProductContent.classList.add('hidden');
            modalRestockProductContent.classList.add('hidden');

            // Deactivate all modal tab buttons
            modalTabAddProductBtn.classList.remove('active');
            modalTabRestockProductBtn.classList.remove('active');

            // Show relevant modal content and activate relevant modal button
            if (tabName === 'add-product') {
                modalAddProductContent.classList.remove('hidden');
                modalTabAddProductBtn.classList.add('active');
            } else if (tabName === 'restock-product') {
                modalRestockProductContent.classList.remove('hidden');
                modalTabRestockProductBtn.classList.add('active');
                renderModalRestockList(); // Render restock list every time this tab is opened
            }
        }

        /**
         * Opens the Sale Summary modal.
         */
        function openSaleSummaryModal() {
            saleSummaryModalContainer.classList.remove('hidden');
            renderSaleSummaryItems();
            calculateTotals(); // Ensure totals are up-to-date in summary modal
        }

        /**
         * Closes the Sale Summary modal.
         */
        function closeSaleSummaryModal() {
            saleSummaryModalContainer.classList.add('hidden');
            // Optionally clear customer info fields here if desired
            customerNameEl.value = '';
            customerAddressEl.value = '';
            customerContactEl.value = '';
            // Reset applied coupon when closing summary modal without finalizing
            appliedCoupon = null;
            couponCodeInputEl.value = '';
            couponStatusMessageEl.textContent = '';
            appliedDiscountDisplayRowEl.classList.add('hidden');
            calculateTotals(); // Recalculate totals to remove discount
        }

        /**
         * Displays the receipt in a modal and attaches event listeners for print/new sale.
         * @param {Object} saleData - The sale data to display.
         */
        function displayReceiptModal(saleData) {
            renderReceiptContent(saleData); // Populate the modal content

            // Show the modal
            receiptModalContainer.classList.remove('hidden');

            // Get references to the buttons inside the currently displayed modal for events
            activeReceiptPrintBtn = receiptModalContentTemplate.querySelector('#receipt-print-btn');
            activeReceiptNewSaleBtn = receiptModalContentTemplate.querySelector('#receipt-new-sale-btn');

            // Remove any existing listeners to prevent duplicates
            activeReceiptPrintBtn.removeEventListener('click', handlePrintReceipt);
            activeReceiptNewSaleBtn.removeEventListener('click', handleNewSaleFromReceipt);
            receiptCloseBtn.removeEventListener('click', closeReceiptModal); // Ensure no duplicate listeners

            // Add new listeners
            activeReceiptPrintBtn.addEventListener('click', handlePrintReceipt);
            activeReceiptNewSaleBtn.addEventListener('click', handleNewSaleFromReceipt);
            receiptCloseBtn.addEventListener('click', closeReceiptModal);
        }

        /**
         * Hides the receipt modal.
         */
        function closeReceiptModal() {
            receiptModalContainer.classList.add('hidden');
            // Important: remove listeners to prevent memory leaks and duplicate calls
            if (activeReceiptPrintBtn) activeReceiptPrintBtn.removeEventListener('click', handlePrintReceipt);
            if (activeReceiptNewSaleBtn) activeReceiptNewSaleBtn.removeEventListener('click', handleNewSaleFromReceipt);
            receiptCloseBtn.removeEventListener('click', closeReceiptModal); // Remove listener for the new dedicated close button

            // After closing the receipt, clear the cart for a new sale
            cart = [];
            appliedCoupon = null; // Clear applied coupon after sale
            couponCodeInputEl.value = '';
            couponStatusMessageEl.textContent = '';
            renderCart();
            // Switch back to inventory tab
            switchMainTab('inventory');
        }

        /**
         * Handler for the print button within the receipt modal.
         * Opens a new window with the receipt content and triggers print.
         */
        function handlePrintReceipt() {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) {
                showMessageBox('Print Error', 'Please allow pop-ups for this site to print the receipt.');
                return;
            }

            // Get the HTML content to be printed from the receipt modal content
            // We need to clone it and remove the buttons before writing to the print window
            const tempReceiptContent = receiptModalContentTemplate.cloneNode(true);
            const buttonsDiv = tempReceiptContent.querySelector('.flex.justify-end.space-x-3');
            if (buttonsDiv) {
                buttonsDiv.remove(); // Remove the buttons from the cloned content
            }
            // Also remove the standalone close button from the print version
            const closeButton = tempReceiptContent.querySelector('#receipt-close-btn');
            if (closeButton) {
                closeButton.remove();
            }

            const receiptContentForPrint = tempReceiptContent.innerHTML;


            // Construct the HTML for the new print window, including print-specific CSS
            const printHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Garahe ni Hulyo Receipt</title>
                    <style>
                        body {
                            font-family: 'Inter', sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #000;
                            background-color: #fff;
                            display: flex;
                            justify-content: center;
                            align-items: flex-start;
                            min-height: 10vh; /* Changed to vh to prevent large blank space */
                        }
                        #receipt-content-in-print {
                            width: 80mm;
                            max-width: 100%;
                            padding: 10mm;
                            box-sizing: border-box;
                            border: none;
                            box-shadow: none;
                            display: block;
                        }
                        .text-center { text-align: center; }
                        .mb-6 { margin-bottom: 1.5rem; }
                        .mb-2 { margin-bottom: 0.5rem; }
                        .text-2xl { font-size: 1.5rem; }
                        .font-extrabold { font-weight: 800; }
                        .text-gray-900 { color: #1a202c; }
                        .text-sm { font-size: 0.875rem; }
                        .text-gray-600 { color: #4a5568; }
                        .border-b { border-bottom-width: 1px; }
                        .border-gray-300 { border-color: #e2e8f0; }
                        .pb-4 { padding-bottom: 1rem; }
                        .text-lg { font-size: 1.125rem; }
                        .font-bold { font-weight: 700; }
                        .text-gray-800 { color: #2d3748; }
                        p { margin-bottom: 0.5rem; }
                        .flex { display: flex; }
                        .justify-between { justify-content: space-between; }
                        .items-center { align-items: center; }
                        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
                        .font-semibold { font-weight: 600; }
                        .mt-2 { margin-top: 0.5rem; }
                        .text-xl { font-size: 1.25rem; }
                        /* Hide the buttons only in the print view */
                        .print-hidden { display: none !important; }

                        /* Specific overrides for print readability */
                        #receipt-content-in-print h2, #receipt-content-in-print h3,
                        #receipt-content-in-print p, #receipt-content-in-print span,
                        #receipt-content-in-print strong {
                            color: #000 !important;
                        }
                        #receipt-content-in-print {
                            background-color: #fff !important;
                        }
                        #receipt-content-in-print .border-b, #receipt-content-in-print .border-gray-200, #receipt-content-in-print .border-gray-300 {
                            border-color: #bbb !important;
                        }
                        /* Removed: content: '₱'; rule that caused duplicate peso signs */
                    </style>
                </head>
                <body>
                    <div id="receipt-content-in-print">
                        ${receiptContentForPrint}
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(printHtml);
            printWindow.document.close();

            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
            };
        }

        /**
         * Handler for the "New Sale" button within the receipt modal.
         */
        function handleNewSaleFromReceipt() {
            cart = []; // Clear the cart
            renderCart(); // Update the cart display
            closeReceiptModal(); // Close the receipt modal
            switchMainTab('inventory'); // Optionally switch back to inventory tab
        }


        /**
         * Finalizes the sale and adds it to Firestore sales logs.
         */
        async function finalizeSale() {
            if (!isFirebaseReady || !auth.currentUser) {
                showMessageBox('Login Required', 'Please log in to finalize a sale.');
                return;
            }
            const customerName = customerNameEl.value.trim();
            const customerAddress = customerAddressEl.value.trim();
            const customerContact = customerContactEl.value.trim();

            if (!customerName || !customerAddress || !customerContact) {
                showMessageBox('Customer Info Required', 'Please fill in all customer details (Name, Address, Contact No.) before checking out.');
                return;
            }

            const currentSubtotal = parseFloat(summarySubtotalEl.textContent.replace('₱', '').replace(/,/g, ''));
            const currentTotal = parseFloat(summaryTotalEl.textContent.replace('₱', '').replace(/,/g, ''));
            const currentDiscountAmount = parseFloat(summaryAppliedDiscountEl.textContent.replace('₱', '').replace(/,/g, ''));

            const confirmed = await showMessageBox(
                'Confirm Final Checkout',
                `Proceed with checkout for ${formatCurrency(currentTotal)}?`,
                true
            );

            if (confirmed) {
                try {
                    // Generate a unique sales invoice ID
                    const salesInvoiceId = `INV-${salesInvoiceCounter++}-${Date.now().toString().slice(-4)}`;

                    // Firestore Transaction for atomicity
                    await firebase.runTransaction(db, async (transaction) => {
                        const itemRefs = {};
                        const itemSnaps = {};

                        // --- PHASE 1: READ ALL NECESSARY DATA FIRST ---
                        // 1. Get all inventory item documents for items in the cart
                        for (const cartItem of cart) {
                            const itemDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/inventory`, cartItem.id);
                            itemRefs[cartItem.id] = itemDocRef; // Store reference
                            itemSnaps[cartItem.id] = await transaction.get(itemDocRef); // Get snapshot
                            if (!itemSnaps[cartItem.id].exists()) {
                                throw new Error(`Product ${cartItem.name} not found in inventory.`);
                            }
                        }

                        // 2. If a coupon is applied, get the coupon document
                        let couponDocRef = null;
                        let couponDocSnap = null;
                        if (appliedCoupon) {
                            couponDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/coupons`, appliedCoupon.id);
                            couponDocSnap = await transaction.get(couponDocRef);

                            if (!couponDocSnap.exists()) {
                                throw new Error(`Applied coupon ${appliedCoupon.code} not found or expired.`);
                            }
                            // Re-validate the coupon within the transaction for absolute certainty
                            const couponData = couponDocSnap.data();
                            if (!isValidCoupon(couponData, true)) { // Check usage limit here too
                                throw new Error(`Coupon "${appliedCoupon.code}" is no longer valid.`);
                            }
                        }

                        // --- PHASE 2: PERFORM ALL WRITE OPERATIONS ---
                        // 1. Update stock for each item in the cart (Deduction now happens ONLY here)
                        for (const cartItem of cart) {
                            const currentStock = itemSnaps[cartItem.id].data().stock;
                            const newStock = currentStock - cartItem.quantity;

                            if (newStock < 0) {
                                throw new Error(`Insufficient stock for ${cartItem.name}. Available: ${formatNumber(currentStock)}, Needed: ${formatNumber(cartItem.quantity)}.`);
                            }
                            transaction.update(itemRefs[cartItem.id], { stock: newStock });
                        }

                        // 2. Increment coupon usage count if a coupon was applied
                        if (appliedCoupon && couponDocRef) { // Ensure couponDocRef is valid
                            const currentUsedCount = couponDocSnap.data().usedCount || 0;
                            const newUsedCount = currentUsedCount + 1;
                            transaction.update(couponDocRef, { usedCount: newUsedCount });
                        }

                        // 3. Add the completed sale to sales logs
                        const completedSale = {
                            salesInvoiceId: salesInvoiceId,
                            customer: {
                                name: customerName,
                                address: customerAddress,
                                contact: customerContact
                            },
                            items: JSON.parse(JSON.stringify(cart)), // Deep copy cart items
                            subtotal: currentSubtotal,
                            tax: 0, // Tax is now always 0
                            total: currentTotal,
                            couponApplied: appliedCoupon ? { ...appliedCoupon } : null, // Store applied coupon details
                            discountAmount: currentDiscountAmount,
                            timestamp: firebase.serverTimestamp() // Use server timestamp for consistency
                        };
                        await transaction.set(firebase.doc(firebase.collection(db, `artifacts/${currentAppId}/public/data/salesLogs`), salesInvoiceId), completedSale);
                    });

                    showNotification(`Sale finalized! Invoice ID: ${salesInvoiceId}`, 'new-sale', 5000);
                    closeSaleSummaryModal(); // Close the checkout summary modal
                    // The cart will be cleared when the receipt modal is closed or a new sale is initiated.
                    displayReceiptModal(
                        {
                            salesInvoiceId: salesInvoiceId,
                            customer: { name: customerName, address: customerAddress, contact: customerContact },
                            items: JSON.parse(JSON.stringify(cart)),
                            subtotal: currentSubtotal,
                            tax: 0,
                            total: currentTotal,
                            couponApplied: appliedCoupon ? { ...appliedCoupon } : null,
                            discountAmount: currentDiscountAmount,
                            timestamp: new Date() // Use local date for immediate display, server timestamp is for Firestore
                        }
                    );

                } catch (error) {
                    console.error("Error finalizing sale:", error);
                    showMessageBox('Error', `Failed to finalize sale: ${error.message || 'Please try again.'}`);
                    // Important: If transaction failed, cart is NOT cleared to allow user to retry or adjust.
                }
            }
        }

        /**
         * Voids a sale, updates its status, and returns stock to inventory.
         * Only accessible by admin.
         * @param {string} invoiceId - The salesInvoiceId of the sale to void.
         */
        async function voidSale(invoiceId) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to void sales.');
                return;
            }

            const saleToVoid = salesLogs.find(log => log.salesInvoiceId === invoiceId);

            if (!saleToVoid) {
                showMessageBox('Error', 'Sales record not found.');
                return;
            }
            if (saleToVoid.isVoided) {
                showMessageBox('Already Voided', 'This sale has already been voided.');
                return;
            }

            const confirmed = await showMessageBox(
                'Confirm Void Sale',
                `Are you sure you want to void sale ${invoiceId}? This will return items to inventory.`,
                true
            );

            if (confirmed) {
                try {
                    await firebase.runTransaction(db, async (transaction) => {
                        const saleDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/salesLogs`, invoiceId);
                        const saleDocSnap = await transaction.get(saleDocRef);

                        if (!saleDocSnap.exists() || saleDocSnap.data().isVoided) {
                            throw new Error('Sale not found or already voided.');
                        }

                        const saleData = saleDocSnap.data();
                        const itemsToReturn = saleData.items;

                        const itemRefs = {}; // Store item references
                        const itemSnaps = {}; // Store item snapshots

                        console.log(`[Void Sale] Initiating void for invoice ID: ${invoiceId}`);
                        console.log("[Void Sale] Items to return:", itemsToReturn);

                        // --- PHASE 1: READ ALL NECESSARY DATA FIRST ---
                        // Get all inventory item documents for items in the voided sale
                        for (const soldItem of itemsToReturn) {
                            const itemDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/inventory`, soldItem.id);
                            itemRefs[soldItem.id] = itemDocRef;
                            itemSnaps[soldItem.id] = await transaction.get(itemDocRef);
                            // If item doesn't exist, log warning but don't stop transaction for stock return
                            if (!itemSnaps[soldItem.id].exists()) {
                                console.warn(`[Void Sale] Product ${soldItem.name} (ID: ${soldItem.id}) not found in inventory. Stock cannot be returned.`);
                            } else {
                                console.log(`[Void Sale] Found inventory item ${soldItem.name}. Current stock: ${itemSnaps[soldItem.id].data().stock}`);
                            }
                        }

                        // --- PHASE 2: PERFORM ALL WRITE OPERATIONS ---
                        // Return stock for each item in the voided sale
                        for (const soldItem of itemsToReturn) {
                            if (itemSnaps[soldItem.id] && itemSnaps[soldItem.id].exists()) {
                                const currentStock = itemSnaps[soldItem.id].data().stock;
                                const newStock = currentStock + soldItem.quantity;
                                transaction.update(itemRefs[soldItem.id], { stock: newStock });
                                console.log(`[Void Sale] Updating stock for ${soldItem.name}: ${currentStock} -> ${newStock}`);
                            }
                        }

                        // Mark the sale as voided
                        transaction.update(saleDocRef, { isVoided: true, voidedAt: firebase.serverTimestamp() });
                        console.log(`[Void Sale] Sale ${invoiceId} marked as voided.`);
                    });

                    showNotification(`Sale ${invoiceId} has been voided. Stock returned.`, 'info', 4000);
                    // UI will update via onSnapshot listener
                } catch (error) {
                    console.error("[Void Sale] Error voiding sale:", error);
                    showMessageBox('Error', `Failed to void sale: ${error.message || 'Please try again.'}`);
                }
            }
        }


        // --- Sales Report Functions ---

        /**
         * Renders the sales report based on the current filter.
         */
        function renderSalesReport() {
            reportItemsSummaryEl.innerHTML = ''; // Clear previous items summary
            reportDetailsListEl.innerHTML = ''; // Clear previous individual sales logs

            let filteredSales = [];
            const now = new Date();
            let periodText = '';

            // Filter out voided sales for reporting totals and item summary
            const nonVoidedSales = salesLogs.filter(log => !log.isVoided);

            if (currentReportFilter === 'daily') {
                periodText = `Today (${now.toLocaleDateString()})`;
                filteredSales = nonVoidedSales.filter(log => {
                    const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp); // Handle Firestore Timestamp objects
                    return logDate.toDateString() === now.toDateString();
                });
            } else if (currentReportFilter === 'weekly') {
                // Get the start of the current week (Sunday)
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                startOfWeek.setHours(0, 0, 0, 0);

                // Get the end of the current week (Saturday)
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);

                periodText = `This Week (${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()})`;
                filteredSales = nonVoidedSales.filter(log => {
                    const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    return logDate >= startOfWeek && logDate <= endOfWeek;
                });
            } else if (currentReportFilter === 'monthly') {
                // Get the start of the current month
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);

                // Get the end of the current month
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                endOfMonth.setHours(23, 59, 59, 999);

                periodText = `This Month (${startOfMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})`;
                filteredSales = nonVoidedSales.filter(log => {
                    const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    return logDate >= startOfMonth && logDate <= endOfMonth;
                });
            }

            // Calculate total sales for the filtered period
            const totalSales = filteredSales.reduce((sum, log) => sum + log.total, 0);
            reportTotalSalesEl.textContent = formatCurrency(totalSales);
            reportPeriodInfoEl.textContent = periodText;

            // Aggregate item sales for the summary
            const aggregatedItems = {}; // { productId: { name, quantity, totalRevenue } }
            filteredSales.forEach(log => {
                log.items.forEach(item => {
                    if (!aggregatedItems[item.id]) {
                        aggregatedItems[item.id] = {
                            name: item.name,
                            quantity: 0,
                            totalRevenue: 0
                        };
                    }
                    aggregatedItems[item.id].quantity += item.quantity;
                    aggregatedItems[item.id].totalRevenue += (item.price * item.quantity);
                });
            });

            const sortedAggregatedItems = Object.values(aggregatedItems).sort((a, b) => b.totalRevenue - a.totalRevenue);

            // Display aggregated item summary as a table
            if (sortedAggregatedItems.length === 0) {
                emptyItemsSummaryMessageEl.classList.remove('hidden');
                reportItemsSummaryEl.innerHTML = ''; // Ensure no table is rendered if empty
            } else {
                emptyItemsSummaryMessageEl.classList.add('hidden');
                const summaryTable = document.createElement('table');
                summaryTable.className = 'w-full table-auto border-collapse border border-gray-600 text-gray-200';
                summaryTable.innerHTML = `
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left border border-gray-600">Item Name</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Quantity Sold</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Total Revenue</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = summaryTable.querySelector('tbody');

                sortedAggregatedItems.forEach((item, index) => {
                    const row = tbody.insertRow();
                    row.className = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-900'; // Zebra stripping
                    row.innerHTML = `
                        <td class="px-4 py-2 border border-gray-700 text-left">${item.name}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right">${formatNumber(item.quantity)}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right">${formatCurrency(item.totalRevenue)}</td>
                    `;
                });
                reportItemsSummaryEl.appendChild(summaryTable);
            }

            // Display individual sales in the report details list as a table
            if (filteredSales.length === 0) {
                emptyDetailsListMessageEl.classList.remove('hidden');
                reportDetailsListEl.innerHTML = ''; // Ensure no table is rendered if empty
            } else {
                emptyDetailsListMessageEl.classList.add('hidden');
                const detailsTable = document.createElement('table');
                detailsTable.className = 'w-full table-auto border-collapse border border-gray-600 text-gray-200';
                detailsTable.innerHTML = `
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left border border-gray-600">Invoice ID</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Date/Time</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Customer</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Items Sold</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = detailsTable.querySelector('tbody');

                filteredSales.sort((a, b) => {
                    const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateB - dateA; // Newest first
                });

                filteredSales.forEach((log, index) => {
                    const logDate = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleDateString();
                    const logTime = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const isVoided = log.isVoided ? true : false;
                    const voidedClass = isVoided ? 'opacity-70 text-red-300' : '';

                    const itemsSoldDetails = log.items.map(item => `${item.name} (x${formatNumber(item.quantity)})`).join(', ');

                    const row = tbody.insertRow();
                    row.className = `${index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-900'} ${voidedClass}`;
                    row.innerHTML = `
                        <td class="px-4 py-2 border border-gray-700 text-left">
                            <span class="sales-invoice-id font-semibold text-blue-400 cursor-pointer hover:underline" data-invoice-id="${log.salesInvoiceId}">${log.salesInvoiceId}</span>
                            ${isVoided ? '<span class="ml-2 px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full">VOIDED</span>' : ''}
                        </td>
                        <td class="px-4 py-2 border border-gray-700 text-left">${logDate} ${logTime}</td>
                        <td class="px-4 py-2 border border-gray-700 text-left">${log.customer.name}</td>
                        <td class="px-4 py-2 border border-gray-700 text-left text-sm">${itemsSoldDetails}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right font-bold text-blue-300">${formatCurrency(log.total)}</td>
                    `;
                });
                reportDetailsListEl.appendChild(detailsTable);

                // Re-add event listeners to the clickable invoice IDs within the new table
                document.querySelectorAll('#report-details-list .sales-invoice-id').forEach(span => {
                    span.addEventListener('click', (event) => {
                        const invoiceId = event.target.dataset.invoiceId;
                        const selectedLog = salesLogs.find(log => log.salesInvoiceId === invoiceId);
                        if (selectedLog) {
                            displayReceiptModal(selectedLog);
                        } else {
                            showMessageBox('Error', 'Sales record not found.');
                        }
                    });
                });
            }
        }

        /**
         * Downloads the current sales report as a PDF.
         * Now uses jsPDF-AutoTable to generate Excel-like tables.
         */
        async function generatePdfReport() {
            // Re-render sales report just before generating PDF to ensure it's up-to-date.
            renderSalesReport();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' size

            // --- Header Section ---
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(22);
            doc.setTextColor(30, 30, 30); // Darker text for formality
            doc.text("Garahe ni Hulyo Sales Report", 105, 20, { align: 'center' });

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80); // Slightly lighter gray for info
            doc.text(`Report Period: ${reportPeriodInfoEl.textContent}`, 105, 28, { align: 'center' });
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0); // Black for total sales
            doc.text(`Total Sales for Period: ${reportTotalSalesEl.textContent}`, 105, 38, { align: 'center' });

            let yOffset = 55; // Starting Y position for the first table

            // --- Items Sold Summary Table ---
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50); // Dark gray for section title
            doc.text("Items Sold Summary:", 15, yOffset);
            yOffset += 8; // Space before table

            const itemsSummaryData = [];
            const aggregatedItems = {}; // { productId: { name, quantity, totalRevenue } }
            const nonVoidedSales = salesLogs.filter(log => !log.isVoided); // Ensure report is based on non-voided sales

            nonVoidedSales.forEach(log => {
                const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                let isValidForPeriod = false;
                const now = new Date();

                if (currentReportFilter === 'daily' && logDate.toDateString() === now.toDateString()) {
                    isValidForPeriod = true;
                } else if (currentReportFilter === 'weekly') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    isValidForPeriod = logDate >= startOfWeek && logDate <= endOfWeek;
                } else if (currentReportFilter === 'monthly') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    startOfMonth.setHours(0, 0, 0, 0);
                    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endOfMonth.setHours(23, 59, 59, 999);
                    isValidForPeriod = logDate >= startOfMonth && logDate <= endOfMonth;
                }

                if (isValidForPeriod) {
                    log.items.forEach(item => {
                        if (!aggregatedItems[item.id]) {
                            aggregatedItems[item.id] = {
                                name: item.name,
                                quantity: 0,
                                totalRevenue: 0
                            };
                        }
                        aggregatedItems[item.id].quantity += item.quantity;
                        aggregatedItems[item.id].totalRevenue += (item.price * item.quantity);
                    });
                }
            });

            Object.values(aggregatedItems).sort((a, b) => b.totalRevenue - a.totalRevenue).forEach(item => {
                itemsSummaryData.push([item.name, formatNumber(item.quantity), formatCurrency(item.totalRevenue)]);
            });

            doc.autoTable({
                startY: yOffset,
                head: [['Item Name', 'Quantity Sold', 'Total Revenue']],
                body: itemsSummaryData,
                theme: 'grid', // 'striped' or 'grid'
                styles: {
                    font: 'helvetica',
                    fontSize: 9, // Slightly smaller font for table content
                    cellPadding: 2,
                    halign: 'left', // Default align for text
                    valign: 'middle',
                    textColor: [50, 50, 50], // Dark gray for body text
                    lineColor: [200, 200, 200], // Lighter lines for tables
                    lineWidth: 0.1
                },
                headStyles: {
                    fillColor: [60, 60, 60], // Darker gray for header background
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'center', // Center headers
                    fontSize: 10
                },
                columnStyles: {
                    1: { halign: 'right', cellWidth: 30 }, // Align Quantity Sold to right, fixed width
                    2: { halign: 'right', cellWidth: 35 }  // Align Total Revenue to right, fixed width
                },
                margin: { top: 10, right: 15, bottom: 10, left: 15 },
                pageBreak: 'auto', // Allow table to break across pages
                didDrawPage: function (data) {
                    // Footer: Page Number
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150); // Light gray for footer
                    doc.text("Page " + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            yOffset = doc.autoTable.previous.finalY + 15; // Position for the next section

            // --- Individual Sales Logs Table ---
            doc.setFontSize(14);
            doc.setTextColor(50, 50, 50);
            doc.text("Individual Sales Logs:", 15, yOffset);
            yOffset += 8;

            const salesLogsData = [];
            const salesForDetailedReport = nonVoidedSales.filter(log => {
                const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                let isValidForPeriod = false;
                const now = new Date();

                if (currentReportFilter === 'daily' && logDate.toDateString() === now.toDateString()) {
                    isValidForPeriod = true;
                } else if (currentReportFilter === 'weekly') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    isValidForPeriod = logDate >= startOfWeek && logDate <= endOfWeek;
                } else if (currentReportFilter === 'monthly') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    startOfMonth.setHours(0, 0, 0, 0);
                    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endOfMonth.setHours(23, 59, 59, 999);
                    isValidForPeriod = logDate >= startOfMonth && logDate <= endOfMonth;
                }
                return isValidForPeriod;
            }).sort((a, b) => {
                const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return dateB - dateA; // Newest first
            });

            salesForDetailedReport.forEach(log => { // Corrected from `salesLogsData.forEach(log =>`
                const logDate = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleDateString();
                const logTime = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const itemsSoldDetails = log.items.map(item => `${item.name} (x${formatNumber(item.quantity)})`).join(', ');
                salesLogsData.push([
                    log.salesInvoiceId,
                    `${logDate} ${logTime}`,
                    log.customer.name,
                    itemsSoldDetails,
                    formatCurrency(log.total)
                ]);
            });

            doc.autoTable({
                startY: yOffset,
                head: [['Invoice ID', 'Date/Time', 'Customer', 'Items Sold', 'Total']],
                body: salesLogsData,
                theme: 'grid',
                styles: {
                    font: 'helvetica',
                    fontSize: 9, // Slightly smaller font for table content
                    cellPadding: 2,
                    halign: 'left',
                    valign: 'top',
                    textColor: [50, 50, 50],
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1
                },
                headStyles: {
                    fillColor: [60, 60, 60],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'center',
                    fontSize: 10
                },
                columnStyles: {
                    0: { cellWidth: 25 }, // Invoice ID
                    1: { cellWidth: 30 }, // Date/Time
                    2: { cellWidth: 40 }, // Customer Name
                    3: { cellWidth: 70 }, // Items Sold
                    4: { halign: 'right', cellWidth: 30 } // Total
                },
                margin: { top: 10, right: 15, bottom: 10, left: 15 },
                pageBreak: 'auto', // Allow table to break across pages
                didDrawPage: function (data) {
                    // Footer: Page Number
                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text("Page " + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            doc.save(`Sales_Report_${currentReportFilter}_${new Date().toISOString().slice(0, 10)}.pdf`);
            showNotification('Sales report downloaded successfully as PDF!', 'success', 3000);
        }

        // --- Coupon Management Functions ---

        /**
         * Renders the list of existing coupons in the Coupon Management tab.
         */
        function renderCoupons() {
            existingCouponsListEl.innerHTML = ''; // Clear existing list

            if (coupons.length === 0) {
                emptyCouponsMessageEl.classList.remove('hidden');
                return;
            } else {
                emptyCouponsMessageEl.classList.add('hidden');
            }

            // Sort coupons by code
            const sortedCoupons = [...coupons].sort((a, b) => a.code.localeCompare(b.code));

            sortedCoupons.forEach(coupon => {
                const now = new Date();
                const validFromDate = new Date(coupon.validFrom);
                const validUntilDate = new Date(coupon.validUntil);
                let status = 'Active';
                let statusColor = 'text-green-500';

                if (!coupon.isActive) {
                    status = 'Inactive';
                    statusColor = 'text-gray-500';
                } else if (now < validFromDate) {
                    status = 'Upcoming';
                    statusColor = 'text-blue-500';
                } else if (now > validUntilDate) {
                    status = 'Expired';
                    statusColor = 'text-red-500';
                } else if (coupon.usageLimit > 0 && coupon.usedCount >= coupon.usageLimit) {
                    status = 'Usage Limit Reached';
                    statusColor = 'text-yellow-500';
                }

                const couponDiv = document.createElement('div');
                couponDiv.className = `
                    bg-gray-700 rounded-lg p-4 mb-3 shadow-sm border border-gray-600
                    flex flex-col sm:flex-row justify-between items-center transition-all duration-200
                    hover:scale-[1.01] hover:bg-gray-600
                `;
                couponDiv.innerHTML = `
                    <div class="flex-1 text-left mb-2 sm:mb-0">
                        <h3 class="text-xl font-bold text-white">${coupon.code} <span class="text-sm ${statusColor}">(${status})</span></h3>
                        <p class="text-gray-300">${coupon.type === 'fixed' ? formatCurrency(coupon.value) : coupon.value + '%'} Discount</p>
                        <p class="text-gray-400 text-sm">Valid: ${validFromDate.toLocaleDateString()} - ${validUntilDate.toLocaleDateString()}</p>
                        <p class="text-gray-400 text-sm">Usage: ${formatNumber(coupon.usedCount || 0)} / ${coupon.usageLimit === 0 ? 'Unlimited' : formatNumber(coupon.usageLimit)}</p>
                    </div>
                    ${userRole === 'admin' ? `
                        <div class="flex space-x-2 mt-2 sm:mt-0">
                            <button data-coupon-id="${coupon.id}" class="toggle-coupon-status-btn px-3 py-1 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm">
                                ${coupon.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                            <button data-coupon-id="${coupon.id}" class="delete-coupon-btn px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm">
                                Delete
                            </button>
                        </div>
                    ` : ''}
                `;
                existingCouponsListEl.appendChild(couponDiv);
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.toggle-coupon-status-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const couponId = event.target.dataset.couponId;
                    toggleCouponStatus(couponId);
                });
            });

            document.querySelectorAll('.delete-coupon-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const couponId = event.target.dataset.couponId;
                    deleteCoupon(couponId);
                });
            });
        }

        /**
         * Creates a new coupon and adds it to Firestore.
         */
        async function createCoupon() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to create coupons.');
                return;
            }

            const code = newCouponCodeEl.value.trim().toUpperCase();
            const type = newCouponTypeEl.value;
            const value = parseFloat(newCouponValueEl.value);
            const validFrom = newCouponValidFromEl.value; //YYYY-MM-DD string
            const validUntil = newCouponValidUntilEl.value; //YYYY-MM-DD string
            const usageLimit = parseInt(newCouponUsageLimitEl.value);

            // Basic Validation
            if (!code) {
                showMessageBox('Input Error', 'Coupon Code cannot be empty.');
                return;
            }
            if (!type) {
                showMessageBox('Input Error', 'Discount Type cannot be empty.');
                return;
            }
            if (isNaN(value) || value <= 0) {
                showMessageBox('Input Error', 'Please enter a valid Discount Value greater than 0.');
                return;
            }
            if (type === 'percentage' && value > 100) {
                showMessageBox('Input Error', 'Percentage discount cannot exceed 100%.');
                return;
            }
            if (!validFrom) {
                showMessageBox('Input Error', '"Valid From" date cannot be empty.');
                return;
            }
            if (!validUntil) {
                showMessageBox('Input Error', '"Valid Until" date cannot be empty.');
                return;
            }
            if (new Date(validFrom) > new Date(validUntil)) {
                showMessageBox('Input Error', '"Valid From" date cannot be after "Valid Until" date.');
                return;
            }
            if (isNaN(usageLimit) || usageLimit < 0) {
                showMessageBox('Input Error', 'Please enter a valid Usage Limit (0 for unlimited).');
                return;
            }
            if (coupons.some(c => c.code === code)) {
                showMessageBox('Input Error', 'Coupon code already exists. Please choose a unique code.');
                return;
            }

            const newCoupon = {
                code: code,
                type: type,
                value: value,
                validFrom: new Date(validFrom).toISOString(), // Store as ISO string
                validUntil: new Date(validUntil).toISOString(), // Store as ISO string
                usageLimit: usageLimit,
                usedCount: 0,
                isActive: true,
                createdAt: firebase.serverTimestamp()
            };

            try {
                // Add coupon to Firestore, letting Firestore auto-generate ID
                const docRef = await firebase.addDoc(firebase.collection(db, `artifacts/${currentAppId}/public/data/coupons`), newCoupon);
                showNotification(`Coupon "${code}" created successfully!`, 'success', 2000); // Faster disappearance

                // Clear form
                newCouponCodeEl.value = '';
                newCouponTypeEl.value = 'fixed';
                newCouponValueEl.value = '';
                newCouponValidFromEl.value = '';
                newCouponValidUntilEl.value = '';
                newCouponUsageLimitEl.value = '0';
                // Listener will re-render existing coupons
            } catch (error) {
                console.error("Error creating coupon:", error);
                showMessageBox('Error', `Failed to create coupon: ${error.message || 'Please try again.'}`);
            }
        }

        /**
         * Toggles the active status of a coupon in Firestore.
         * @param {string} couponId - The ID of the coupon document.
         */
        async function toggleCouponStatus(couponId) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to change coupon status.');
                return;
            }
            const couponToToggle = coupons.find(c => c.id === couponId);
            if (!couponToToggle) {
                showMessageBox('Error', 'Coupon not found.');
                return;
            }

            const newStatus = !couponToToggle.isActive;
            const confirmed = await showMessageBox(
                'Confirm Status Change',
                `Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} coupon "${couponToToggle.code}"?`,
                true
            );

            if (confirmed) {
                try {
                    const couponDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/coupons`, couponId);
                    await firebase.updateDoc(couponDocRef, { isActive: newStatus });
                    showNotification(`Coupon "${couponToToggle.code}" is now ${newStatus ? 'active' : 'inactive'}.`, 'info', 2000); // Faster disappearance
                    // Listener will re-render
                } catch (error) {
                    console.error("Error toggling coupon status:", error);
                    showMessageBox('Error', `Failed to change coupon status: ${error.message || 'Please try again.'}`);
                }
            }
        }

        /**
         * Deletes a coupon from Firestore.
         * @param {string} couponId - The ID of the coupon document.
         */
        async function deleteCoupon(couponId) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to delete coupons.');
                return;
            }
            const couponToDelete = coupons.find(c => c.id === couponId);
            const confirmed = await showMessageBox(
                'Confirm Deletion',
                `Are you sure you want to delete coupon "${couponToDelete ? couponToDelete.code : 'this coupon'}"? This action cannot be undone.`,
                true
            );

            if (confirmed) {
                try {
                    const couponDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/coupons`, couponId);
                    await firebase.deleteDoc(couponDocRef);
                    showNotification('Coupon deleted successfully.', 'success', 2000); // Faster disappearance
                    // Listener will re-render
                } catch (error) {
                    console.error("Error deleting coupon:", error);
                    showMessageBox('Error', `Failed to delete coupon: ${error.message || 'Please try again.'}`);
                }
            }
        }

        /**
         * Applies a coupon code to the current cart.
         */
        function applyCoupon() {
            const code = couponCodeInputEl.value.trim().toUpperCase();
            couponStatusMessageEl.textContent = ''; // Clear previous messages
            appliedDiscountDisplayRowEl.classList.add('hidden'); // Hide discount until applied

            if (!code) {
                appliedCoupon = null;
                calculateTotals();
                couponStatusMessageEl.textContent = 'Coupon cleared.';
                return;
            }

            const now = new Date();
            const foundCoupon = coupons.find(c => c.code === code);

            if (!foundCoupon) {
                appliedCoupon = null;
                couponStatusMessageEl.textContent = 'Invalid coupon code.';
                calculateTotals();
                return;
            }

            const validFromDate = new Date(foundCoupon.validFrom);
            const validUntilDate = new Date(foundCoupon.validUntil);

            if (!foundCoupon.isActive) {
                appliedCoupon = null;
                couponStatusMessageEl.textContent = 'Coupon is inactive.';
                calculateTotals();
                return;
            }
            if (now < validFromDate) {
                appliedCoupon = null;
                couponStatusMessageEl.textContent = `Coupon not yet active. Valid from ${validFromDate.toLocaleDateString()}.`;
                calculateTotals();
                return;
            }
            if (now > validUntilDate) {
                appliedCoupon = null;
                couponStatusMessageEl.textContent = 'Coupon has expired.';
                calculateTotals();
                return;
            }
            if (foundCoupon.usageLimit > 0 && foundCoupon.usedCount >= foundCoupon.usageLimit) {
                appliedCoupon = null;
                couponStatusMessageEl.textContent = 'Coupon usage limit reached.';
                calculateTotals();
                return;
            }

            appliedCoupon = foundCoupon;
            couponStatusMessageEl.textContent = `Coupon "${foundCoupon.code}" applied!`;
            appliedDiscountDisplayRowEl.classList.remove('hidden'); // Show discount row
            calculateTotals();
            showNotification(`Coupon "${foundCoupon.code}" applied!`, 'success', 2000); // Faster disappearance
        }

        // --- User Management Functions ---

        /**
         * Renders the list of existing users in the User Management tab.
         */
        function renderUsers() {
            userListEl.innerHTML = ''; // Clear existing list

            if (users.length === 0) {
                emptyUsersMessageEl.classList.remove('hidden');
                return;
            } else {
                emptyUsersMessageEl.classList.add('hidden');
            }

            // Sort users by email, handling null/undefined emails gracefully
            const sortedUsers = [...users].sort((a, b) => {
                const emailA = a.email || ''; // Use empty string if email is null/undefined
                const emailB = b.email || ''; // Use empty string if email is null/undefined
                return emailA.localeCompare(emailB);
            });

            const userTable = document.createElement('table');
            userTable.className = 'w-full table-auto border-collapse border border-gray-600 text-gray-200';
            userTable.innerHTML = `
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-4 py-2 text-left border border-gray-600">Email</th>
                        <th class="px-4 py-2 text-left border border-gray-600">Role</th>
                        <th class="px-4 py-2 text-center border border-gray-600">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = userTable.querySelector('tbody');

            sortedUsers.forEach((userItem, index) => {
                // Ensure we don't allow editing/deleting the currently logged-in admin user's own role
                const isCurrentUser = userItem.id === userId;
                const actionsHtml = isCurrentUser ?
                    `<span class="text-gray-500 text-sm">Current User</span>` :
                    `<button data-user-id="${userItem.id}" data-user-email="${userItem.email}" data-user-role="${userItem.role}"
                            class="edit-user-btn px-3 py-1 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm mr-2">
                        Edit Role
                    </button>
                    <button data-user-id="${userItem.id}" data-user-email="${userItem.email}"
                            class="delete-user-btn px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm">
                        Delete
                    </button>`;

                const row = tbody.insertRow();
                row.className = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-900'; // Zebra stripping
                row.innerHTML = `
                    <td class="px-4 py-2 border border-gray-700 text-left">${userItem.email}</td>
                    <td class="px-4 py-2 border border-gray-700 text-left">${userItem.role.charAt(0).toUpperCase() + userItem.role.slice(1)}</td>
                    <td class="px-4 py-2 border border-gray-700 text-center">${actionsHtml}</td>
                `;
            });
            userListEl.appendChild(userTable);

            // Add event listeners for "Edit Role" and "Delete" buttons
            document.querySelectorAll('.edit-user-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const id = event.target.dataset.userId;
                    const email = event.target.dataset.userEmail;
                    const role = event.target.dataset.userRole;
                    openEditUserRoleModal(id, email, role);
                });
            });

            document.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const id = event.target.dataset.userId;
                    const email = event.target.dataset.userEmail;
                    deleteUser(id, email);
                });
            });
        }

        /**
         * Opens the modal to edit a user's role.
         * @param {string} id - The Firestore document ID of the user's role.
         * @param {string} email - The user's email.
         * @param {string} currentRole - The user's current role.
         */
        function openEditUserRoleModal(id, email, currentRole) {
            if (userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to edit user roles.');
                return;
            }
            editUserEmailDisplayEl.textContent = email;
            editUserRoleSelectEl.value = currentRole;
            saveUserRoleBtn.dataset.editingUserId = id; // Store the user ID

            editUserRoleModalContainer.classList.remove('hidden');
        }

        /**
         * Closes the edit user role modal.
         */
        function closeEditUserRoleModal() {
            editUserRoleModalContainer.classList.add('hidden');
            editUserEmailDisplayEl.textContent = '';
            editUserRoleSelectEl.value = 'user';
            delete saveUserRoleBtn.dataset.editingUserId;
        }

        /**
         * Saves the edited user role to Firestore.
         */
        async function saveEditedUserRole() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to save user role changes.');
                return;
            }
            const id = saveUserRoleBtn.dataset.editingUserId;
            const newRole = editUserRoleSelectEl.value;
            const userEmail = editUserEmailDisplayEl.textContent; // For display in message box

            if (!id) {
                showMessageBox('Error', 'No user selected for editing.');
                return;
            }

            // Prevent admin from changing their own role (as this could lock them out)
            if (id === userId) {
                showMessageBox('Forbidden', 'You cannot change your own role through this interface.');
                return;
            }

            const confirmed = await showMessageBox(
                'Confirm Role Change',
                `Are you sure you want to change the role of "${userEmail}" to "${newRole}"?`,
                true
            );

            if (confirmed) {
                try {
                    const userDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/users`, id);
                    await firebase.updateDoc(userDocRef, { role: newRole });
                    showNotification(`Role for "${userEmail}" updated to "${newRole}" successfully.`, 'success', 2000); // Faster disappearance
                    closeEditUserRoleModal();
                } catch (error) {
                    console.error("Error updating user role:", error);
                    showMessageBox('Error', `Failed to update user role: ${error.message || 'Please try again.'}`);
                }
            }
        }

        /**
         * Deletes a user's role document from Firestore.
         * Note: This does NOT delete the user from Firebase Authentication.
         * Full user deletion requires server-side (Firebase Admin SDK).
         * Here, it effectively removes their app access/role.
         * @param {string} id - The Firestore document ID of the user's role.
         * @param {string} email - The user's email for display.
         */
        async function deleteUser(id, email) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to delete users.');
                return;
            }

            // Prevent admin from deleting themselves
            if (id === userId) {
                showMessageBox('Forbidden', 'You cannot delete your own user account through this interface.');
                return;
            }

            const confirmed = await showMessageBox(
                'Confirm User Deletion',
                `Are you sure you want to delete the user "${email}"? This will remove their access to the system roles. Their authentication account may still exist in Firebase.`,
                true
            );

            if (confirmed) {
                try {
                    const userDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/users`, id);
                    await firebase.deleteDoc(userDocRef);
                    showNotification(`User "${email}" role deleted successfully.`, 'success', 2000); // Faster disappearance
                    // Listener will re-render the user list
                } catch (error) {
                    console.error("Error deleting user role:", error);
                    showMessageBox('Error', `Failed to delete user role: ${error.message || 'Please try again.'}`);
                }
            }
        }

        /**
         * Renders the low stock items in the low stock modal.
         */
        function renderLowStockModal() {
            lowStockListEl.innerHTML = ''; // Clear existing items

            if (lowStockItems.length === 0) {
                emptyLowStockMessageEl.classList.remove('hidden');
                return;
            } else {
                emptyLowStockMessageEl.classList.add('hidden');
            }

            // Sort low stock items by name
            const sortedLowStockItems = [...lowStockItems].sort((a, b) => a.name.localeCompare(b.name));

            sortedLowStockItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `
                    bg-gray-700 rounded-lg p-4 mb-3 shadow-sm border border-red-500
                    flex flex-col sm:flex-row justify-between items-center
                `;
                itemDiv.innerHTML = `
                    <div class="flex-1 text-left mb-2 sm:mb-0">
                        <h3 class="text-xl font-semibold text-red-300">${item.name}</h3>
                        <p class="text-gray-300">Current Stock: <span class="font-bold">${formatNumber(item.stock)}</span></p>
                        <p class="text-gray-400 text-sm">Restock Level: ${formatNumber(item.restockLevel || 0)}</p>
                    </div>
                `;
                lowStockListEl.appendChild(itemDiv);
            });
        }

        /**
         * Opens the low stock modal.
         */
        function openLowStockModal() {
            renderLowStockModal(); // Render content every time it's opened
            lowStockModalContainerEl.classList.remove('hidden');
        }

        /**
         * Closes the low stock modal.
         */
        function closeLowStockModal() {
            lowStockModalContainerEl.classList.add('hidden');
        }


        // --- Firestore Listeners ---
        let inventoryUnsubscribe;
        let salesLogsUnsubscribe;
        let couponsUnsubscribe;
        let usersUnsubscribe; // New: Unsubscribe for users listener


        // Function to set up Firestore listeners (called after Firebase is ready)
        function setupFirestoreListeners() {
            if (!isFirebaseReady || !currentAppId) {
                console.error("Firestore listeners cannot be set up: Firebase not ready or currentAppId is missing.");
                return;
            }

            // Reference to the public inventory collection
            const inventoryCollectionRef = firebase.collection(db, `artifacts/${currentAppId}/public/data/inventory`);
            // Reference to the public sales logs collection
            const salesLogsCollectionRef = firebase.collection(db, `artifacts/${currentAppId}/public/data/salesLogs`);
            // Reference to the public coupons collection
            const couponsCollectionRef = firebase.collection(db, `artifacts/${currentAppId}/public/data/coupons`);
            // Reference to the public users collection
            const usersCollectionRef = firebase.collection(db, `artifacts/${currentAppId}/public/data/users`);


            // Inventory Listener
            inventoryLoadingEl.classList.remove('hidden');
            masterListLoadingEl.classList.remove('hidden'); // Also show loading for master list
            inventoryUnsubscribe = firebase.onSnapshot(inventoryCollectionRef, async (snapshot) => {
                const fetchedInventory = [];
                const currentLowStock = []; // Temp array for low stock items
                snapshot.forEach(doc => {
                    const itemData = { id: doc.id, ...doc.data() };
                    fetchedInventory.push(itemData);
                    // Check for low stock for bell notification
                    if (itemData.stock <= itemData.restockLevel && itemData.stock > 0) {
                        currentLowStock.push(itemData);
                    }
                });
                inventory = fetchedInventory; // Update global inventory array
                lowStockItems = currentLowStock; // Update global low stock items

                // Update notification bell badge
                if (lowStockItems.length > 0) {
                    notificationCountBadgeEl.textContent = lowStockItems.length;
                    notificationCountBadgeEl.classList.remove('hidden');
                } else {
                    notificationCountBadgeEl.classList.add('hidden');
                }

                populateCategoryFilter(); // Populate category filter when inventory updates
                renderInventory(getFilteredInventory()); // Re-render current view with new data
                renderMasterList(getFilteredMasterList()); // Re-render master list with new data
                // Also re-render low stock modal if it's open
                if (!lowStockModalContainerEl.classList.contains('hidden')) {
                    renderLowStockModal();
                }

                inventoryLoadingEl.classList.add('hidden');
                masterListLoadingEl.classList.add('hidden');

            }, (error) => {
                console.error("Error listening to inventory:", error);
                // Only show data error if user is logged in, as guests won't have access anyway
                if (auth.currentUser) {
                    showMessageBox('Data Error', 'Failed to load inventory data. Please check your connection and security rules.');
                }
                inventoryLoadingEl.classList.add('hidden');
                masterListLoadingEl.classList.add('hidden');
            });

            // Sales Logs Listener
            salesLogLoadingEl.classList.remove('hidden');
            salesLogsUnsubscribe = firebase.onSnapshot(salesLogsCollectionRef, (snapshot) => {
                const fetchedSalesLogs = [];
                let latestSaleTimestamp = 0; // To track the latest sale for notifications

                snapshot.forEach(doc => {
                    const saleData = { id: doc.id, ...doc.data() };
                    fetchedSalesLogs.push(saleData);

                    // Check for new sales for notification
                    const saleTime = saleData.timestamp.toDate ? saleData.timestamp.toDate().getTime() : new Date(saleData.timestamp).getTime();
                    if (saleTime > latestSaleTimestamp) {
                        latestSaleTimestamp = saleTime;
                    }
                });

                // Check if a new sale occurred (simple check: if new snapshot has more sales, or a newer timestamp)
                // This is a basic check; for robust new sale detection in real-time,
                // you might need to compare the previous state of salesLogs or use a dedicated "last updated" field.
                if (salesLogs.length > 0 && fetchedSalesLogs.length > salesLogs.length) {
                    const newSales = fetchedSalesLogs.filter(newSale => !salesLogs.some(oldSale => oldSale.id === newSale.id));
                    newSales.forEach(sale => {
                        if (!sale.isVoided) { // Only notify for non-voided sales
                            showNotification(`New Sale! Invoice ID: ${sale.salesInvoiceId}`, 'new-sale', 5000);
                        }
                    });
                }
                salesLogs = fetchedSalesLogs; // Update global salesLogs array
                renderReportLogs(); // Re-render the report logs
                renderSalesReport(); // Re-render the sales report with new data
                salesLogLoadingEl.classList.add('hidden');

                // Update salesInvoiceCounter to ensure unique new IDs
                if (salesLogs.length > 0) {
                    const maxInvoiceNum = salesLogs.reduce((max, log) => {
                        const match = log.salesInvoiceId ? log.salesInvoiceId.match(/INV-(\d+)/) : null;
                        return match ? Math.max(max, parseInt(match[1])) : max;
                    }, 1000); // Start from 1000 if no logs
                    salesInvoiceCounter = maxInvoiceNum + 1;
                }
            }, (error) => {
                console.error("Error listening to sales logs:", error);
                // Only show data error if user is logged in and is admin
                if (auth.currentUser && userRole === 'admin') {
                    showMessageBox('Data Error', 'Failed to load sales log data. Please check your connection and security rules.');
                }
                salesLogLoadingEl.classList.add('hidden');
            });

            // Coupons Listener
            couponsUnsubscribe = firebase.onSnapshot(couponsCollectionRef, (snapshot) => {
                const fetchedCoupons = [];
                snapshot.forEach(doc => {
                    fetchedCoupons.push({ id: doc.id, ...doc.data() });
                });
                coupons = fetchedCoupons; // Update global coupons array
                renderCoupons(); // Render the coupon list
                // If the currently applied coupon is no longer valid, clear it
                if (appliedCoupon) {
                    const updatedAppliedCoupon = coupons.find(c => c.id === appliedCoupon.id);
                    if (!updatedAppliedCoupon || !isValidCoupon(updatedAppliedCoupon, true)) { // Pass true to also check usage limit
                        appliedCoupon = null;
                        couponCodeInputEl.value = '';
                        couponStatusMessageEl.textContent = 'Applied coupon is no longer valid.';
                        appliedDiscountDisplayRowEl.classList.add('hidden'); // Hide discount row
                        calculateTotals(); // Recalculate if coupon became invalid
                    } else {
                        // If still valid, update the appliedCoupon object in case its state changed
                        appliedCoupon = updatedAppliedCoupon;
                        calculateTotals(); // Recalculate to ensure discount is correct with any changes
                    }
                }
            }, (error) => {
                console.error("Error listening to coupons:", error);
                if (auth.currentUser && userRole === 'admin') {
                    showMessageBox('Data Error', 'Failed to load coupon data. Please check your connection and security rules.');
                }
            });

            // New: Users Listener
            userListLoadingEl.classList.remove('hidden');
            usersUnsubscribe = firebase.onSnapshot(usersCollectionRef, (snapshot) => {
                const fetchedUsers = [];
                snapshot.forEach(doc => {
                    fetchedUsers.push({ id: doc.id, ...doc.data() });
                });
                users = fetchedUsers; // Update global users array
                renderUsers(); // Render the user list
                userListLoadingEl.classList.add('hidden');
            }, (error) => {
                console.error("Error listening to users:", error);
                if (auth.currentUser && userRole === 'admin') {
                    showMessageBox('Data Error', 'Failed to load user data. Please check your connection and security rules.');
                }
                userListLoadingEl.classList.add('hidden');
            });
        }

        // Helper function for coupon validation (can be reused)
        function isValidCoupon(coupon, checkUsageLimit = false) {
            const now = new Date();
            const validFromDate = new Date(coupon.validFrom);
            const validUntilDate = new Date(coupon.validUntil);

            if (!coupon.isActive) return false;
            if (now < validFromDate) return false;
            if (now > validUntilDate) return false;
            if (checkUsageLimit && coupon.usageLimit > 0 && coupon.usedCount >= coupon.usageLimit) return false;

            return true;
        }


        // --- Authentication and Authorization Functions ---

        /**
         * Updates the UI based on the current user's authentication state and role.
         */
        function updateUIForUserRole() {
            currentUserRoleEl.textContent = `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;

            // Hide/Show navigation tabs based on role
            document.querySelectorAll('.admin-only').forEach(el => {
                if (userRole === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // Hide/Show main content areas based on role
            document.querySelectorAll('.admin-only-content').forEach(el => {
                if (userRole === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // If a restricted tab is currently active, switch to dashboard
            const activeTabButton = document.querySelector('.tab-button.active');
            if (activeTabButton && activeTabButton.classList.contains('admin-only') && userRole !== 'admin') {
                switchMainTab('inventory');
            }

            // Update Login/Logout button text
            if (userRole === 'guest') {
                loginLogoutButtonEl.textContent = 'Login';
                loginLogoutButtonEl.classList.remove('bg-red-600', 'hover:bg-red-700', 'active:bg-red-800');
                loginLogoutButtonEl.classList.add('bg-purple-600', 'hover:bg-purple-700', 'active:bg-purple-800');
            } else {
                loginLogoutButtonEl.textContent = 'Logout';
                loginLogoutButtonEl.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'active:bg-purple-800');
                loginLogoutButtonEl.classList.add('bg-red-600', 'hover:bg-red-700', 'active:bg-red-800');
            }
        }

        /**
         * Opens the login modal.
         */
        function openLoginModal() {
            loginModalContainerEl.classList.remove('hidden');
            appContentWrapperEl.classList.add('hidden'); // Hide main app when showing login modal
            loginEmailEl.value = '';
            loginPasswordEl.value = '';
        }

        /**
         * Closes the login modal.
         */
        function closeLoginModal() {
            loginModalContainerEl.classList.add('hidden');
            appContentWrapperEl.classList.remove('hidden'); // Show main app after login modal is closed
        }

        /**
         * Handles user login with email and password.
         */
        async function handleLogin() {
            const email = loginEmailEl.value;
            const password = loginPasswordEl.value;

            if (!email || !password) {
                showMessageBox('Login Error', 'Please enter both email and password.');
                return;
            }

            try {
                const userCredential = await firebase.signInWithEmailAndPassword(auth, email, password);
                // Auth state listener will handle updating UI and userRole
                showNotification(`Welcome, ${userCredential.user.email}!`, 'success', 3000);
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = 'Login failed. Please check your credentials.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed login attempts. Please try again later.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'Email/Password sign-in is not enabled. Please enable it in Firebase Authentication.';
                }
                showMessageBox('Login Error', errorMessage);
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            const confirmed = await showMessageBox('Confirm Logout', 'Are you sure you want to log out?', true);
            if (confirmed) {
                try {
                    await firebase.signOut(auth);
                    showNotification('You have been logged out.', 'info', 3000);
                    // onAuthStateChanged will handle role and UI update and showing login modal
                } catch (error) {
                    console.error("Logout error:", error);
                    showMessageBox('Logout Error', 'Failed to log out. Please try again.');
                }
            }
        }

        /**
         * Adds a new user to Firebase Authentication and sets their role in Firestore.
         * IMPORTANT: In a real production app, user creation by an admin should be handled
         * via a secure backend (e.g., Firebase Cloud Functions with Admin SDK) to prevent
         * exposing admin credentials or session changes on the client side.
         * This client-side implementation will cause the current admin user to be signed out
         * and the newly created user to be signed in. The admin will need to re-login.
         */
        async function addNewUser() {
            console.log("Attempting to add new user. Current userRole:", userRole, "Current userId:", userId); // Added for debugging

            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to add new users. Only administrators can perform this action.'); // More specific message
                return;
            }

            const email = newUserEmailEl.value.trim();
            const password = newUserPasswordEl.value.trim();
            const role = newUserRoleEl.value;

            if (!email || !password || !role) {
                showMessageBox('Input Error', 'Please fill in all fields (Email, Password, Role).');
                return;
            }

            if (password.length < 6) {
                showMessageBox('Input Error', 'Password must be at least 6 characters long.');
                return;
            }

            try {
                // Create user in Firebase Authentication
                const newUserCredential = await firebase.createUserWithEmailAndPassword(auth, email, password);
                const newUid = newUserCredential.user.uid;
                console.log("User created in Firebase Auth with UID:", newUid); // Debugging

                // Set user role in Firestore
                // Use currentAppId for the Firestore path
                const userDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/users`, newUid);
                await firebase.setDoc(userDocRef, {
                    email: email,
                    role: role,
                    createdAt: firebase.serverTimestamp()
                });
                console.log("User role document created in Firestore for UID:", newUid); // Debugging

                showNotification(`User "${email}" added successfully! Admin session changed. Please re-login.`, 'info', 7000);

                // Clear form
                newUserEmailEl.value = '';
                newUserPasswordEl.value = '';
                newUserRoleEl.value = 'user'; // Reset to default
            } catch (error) {
                console.error("Error adding new user:", error);
                let errorMessage = 'Failed to add user. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'The email address is already in use by another account.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'The email address is not valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'The password is too weak. Please choose a stronger password.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your internet connection.';
                } else if (error.code === 'permission-denied') { // Catch Firestore permission errors specifically
                    errorMessage = 'Permission denied. Ensure your Firebase Security Rules allow this operation for your current user role.';
                }
                showMessageBox('User Add Error', errorMessage);
            }
        }


        // --- Initial Setup on Window Load ---
        // Declare FIREBASE_CONFIG globally
        let FIREBASE_CONFIG = {};
        // currentAppId will hold the actual app ID for Firestore paths
        // Initialized here, and its value will be set in window.onload
        let currentAppId = '';


        window.onload = async function() {
            // Ensure Firebase is loaded from the module script
            if (typeof window.firebase === 'undefined') {
                showMessageBox('Error', 'Firebase SDK not loaded. Please try refreshing the page.');
                return;
            }

            // Assign DOM elements here to ensure they are available
            appContentWrapperEl = document.getElementById('app-content-wrapper'); // Get the new wrapper
            inventoryListEl = document.getElementById('inventory-list');
            cartListEl = document.getElementById('cart-list');
            emptyCartMessageEl = document.getElementById('empty-cart-message');
            subtotalEl = document.getElementById('subtotal');
            totalEl = document.getElementById('total');
            inventorySearchEl = document.getElementById('inventory-search');
            checkoutButtonEl = document.getElementById('checkout-button');
            clearCartButtonEl = document.getElementById('clear-cart-button'); // Get the new clear cart button
            emptyInventoryMessageEl = document.getElementById('empty-inventory-message'); // Get new element
            categoryFilterEl = document.getElementById('category-filter'); // Get new category filter

            tabInventoryBtn = document.getElementById('tab-inventory');
            tabManageProductsBtn = document.getElementById('tab-manage-products');
            tabInventoryMasterBtn = document.getElementById('tab-inventory-master');
            tabReportLogsBtn = document.getElementById('tab-report-logs');
            tabSalesReportBtn = document.getElementById('tab-sales-report');
            tabCouponManagementBtn = document.getElementById('tab-coupon-management'); // Get coupon tab button
            tabUserManagementBtn = document.getElementById('tab-user-management'); // User Management tab

            inventoryContentEl = document.getElementById('inventory-content');
            inventoryMasterContentEl = document.getElementById('inventory-master-content');
            masterListEl = document.getElementById('master-list');
            masterListSearchEl = document.getElementById('master-list-search');
            masterListLoadingEl = document.getElementById('master-list-loading');

            reportLogsContentEl = document.getElementById('report-logs-content');
            salesLogListEl = document.getElementById('sales-log-list');
            emptyLogsMessageEl = document.getElementById('empty-logs-message');
            inventoryLoadingEl = document.getElementById('inventory-loading');
            salesLogLoadingEl = document.getElementById('sales-log-loading');
            // userIdDisplayEl = document.getElementById('user-id-display'); // Removed as per user request

            messageBoxContainerEl = document.getElementById('message-box-container');
            messageBoxTitleEl = document.getElementById('message-box-title');
            messageBoxTextEl = document.getElementById('message-box-text');
            messageBoxOkBtn = document.getElementById('message-box-ok');
            messageBoxCancelBtn = document.getElementById('message-box-cancel');

            notificationContainerEl = document.getElementById('notification-container'); // Get notification container
            notificationBellEl = document.getElementById('notification-bell'); // Get bell icon
            notificationCountBadgeEl = document.getElementById('notification-count-badge'); // Get badge
            lowStockModalContainerEl = document.getElementById('low-stock-modal-container'); // Get low stock modal
            lowStockModalCloseBtn = document.getElementById('low-stock-modal-close-btn'); // Get low stock modal close button
            lowStockListEl = document.getElementById('low-stock-list'); // Get low stock list
            emptyLowStockMessageEl = document.getElementById('empty-low-stock-message'); // Get empty low stock message


            manageProductModalContainer = document.getElementById('manage-product-modal-container');
            manageProductModalCloseBtn = document.getElementById('manage-product-modal-close-btn');

            modalTabAddProductBtn = document.getElementById('modal-tab-add-product');
            modalTabRestockProductBtn = document.getElementById('modal-tab-restock-product');

            modalAddProductContent = document.getElementById('modal-add-product-content');
            modalRestockProductContent = document.getElementById('modal-restock-product-content');

            modalNewProductNameEl = document.getElementById('modal-new-product-name');
            modalNewProductCategoryEl = document.getElementById('modal-new-product-category'); // Get category input
            modalNewProductPriceEl = document.getElementById('modal-new-product-price');
            modalNewProductStockEl = document.getElementById('modal-new-product-stock');
            modalNewProductRestockLevelEl = document.getElementById('modal-new-product-restock-level');
            modalNewProductImageUrlEl = document.getElementById('modal-new-product-image-url'); // Get URL input
            modalImagePreviewEl = document.getElementById('modal-image-preview');
            modalAddProductBtn = document.getElementById('modal-add-product-btn');

            modalRestockSearchEl = document.getElementById('modal-restock-search');
            modalRestockListEl = document.getElementById('modal-restock-list');
            modalApplyRestockBtn = document.getElementById('modal-apply-restock-btn');

            editProductDetailsModalContainer = document.getElementById('edit-product-details-modal-container');
            editProductDetailsModalCloseBtn = document.getElementById('edit-product-details-modal-close-btn');
            editProductNameEl = document.getElementById('edit-product-name');
            editProductCategoryEl = document.getElementById('edit-product-category'); // Get category input
            editProductPriceEl = document.getElementById('edit-product-price');
            editProductStockEl = document.getElementById('edit-product-stock');
            editProductRestockLevelEl = document.getElementById('edit-product-restock-level');
            editProductImageUrlEl = document.getElementById('edit-product-image-url'); // Get URL input
            editImagePreviewEl = document.getElementById('edit-image-preview');
            editProductSaveBtn = document.getElementById('edit-product-save-btn');

            saleSummaryModalContainer = document.getElementById('sale-summary-modal-container');
            saleSummaryModalCloseBtn = document.getElementById('sale-summary-modal-close-btn');
            customerNameEl = document.getElementById('customer-name');
            customerAddressEl = document.getElementById('customer-address');
            customerContactEl = document.getElementById('customer-contact');
            saleSummaryItemsListEl = document.getElementById('sale-summary-items-list');
            summarySubtotalEl = document.getElementById('summary-subtotal');
            summaryTotalEl = document.getElementById('summary-total');
            saleSummaryCancelBtn = document.getElementById('sale-summary-cancel-btn');
            saleSummaryCheckoutBtn = document.getElementById('sale-summary-checkout-btn');
            summaryAppliedDiscountEl = document.getElementById('summary-applied-discount'); // Get summary discount

            receiptModalContainer = document.getElementById('receipt-modal-container');
            receiptModalContentTemplate = document.getElementById('receipt-modal-content');
            // activeReceiptPrintBtn and activeReceiptNewSaleBtn are assigned dynamically
            receiptCloseBtn = document.getElementById('receipt-close-btn');
            receiptDiscountEl = document.getElementById('receipt-discount'); // Get receipt discount
            receiptDiscountRowEl = document.getElementById('receipt-discount-row'); // Get receipt discount row

            salesReportContentEl = document.getElementById('sales-report-content');
            filterDailyBtn = document.getElementById('filter-daily');
            filterWeeklyBtn = document.getElementById('filter-weekly');
            filterMonthlyBtn = document.getElementById('filter-monthly');
            reportTotalSalesEl = document.getElementById('report-total-sales');
            reportPeriodInfoEl = document.getElementById('report-period-info');
            // Ensure this element is correctly identified and present in the HTML
            reportDetailsListEl = document.getElementById('report-details-list');
            emptyReportMessageEl = document.getElementById('empty-report-message');
            emptyItemsSummaryMessageEl = document.getElementById('empty-items-summary-message');
            emptyDetailsListMessageEl = document.getElementById('empty-details-list-message'); // Get new element
            downloadReportPdfBtn = document.getElementById('download-report-pdf');
            reportItemsSummaryEl = document.getElementById('report-items-summary');

            // New elements for login/logout and user management
            loginLogoutButtonEl = document.getElementById('login-logout-button');
            loginModalContainerEl = document.getElementById('login-modal-container');
            loginEmailEl = document.getElementById('login-email');
            loginPasswordEl = document.getElementById('login-password');
            loginSubmitBtnEl = document.getElementById('login-submit-btn');
            currentUserRoleEl = document.getElementById('current-user-role');
            userManagementContentEl = document.getElementById('user-management-content');
            newUserEmailEl = document.getElementById('new-user-email');
            newUserPasswordEl = document.getElementById('new-user-password');
            newUserRoleEl = document.getElementById('new-user-role');
            addNewUserBtnEl = document.getElementById('add-new-user-btn');

            // New coupon application elements
            couponCodeInputEl = document.getElementById('coupon-code-input');
            applyCouponBtn = document.getElementById('apply-coupon-btn');
            couponStatusMessageEl = document.getElementById('coupon-status-message');
            appliedDiscountEl = document.getElementById('applied-discount');
            appliedDiscountDisplayRowEl = document.getElementById('applied-discount-display-row'); // The div for discount row

            // New coupon creation elements
            couponManagementContentEl = document.getElementById('coupon-management-content');
            newCouponCodeEl = document.getElementById('new-coupon-code');
            newCouponTypeEl = document.getElementById('new-coupon-type');
            newCouponValueEl = document.getElementById('new-coupon-value');
            newCouponValidFromEl = document.getElementById('new-coupon-valid-from');
            newCouponValidUntilEl = document.getElementById('new-coupon-valid-until');
            newCouponUsageLimitEl = document.getElementById('new-coupon-usage-limit');
            createNewCouponBtn = document.getElementById('create-new-coupon-btn');
            existingCouponsListEl = document.getElementById('existing-coupons-list');
            emptyCouponsMessageEl = document.getElementById('empty-coupons-message');

            // Assign new user management DOM elements
            userListEl = document.getElementById('user-list');
            emptyUsersMessageEl = document.getElementById('empty-users-message');
            userListLoadingEl = document.getElementById('user-list-loading');
            editUserRoleModalContainer = document.getElementById('edit-user-role-modal-container');
            editUserRoleModalCloseBtn = document.getElementById('edit-user-role-modal-close-btn');
            editUserEmailDisplayEl = document.getElementById('edit-user-email-display');
            editUserRoleSelectEl = document.getElementById('edit-user-role-select');
            saveUserRoleBtn = document.getElementById('save-user-role-btn');


            // Set FIREBASE_CONFIG - IMPORTANT: Use your actual Firebase config here for external deployment
            FIREBASE_CONFIG = {
                apiKey: "AIzaSyAuuXHxkDxnYISS8GZOQQac9-r23LCB7wM",
                authDomain: "motoshop-f5b85.firebaseapp.com",
                projectId: "motoshop-f5b85",
                storageBucket: "motoshop-f5b85.firebasestorage.app",
                messagingSenderId: "384660348802",
                appId: "1:384660348802:web:f7193b62ccdaa95e15799b",
                measurementId: "G-R9CLFFMPRS"
            };

            // Determine the app ID to use for Firestore paths
            // Prefer __app_id for Canvas environment, fallback to FIREBASE_CONFIG.projectId for external deployment.
            currentAppId = typeof __app_id !== 'undefined' ? __app_id : FIREBASE_CONFIG.projectId;

            const firebaseConfigForInit = (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) ? JSON.parse(__firebase_config) : FIREBASE_CONFIG;
            // The __initial_auth_token is no longer used for auto-login in this mandatory login flow.
            // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


            try {
                firebaseApp = window.firebase.initializeApp(firebaseConfigForInit);
                auth = window.firebase.getAuth(firebaseApp);
                db = window.firebase.getFirestore(firebaseApp);
                isFirebaseReady = true; // Firebase is initialized

                // Always show the login modal first
                openLoginModal();
                appContentWrapperEl.classList.add('hidden'); // Ensure main content is hidden

                // Authenticate user listener
                window.firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Hiding user ID display as per user request
                        // userIdDisplayEl.textContent = `User ID: ${userId}`;

                        // Fetch user's role from Firestore
                        // Use currentAppId for the Firestore path
                        const userDocRef = firebase.doc(db, `artifacts/${currentAppId}/public/data/users`, userId);
                        try {
                            const userDocSnap = await firebase.getDoc(userDocRef);
                            if (userDocSnap.exists()) {
                                userRole = userDocSnap.data().role;
                            } else {
                                // Default to 'user' if role document is not found (e.g., new user created externally)
                                userRole = 'user';
                                // Optionally, create the role document for newly logged-in users if it doesn't exist
                                await firebase.setDoc(userDocRef, {
                                    email: user.email,
                                    role: userRole,
                                    createdAt: firebase.serverTimestamp()
                                }, { merge: true }); // Merge to avoid overwriting if partial data exists
                            }
                            console.log(`User ${user.email} (UID: ${user.uid}) logged in with role: ${userRole}`); // Added for debugging
                        } catch (firestoreError) {
                            console.error("Error fetching user role from Firestore:", firestoreError);
                            showMessageBox('Profile Error', 'Could not load user profile. Some features may be restricted.');
                            userRole = 'user'; // Fallback to basic user role
                        }

                        // User is logged in, show the main app and hide the login modal
                        closeLoginModal();
                        setupFirestoreListeners(); // Start listening to Firestore changes after auth is ready
                        updateUIForUserRole();
                        // Switch to inventory after login
                        switchMainTab('inventory');

                    } else {
                        // User is signed out or no user is logged in
                        userId = 'Not Logged In';
                        userRole = 'guest'; // Reset role to guest
                        // Hiding user ID display as per user request
                        // userIdDisplayEl.textContent = `User ID: ${userId}`;
                        console.log('User logged out. Role reset to guest.'); // Added for debugging

                        // Hide main app content and show login modal
                        appContentWrapperEl.classList.add('hidden');
                        openLoginModal();
                        updateUIForUserRole();

                        // Unsubscribe from Firestore listeners if user logs out
                        if (inventoryUnsubscribe) inventoryUnsubscribe();
                        if (salesLogsUnsubscribe) salesLogsUnsubscribe();
                        if (couponsUnsubscribe) couponsUnsubscribe(); // Unsubscribe coupons too
                        if (usersUnsubscribe) usersUnsubscribe(); // New: Unsubscribe users too
                        // Clear data when logged out
                        inventory = [];
                        cart = [];
                        salesLogs = [];
                        coupons = []; // Clear coupons
                        users = []; // Clear users
                        lowStockItems = []; // Clear low stock items on logout
                        notificationCountBadgeEl.classList.add('hidden'); // Hide badge
                        appliedCoupon = null; // Clear applied coupon
                        couponCodeInputEl.value = ''; // Clear coupon input
                        couponStatusMessageEl.textContent = ''; // Clear coupon message
                        renderInventory();
                        renderCart();
                        renderReportLogs();
                        renderSalesReport();
                        renderCoupons(); // Re-render coupons (will show empty message)
                        renderUsers(); // Re-render users (will show empty message)
                    }
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showMessageBox('Initialization Error', 'Failed to initialize Firebase. Please check your configuration and internet connection.');
                // Hiding user ID display as per user request
                // userIdDisplayEl.textContent = `User ID: Not Available`;
            }

            // Event Listeners - Now assigned after DOM elements are available
            inventorySearchEl.addEventListener('input', () => {
                renderInventory(getFilteredInventory());
            });

            // Category filter listener
            categoryFilterEl.addEventListener('change', () => {
                renderInventory(getFilteredInventory());
            });

            masterListSearchEl.addEventListener('input', () => {
                renderMasterList(getFilteredMasterList());
            });

            checkoutButtonEl.addEventListener('click', initiateCheckout);
            clearCartButtonEl.addEventListener('click', clearCart); // New: Clear Cart button listener

            // Main Tab button event listeners
            tabInventoryBtn.addEventListener('click', () => switchMainTab('inventory'));
            tabManageProductsBtn.addEventListener('click', () => switchMainTab('manage-products'));
            tabInventoryMasterBtn.addEventListener('click', () => switchMainTab('inventory-master'));
            tabReportLogsBtn.addEventListener('click', () => switchMainTab('report-logs'));
            tabSalesReportBtn.addEventListener('click', () => switchMainTab('sales-report')); // New sales report tab listener
            tabCouponManagementBtn.addEventListener('click', () => switchMainTab('coupon-management')); // New coupon management tab listener
            tabUserManagementBtn.addEventListener('click', () => switchMainTab('user-management')); // User Management tab listener

            // Login/Logout button listener
            loginLogoutButtonEl.addEventListener('click', () => {
                if (auth.currentUser) { // If there's any authenticated user
                    handleLogout();
                } else {
                    openLoginModal();
                }
            });

            // Login modal submit listener
            loginSubmitBtnEl.addEventListener('click', handleLogin);

            // Manage Products Modal event listeners
            manageProductModalCloseBtn.addEventListener('click', closeManageProductModal);
            modalTabAddProductBtn.addEventListener('click', () => switchModalTab('add-product'));
            modalTabRestockProductBtn.addEventListener('click', () => switchModalTab('restock-product'));
            modalAddProductBtn.addEventListener('click', addNewProduct);
            modalNewProductImageUrlEl.addEventListener('input', (event) => { // Listen to input for URL
                const url = event.target.value.trim();
                if (url) {
                    modalImagePreviewEl.src = url;
                    modalImagePreviewEl.classList.remove('hidden');
                } else {
                    modalImagePreviewEl.src = '';
                    modalImagePreviewEl.classList.add('hidden');
                }
            });

            // Restock Product listeners (inside Manage Products Modal)
            modalRestockSearchEl.addEventListener('input', () => {
                renderModalRestockList(inventory); // Pass current inventory for filtering
            });
            modalApplyRestockBtn.addEventListener('click', applyRestock);

            // Edit Product Details Modal listeners
            editProductDetailsModalCloseBtn.addEventListener('click', closeEditProductDetailsModal);
            editProductSaveBtn.addEventListener('click', saveEditedProduct);
            editProductImageUrlEl.addEventListener('input', (event) => { // Listen to input for URL
                const url = event.target.value.trim();
                if (url) {
                    editImagePreviewEl.src = url;
                    editImagePreviewEl.classList.remove('hidden');
                } else {
                    editImagePreviewEl.src = '';
                    editImagePreviewEl.classList.add('hidden');
                }
            });


            // Sale Summary Modal event listeners
            saleSummaryModalCloseBtn.addEventListener('click', closeSaleSummaryModal);
            saleSummaryCancelBtn.addEventListener('click', closeSaleSummaryModal);
            saleSummaryCheckoutBtn.addEventListener('click', finalizeSale);

            // Coupon application listeners
            applyCouponBtn.addEventListener('click', applyCoupon);
            couponCodeInputEl.addEventListener('input', () => {
                // Clear status message as user types
                couponStatusMessageEl.textContent = '';
                appliedDiscountDisplayRowEl.classList.add('hidden');
            });
            // Also trigger applyCoupon if user hits Enter in the coupon input
            couponCodeInputEl.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent form submission
                    applyCoupon();
                }
            });

            // Sales Report Filter Buttons
            filterDailyBtn.addEventListener('click', () => {
                currentReportFilter = 'daily';
                document.querySelectorAll('#sales-report-content button').forEach(btn => btn.classList.remove('active'));
                filterDailyBtn.classList.add('active');
                renderSalesReport();
            });
            filterWeeklyBtn.addEventListener('click', () => {
                currentReportFilter = 'weekly';
                document.querySelectorAll('#sales-report-content button').forEach(btn => btn.classList.remove('active'));
                filterWeeklyBtn.classList.add('active');
                renderSalesReport();
            });
            filterMonthlyBtn.addEventListener('click', () => {
                currentReportFilter = 'monthly';
                document.querySelectorAll('#sales-report-content button').forEach(btn => btn.classList.remove('active'));
                filterMonthlyBtn.classList.add('active');
                renderSalesReport();
            });
            downloadReportPdfBtn.addEventListener('click', generatePdfReport);

            // Coupon Management listeners
            createNewCouponBtn.addEventListener('click', createCoupon);

            // User Management Listener
            addNewUserBtnEl.addEventListener('click', addNewUser);
            editUserRoleModalCloseBtn.addEventListener('click', closeEditUserRoleModal); // Close user role edit modal
            saveUserRoleBtn.addEventListener('click', saveEditedUserRole); // Save user role

            // Notification Bell listeners
            notificationBellEl.addEventListener('click', openLowStockModal);
            lowStockModalCloseBtn.addEventListener('click', closeLowStockModal);

            // Initial renders (these will be empty/default until login occurs and data loads)
            renderCart();
            filterDailyBtn.classList.add('active'); // Set daily as default active filter for sales report
            updateUIForUserRole(); // Initial UI update based on default role (guest)
        };
    </script>
</body>
</html>
