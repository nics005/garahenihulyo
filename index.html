<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garahe ni Hulyo POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom scrollbar for a metallic look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* Dark gray for track */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* Medium gray for thumb */
            border-radius: 4px;
            border: 1px solid #374151; /* Darker border */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter gray on hover */
        }

        body {
            font-family: "Inter", sans-serif;
            background-color: #1a202c; /* Darker background to match the overall theme */
        }

        /* Styles for active tab button */
        .tab-button.active {
            background-color: #3b82f6; /* Blue-600 */
            color: #ffffff;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
        }

        /* Styles for modal internal tab button */
        .modal-tab-button.active {
            background-color: #3b82f6; /* Blue-600 */
            color: #ffffff;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
        }

        /* Loading spinner styles */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Adjust main container to fill screen and use grid for layout */
        #main-app-container {
            display: grid;
            grid-template-rows: auto 1fr; /* Header row, then main content row */
            grid-template-columns: 250px 1fr 350px; /* Left sidebar, main content, right sidebar */
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevent overall scrollbars */
        }

        /* Header spans all columns */
        #main-header {
            grid-column: 1 / -1; /* Spans from first to last column line */
            background-color: #1f2937; /* Dark gray */
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #374151; /* Darker border */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10; /* Ensure it stays on top */
        }

        /* Left Sidebar */
        #left-sidebar {
            grid-column: 1;
            grid-row: 2; /* Below the header */
            background-color: #1f2937;
            padding: 1.5rem;
            border-right: 1px solid #374151;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling for navigation if needed */
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 5;
        }

        /* Main Content Area (Inventory) */
        #main-content-area {
            grid-column: 2;
            grid-row: 2;
            background-color: #2d3748; /* Slightly lighter than sidebars */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling for inventory list */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        /* Right Sidebar (Cart) */
        #right-sidebar {
            grid-column: 3;
            grid-row: 2;
            background-color: #1f2937;
            padding: 1.5rem;
            border-left: 1px solid #374151;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling for cart items */
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 5;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            #main-app-container {
                grid-template-rows: auto auto 1fr auto; /* Header, Nav, Main, Cart */
                grid-template-columns: 1fr; /* Single column */
                height: auto; /* Allow natural height for scrolling */
                overflow-y: auto;
            }

            #main-header {
                grid-column: 1;
                grid-row: 1;
                flex-direction: column;
                padding-bottom: 0.5rem;
                border-bottom: none;
                box-shadow: none;
            }

            #left-sidebar {
                grid-column: 1;
                grid-row: 2; /* Below header */
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #374151;
                padding-top: 0.5rem;
                box-shadow: none;
            }

            #main-content-area {
                grid-column: 1;
                grid-row: 3; /* Below left sidebar */
                width: 100%;
                padding-top: 1rem;
                box-shadow: none;
            }

            #right-sidebar {
                grid-column: 1;
                grid-row: 4; /* Below main content */
                width: 100%;
                border-left: none;
                border-top: 1px solid #374151;
                padding-top: 1rem;
                box-shadow: none;
            }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; // NEW: Firebase Storage

        // Expose Firebase objects globally for use in the main script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            createUserWithEmailAndPassword, // Added for admin to create users
            signInWithEmailAndPassword,     // Added for manual login
            signOut,                        // Added for logout
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            addDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            runTransaction,     // Added for transactions (e.g., voiding sale)
            serverTimestamp,    // Added for server timestamps
            getStorage,         // NEW
            ref,                // NEW
            uploadBytes,        // NEW
            getDownloadURL,     // NEW
            deleteObject        // NEW
        };
    </script>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
    <div id="app-content-wrapper" class="hidden"> <div id="main-app-container">

            <header id="main-header">
                <div class="flex items-center space-x-4">
                    <img src="https://scontent.fmnl17-2.fna.fbcdn.net/v/t39.30808-6/432725210_122115657752230587_8420052317826264936_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeFQuix_sgAinwvqEloWRmRrKmfC3maObI8qZ8LeZo5sj8vAQqr_JC9Fpw20JNKdwyGEmKxHmeCS13eK7cNozFC4&_nc_ohc=yXMR9-p-LkAQ7kNvwEGM_iE&_nc_oc=AdkR9Ic0Mv9IkLgZKC9xU5_Me3UPAFxAPa3C_vdUioSCL4JuWwbXHRxqo946zUguqM&_nc_zt=23&_nc_ht=scontent.fmnl17-2.fna&_nc_gid=BW0dXenNjVSN0gfgFBLyNg&oh=00_AfNVOOLzzAt2XcEsqDJf0PXbRUm3bxfLEljZ6djGhEP5uw&oe=68620775" alt="Garahe ni Hulyo Logo" class="rounded-full w-12 h-12 object-cover">
                    <h1 class="text-3xl font-extrabold text-white">Garahe ni Hulyo POS System</h1>
                </div>
                <div class="text-sm text-gray-400 mt-2 md:mt-0">
                    <span id="user-id-display">Not Logged In</span>
                </div>
            </header>

            <div id="left-sidebar">
                <div class="flex flex-col space-y-4 mb-6 bg-gray-800 p-3 rounded-lg shadow-inner border border-gray-700">
                    <button id="tab-inventory" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 active">Dashboard</button>
                    <button id="tab-manage-products" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Manage Products</button>
                    <button id="tab-inventory-master" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Inventory Master</button>
                    <button id="tab-report-logs" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Report Logs</button>
                    <button id="tab-sales-report" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Sales Report</button>
                    <button id="tab-coupon-management" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">Coupon Management</button>
                    <button id="tab-user-management" class="tab-button px-5 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 admin-only">User Management</button>
                </div>

                <div class="mt-auto pt-4 border-t border-gray-700">
                    <p id="current-user-role" class="text-xs text-gray-500 mb-2 text-center">Role: Not Logged In</p>
                    <button id="login-logout-button"
                            class="w-full py-2 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                   focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Login
                    </button>
                </div>
            </div>

            <div id="main-content-area">
                <div id="inventory-content" class="tab-content flex-1 flex flex-col">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">Product Listing</h1>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="inventory-search" placeholder="Search for parts..."
                               class="w-full sm:flex-1 p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                      focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                        <select id="category-filter"
                                class="w-full sm:w-auto p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200
                                       focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <div id="inventory-loading" class="flex justify-center items-center h-full hidden">
                        <div class="spinner"></div>
                        <p class="ml-3 text-gray-400">Loading Inventory...</p>
                    </div>
                    <div id="inventory-list" class="flex-1 overflow-y-auto pr-2">
                        <p class="text-gray-400 text-center py-8" id="empty-inventory-message">No inventory items found. Add some from 'Manage Products'!</p>
                    </div>
                </div>

                <div id="inventory-master-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">Inventory Master List</h1>
                    <div class="mb-6">
                        <input type="text" id="master-list-search" placeholder="Search master list items..."
                               class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                      focus:outline-none focus:ring-2 focus:ring-blue-600 transition duration-200">
                    </div>
                    <div id="master-list-loading" class="flex justify-center items-center h-full hidden">
                        <div class="spinner"></div>
                        <p class="ml-3 text-gray-400">Loading Master List...</p>
                    </div>
                    <div id="master-list" class="flex-1 overflow-y-auto pr-2">
                        </div>
                </div>


                <div id="report-logs-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h3 class="text-2xl font-bold text-white mb-4 text-center">Sales Report Logs</h3>
                    <div id="sales-log-loading" class="flex justify-center items-center h-full hidden">
                        <div class="spinner"></div>
                        <p class="ml-3 text-gray-400">Loading Sales Logs...</p>
                    </div>
                    <div id="sales-log-list" class="flex-1 overflow-y-auto pr-2">
                        <p class="text-gray-400 text-center py-8" id="empty-logs-message">No sales records available yet.</p>
                    </div>
                </div>

                <div id="sales-report-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h3 class="text-2xl font-bold text-white mb-4 text-center">Total Sales Report</h3>
                    <div class="flex justify-center space-x-4 mb-6">
                        <button id="filter-daily" class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 active">Daily</button>
                        <button id="filter-weekly" class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600">Weekly</button>
                        <button id="filter-monthly" class="px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600">Monthly</button>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6 text-center">
                        <h4 class="text-xl font-semibold text-blue-300 mb-2">Total Sales for Period:</h4>
                        <span id="report-total-sales" class="text-4xl font-extrabold text-white">₱0.00</span>
                        <p id="report-period-info" class="text-gray-400 text-sm mt-2"></p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6 flex-1 overflow-y-auto">
                        <h4 class="text-xl font-semibold text-blue-300 mb-4">Items Sold Summary:</h4>
                        <div id="report-items-summary">
                            <p class="text-gray-400 text-center py-8" id="empty-items-summary-message">No items sold in this period.</p>
                        </div>
                    </div>

                    <div id="report-details-list" class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6 flex-1 overflow-y-auto">
                        <p class="text-gray-400 text-center py-8" id="empty-details-list-message">No individual sales data for this period.</p>
                    </div>

                    <button id="download-report-pdf"
                            class="w-full py-3 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105 mt-6
                                   focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Download Report (PDF)
                    </button>
                </div>

                <div id="coupon-management-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">Coupon Management</h1>
                    <div class="mb-6 p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Create New Coupon</h3>
                        <div class="mb-4">
                            <label for="new-coupon-code" class="block text-gray-300 text-sm font-bold mb-2">Coupon Code:</label>
                            <input type="text" id="new-coupon-code" placeholder="e.g., SAVE10, FREESHIP"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-4">
                            <label for="new-coupon-type" class="block text-gray-300 text-sm font-bold mb-2">Discount Type:</label>
                            <select id="new-coupon-type"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="fixed">Fixed Amount (₱)</option>
                                <option value="percentage">Percentage (%)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="new-coupon-value" class="block text-gray-300 text-sm font-bold mb-2">Discount Value:</label>
                            <input type="number" id="new-coupon-value" min="0" step="0.01" placeholder="e.g., 10.00 or 5"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-4">
                            <label for="new-coupon-valid-from" class="block text-gray-300 text-sm font-bold mb-2">Valid From:</label>
                            <input type="date" id="new-coupon-valid-from"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-6">
                            <label for="new-coupon-valid-until" class="block text-gray-300 text-sm font-bold mb-2">Valid Until:</label>
                            <input type="date" id="new-coupon-valid-until"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-6">
                            <label for="new-coupon-usage-limit" class="block text-gray-300 text-sm font-bold mb-2">Usage Limit (0 for unlimited):</label>
                            <input type="number" id="new-coupon-usage-limit" min="0" value="0"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <button id="create-new-coupon-btn"
                                class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                                       rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                       focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Create Coupon
                        </button>
                    </div>

                    <div class="p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700 flex-1 overflow-y-auto">
                        <h3 class="text-xl font-bold text-white mb-4">Existing Coupons</h3>
                        <div id="existing-coupons-list">
                            <p class="text-gray-400 text-center py-8" id="empty-coupons-message">No coupons created yet.</p>
                            </div>
                    </div>
                </div>

                <div id="user-management-content" class="tab-content hidden flex-1 flex-col admin-only-content">
                    <h1 class="text-3xl font-bold text-white mb-6 text-center">User Management</h1>
                    <div class="mb-6 p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold text-white mb-4">Add New User</h3>
                        <div class="mb-4">
                            <label for="new-user-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="new-user-email" placeholder="user@example.com"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-4">
                            <label for="new-user-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                            <input type="password" id="new-user-password" placeholder="Min 6 characters"
                                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                        <div class="mb-6">
                            <label for="new-user-role" class="block text-gray-300 text-sm font-bold mb-2">Role:</label>
                            <select id="new-user-role"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-600">
                                <option value="user">User</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <button id="add-new-user-btn"
                                class="w-full py-3 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold
                                       rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                       focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Add User
                        </button>
                    </div>

                    <div class="p-6 bg-gray-800 rounded-lg shadow-md border border-gray-700 flex-1 overflow-y-auto">
                        <h3 class="text-xl font-bold text-white mb-4">Existing Users</h3>
                        <div id="existing-users-list" class="overflow-x-auto">
                            <p class="text-gray-400 text-center py-8" id="empty-users-message">No users found.</p>
                            </div>
                    </div>
                </div>

            </div>

            <div id="right-sidebar">
                <h1 class="text-3xl font-bold text-white mb-6 text-center">Cart List</h1>

                <div id="cart-list" class="flex-1 overflow-y-auto pr-2 mb-6">
                    <p id="empty-cart-message" class="text-gray-400 text-center py-8">Your cart is empty. Add some items!</p>
                </div>

                <div class="border-t border-gray-700 pt-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg text-gray-300">Subtotal:</span>
                        <span id="subtotal" class="text-xl font-semibold text-white">₱0.00</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-2xl font-bold text-blue-400">Total:</span>
                        <span id="total" class="text-3xl font-extrabold text-blue-300">₱0.00</span>
                    </div>

                    <div class="mb-4 p-3 bg-gray-700 rounded-lg border border-gray-600">
                        <label for="coupon-code-input" class="block text-gray-300 text-sm font-bold mb-2">Apply Coupon:</label>
                        <div class="grid grid-cols-5 gap-2">
                            <input type="text" id="coupon-code-input" placeholder="Enter code"
                                   class="col-span-3 p-2 rounded-md bg-gray-800 border border-gray-700 text-gray-200 placeholder-gray-500
                                          focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <button id="apply-coupon-btn"
                                    class="col-span-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 active:bg-blue-700 transition duration-200">
                                Apply
                            </button>
                        </div>
                        <p id="coupon-status-message" class="text-xs mt-2 text-gray-400"></p>
                        <div class="flex justify-between items-center mt-2" id="applied-discount-display-row">
                            <span class="text-md text-gray-300">Discount:</span>
                            <span id="applied-discount" class="text-lg font-semibold text-green-400">₱0.00</span>
                        </div>
                    </div>


                    <button id="checkout-button"
                            class="w-full py-4 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Process Sale
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="message-box-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-96">
            <h3 id="message-box-title" class="text-xl font-bold text-white mb-4"></h3>
            <p id="message-box-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="message-box-cancel" class="px-5 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition duration-200">Cancel</button>
                <button id="message-box-ok" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">OK</button>
            </div>
        </div>
    </div>

    <div id="login-modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 w-96">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Login to Garahe ni Hulyo</h2>
            <div class="mb-4">
                <label for="login-email" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                <input type="email" id="login-email" placeholder="admin@example.com"
                       class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                <input type="password" id="login-password" placeholder="********"
                       class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
            </div>
            <button id="login-submit-btn"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                           rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Login
            </button>
        </div>
    </div>

    <div id="manage-product-modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-2xl h-5/6 flex flex-col">
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                <h2 class="text-2xl font-bold text-white">Manage Products</h2>
                <button id="manage-product-modal-close-btn"
                        class="text-gray-400 hover:text-white text-3xl leading-none font-semibold">
                    &times;
                </button>
            </div>

            <div class="flex justify-center mb-6 bg-gray-700 p-2 rounded-lg shadow-inner border border-gray-600">
                <button id="modal-tab-add-product" class="modal-tab-button px-4 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-600 transition duration-200 active">Add New Product</button>
                <button id="modal-tab-restock" class="modal-tab-button px-4 py-2 rounded-md font-medium text-gray-300 hover:bg-gray-600 transition duration-200">Restock Product</button>
            </div>

            <div id="add-product-form" class="modal-tab-content flex-1 overflow-y-auto pr-2">
                <div class="mb-4">
                    <label for="product-id" class="block text-gray-300 text-sm font-bold mb-2">Product ID (Auto-generated):</label>
                    <input type="text" id="product-id" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200" disabled>
                </div>
                <div class="mb-4">
                    <label for="product-name" class="block text-gray-300 text-sm font-bold mb-2">Product Name:</label>
                    <input type="text" id="product-name" placeholder="e.g., Engine Oil, Brake Pads"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div class="mb-4">
                    <label for="product-category" class="block text-gray-300 text-sm font-bold mb-2">Category:</label>
                    <input type="text" id="product-category" placeholder="e.g., Oils, Brakes, Filters"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div class="mb-4">
                    <label for="product-price" class="block text-gray-300 text-sm font-bold mb-2">Price (₱):</label>
                    <input type="number" id="product-price" min="0" step="0.01" placeholder="e.g., 500.00"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div class="mb-4">
                    <label for="product-stock" class="block text-gray-300 text-sm font-bold mb-2">Initial Stock:</label>
                    <input type="number" id="product-stock" min="0" step="1" placeholder="e.g., 100"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div class="mb-6">
                    <label for="product-image" class="block text-gray-300 text-sm font-bold mb-2">Product Image:</label>
                    <input type="file" id="product-image" accept="image/*"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <p class="text-xs text-gray-400 mt-1">Leave blank to keep existing image during edit.</p>
                </div>
                <button id="add-product-btn"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                               rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                               focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                    Add Product
                </button>
                <button id="update-product-btn"
                        class="w-full py-3 bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold
                               rounded-lg shadow-lg transform transition duration-200 hover:scale-105 mt-4
                               focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800 hidden">
                    Update Product
                </button>
            </div>

            <div id="restock-product-form" class="modal-tab-content hidden flex-1 flex-col overflow-y-auto pr-2">
                <h3 class="text-xl font-bold text-white mb-4">Select Product to Restock</h3>
                <div class="mb-4">
                    <input type="text" id="restock-search-input" placeholder="Search product to restock..."
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                </div>
                <div id="restock-product-list" class="flex-1 overflow-y-auto pr-2 bg-gray-700 rounded-lg p-3">
                    <p class="text-gray-400 text-center py-8" id="empty-restock-message">Search for a product to restock.</p>
                    </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4">Restock Details</h3>
                    <div class="mb-4">
                        <label for="restock-selected-product" class="block text-gray-300 text-sm font-bold mb-2">Selected Product:</label>
                        <input type="text" id="restock-selected-product" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200" disabled>
                        <input type="hidden" id="restock-selected-product-id">
                    </div>
                    <div class="mb-4">
                        <label for="restock-quantity" class="block text-gray-300 text-sm font-bold mb-2">Quantity to Add:</label>
                        <input type="number" id="restock-quantity" min="1" step="1" placeholder="e.g., 50"
                               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-600">
                    </div>
                    <button id="confirm-restock-btn"
                            class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold
                                   rounded-lg shadow-lg transform transition duration-200 hover:scale-105
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Confirm Restock
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for Firebase and data
        let firebaseApp;
        let db;
        let auth;
        let storage; // NEW: Firebase Storage
        let userId = 'guest';
        let userRole = 'guest'; // 'guest', 'user', 'admin'
        let isFirebaseReady = false;

        // Data arrays
        let inventory = [];
        let salesLogs = [];
        let coupons = [];
        let users = []; // NEW: Array to hold user data for management

        // Shopping cart
        let cart = [];
        let appliedCoupon = null; // Stores the currently applied coupon object

        // Counters (should ideally be server-side for true uniqueness in multi-user)
        let productCounter = 1;
        let salesInvoiceCounter = 1001; // Starting invoice ID

        // Unsubscribe functions for real-time listeners
        let inventoryUnsubscribe;
        let salesLogsUnsubscribe;
        let couponsUnsubscribe;
        let usersUnsubscribe; // NEW: For users collection listener

        // Constants
        const TAX_RATE = 0.00; // 0% tax as per user's current setup

        // Elements
        const appContentWrapperEl = document.getElementById('app-content-wrapper');
        const loginModalContainerEl = document.getElementById('login-modal-container');
        const loginEmailEl = document.getElementById('login-email');
        const loginPasswordEl = document.getElementById('login-password');
        const loginSubmitBtnEl = document.getElementById('login-submit-btn');
        const loginLogoutButtonEl = document.getElementById('login-logout-button');
        const currentUserRoleEl = document.getElementById('current-user-role');
        const userIdDisplayEl = document.getElementById('user-id-display');

        // Main Tab Buttons
        const tabInventoryBtn = document.getElementById('tab-inventory');
        const tabManageProductsBtn = document.getElementById('tab-manage-products');
        const tabInventoryMasterBtn = document.getElementById('tab-inventory-master');
        const tabReportLogsBtn = document.getElementById('tab-report-logs');
        const tabSalesReportBtn = document.getElementById('tab-sales-report');
        const tabCouponManagementBtn = document.getElementById('tab-coupon-management');
        const tabUserManagementBtn = document.getElementById('tab-user-management'); // NEW: User Management Tab

        // Main Content Areas
        const inventoryContentEl = document.getElementById('inventory-content');
        const inventoryMasterContentEl = document.getElementById('inventory-master-content');
        const reportLogsContentEl = document.getElementById('report-logs-content');
        const salesReportContentEl = document.getElementById('sales-report-content');
        const couponManagementContentEl = document.getElementById('coupon-management-content');
        const userManagementContentEl = document.getElementById('user-management-content'); // NEW: User Management Content

        // Inventory Elements
        const inventoryListEl = document.getElementById('inventory-list');
        const inventorySearchInputEl = document.getElementById('inventory-search');
        const categoryFilterSelectEl = document.getElementById('category-filter');
        const emptyInventoryMessageEl = document.getElementById('empty-inventory-message');
        const inventoryLoadingEl = document.getElementById('inventory-loading');

        // Cart Elements
        const cartListEl = document.getElementById('cart-list');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        const checkoutButtonEl = document.getElementById('checkout-button');
        const emptyCartMessageEl = document.getElementById('empty-cart-message');
        const couponCodeInputEl = document.getElementById('coupon-code-input');
        const applyCouponBtnEl = document.getElementById('apply-coupon-btn');
        const couponStatusMessageEl = document.getElementById('coupon-status-message');
        const appliedDiscountEl = document.getElementById('applied-discount');
        const appliedDiscountDisplayRowEl = document.getElementById('applied-discount-display-row');


        // Manage Products Modal Elements
        const manageProductModalContainerEl = document.getElementById('manage-product-modal-container');
        const manageProductModalCloseBtn = document.getElementById('manage-product-modal-close-btn');
        const modalTabAddProductBtn = document.getElementById('modal-tab-add-product');
        const modalTabRestockBtn = document.getElementById('modal-tab-restock');
        const addProductFormEl = document.getElementById('add-product-form');
        const restockProductFormEl = document.getElementById('restock-product-form');

        // Add Product Form Elements
        const productIdEl = document.getElementById('product-id');
        const productNameEl = document.getElementById('product-name');
        const productCategoryEl = document.getElementById('product-category');
        const productPriceEl = document.getElementById('product-price');
        const productStockEl = document.getElementById('product-stock');
        const productImageInputEl = document.getElementById('product-image'); // Changed to type="file"
        const addProductBtnEl = document.getElementById('add-product-btn');
        const updateProductBtnEl = document.getElementById('update-product-btn');

        // Restock Product Form Elements
        const restockSearchInputEl = document.getElementById('restock-search-input');
        const restockProductListEl = document.getElementById('restock-product-list');
        const emptyRestockMessageEl = document.getElementById('empty-restock-message');
        const restockSelectedProductEl = document.getElementById('restock-selected-product');
        const restockSelectedProductIdEl = document.getElementById('restock-selected-product-id');
        const restockQuantityEl = document.getElementById('restock-quantity');
        const confirmRestockBtnEl = document.getElementById('confirm-restock-btn');

        // Inventory Master Elements
        const masterListEl = document.getElementById('master-list');
        const masterListSearchInputEl = document.getElementById('master-list-search');
        const masterListLoadingEl = document.getElementById('master-list-loading');

        // Report Logs Elements
        const salesLogListEl = document.getElementById('sales-log-list');
        const emptyLogsMessageEl = document.getElementById('empty-logs-message');
        const salesLogLoadingEl = document.getElementById('sales-log-loading');

        // Sales Report Elements
        const filterDailyBtn = document.getElementById('filter-daily');
        const filterWeeklyBtn = document.getElementById('filter-weekly');
        const filterMonthlyBtn = document.getElementById('filter-monthly');
        const reportTotalSalesEl = document.getElementById('report-total-sales');
        const reportPeriodInfoEl = document.getElementById('report-period-info');
        const reportItemsSummaryEl = document.getElementById('report-items-summary');
        const emptyItemsSummaryMessageEl = document.getElementById('empty-items-summary-message');
        const reportDetailsListEl = document.getElementById('report-details-list'); // For individual sales logs in report
        const emptyDetailsListMessageEl = document.getElementById('empty-details-list-message');
        const downloadReportPdfBtn = document.getElementById('download-report-pdf');
        let currentReportFilter = 'daily'; // Default filter

        // Coupon Management Elements
        const newCouponCodeEl = document.getElementById('new-coupon-code');
        const newCouponTypeEl = document.getElementById('new-coupon-type');
        const newCouponValueEl = document.getElementById('new-coupon-value');
        const newCouponValidFromEl = document.getElementById('new-coupon-valid-from');
        const newCouponValidUntilEl = document.getElementById('new-coupon-valid-until');
        const newCouponUsageLimitEl = document.getElementById('new-coupon-usage-limit');
        const createNewCouponBtn = document.getElementById('create-new-coupon-btn');
        const existingCouponsListEl = document.getElementById('existing-coupons-list');
        const emptyCouponsMessageEl = document.getElementById('empty-coupons-message');

        // User Management Elements (NEW)
        const newUserEmailEl = document.getElementById('new-user-email');
        const newUserPasswordEl = document.getElementById('new-user-password');
        const newUserRoleEl = document.getElementById('new-user-role');
        const addNewUserBtnEl = document.getElementById('add-new-user-btn');
        const existingUsersListEl = document.getElementById('existing-users-list');
        const emptyUsersMessageEl = document.getElementById('empty-users-message');


        // Message Box Elements
        const messageBoxContainerEl = document.getElementById('message-box-container');
        const messageBoxTitleEl = document.getElementById('message-box-title');
        const messageBoxTextEl = document.getElementById('message-box-text');
        const messageBoxOkBtn = document.getElementById('message-box-ok');
        const messageBoxCancelBtn = document.getElementById('message-box-cancel');

        // --- Helper Functions ---

        /**
         * Formats a number as currency (Philippine Peso).
         * @param {number} amount
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-PH', {
                style: 'currency',
                currency: 'PHP'
            }).format(amount);
        }

        /**
         * Formats a number with commas.
         * @param {number} num
         * @returns {string} Formatted number string.
         */
        function formatNumber(num) {
            return new Intl.NumberFormat('en-PH').format(num);
        }

        /**
         * Custom message box/modal for alerts and confirmations.
         * @param {string} title - Title of the message box.
         * @param {string} message - Message content.
         * @param {boolean} isConfirm - If true, show OK and Cancel buttons; otherwise, only OK.
         * @returns {Promise<boolean>} Resolves true for OK, false for Cancel, or true for simple alert.
         */
        function showMessageBox(title, message, isConfirm = false) {
            return new Promise((resolve) => {
                messageBoxTitleEl.textContent = title;
                messageBoxTextEl.textContent = message;
                messageBoxCancelBtn.classList.toggle('hidden', !isConfirm);

                messageBoxOkBtn.onclick = () => {
                    messageBoxContainerEl.classList.add('hidden');
                    resolve(true);
                };

                messageBoxCancelBtn.onclick = () => {
                    messageBoxContainerEl.classList.add('hidden');
                    resolve(false);
                };

                messageBoxContainerEl.classList.remove('hidden');
            });
        }

        /**
         * Debounce function to limit how often a function can run.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // --- UI Rendering Functions ---

        /**
         * Switches the active main tab and displays the corresponding content.
         * @param {string} tabName - The ID of the tab to activate (e.g., 'inventory').
         */
        function switchMainTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content and activate its button
            let targetContent, targetButton;
            if (tabName === 'inventory') {
                targetContent = inventoryContentEl;
                targetButton = tabInventoryBtn;
                renderInventory(); // Re-render inventory when switching to it
            } else if (tabName === 'manage-products') {
                targetContent = null; // Handled by modal
                targetButton = tabManageProductsBtn;
                openManageProductModal(); // Open the modal instead of showing a div
            } else if (tabName === 'inventory-master') {
                targetContent = inventoryMasterContentEl;
                targetButton = tabInventoryMasterBtn;
                renderMasterList(); // Re-render master list
            } else if (tabName === 'report-logs') {
                targetContent = reportLogsContentEl;
                targetButton = tabReportLogsBtn;
                renderReportLogs(); // Re-render report logs
            } else if (tabName === 'sales-report') {
                targetContent = salesReportContentEl;
                targetButton = tabSalesReportBtn;
                renderSalesReport(); // Re-render sales report
            } else if (tabName === 'coupon-management') {
                targetContent = couponManagementContentEl;
                targetButton = tabCouponManagementBtn;
                renderCoupons(); // Re-render coupons
            } else if (tabName === 'user-management') { // NEW: User Management Tab
                targetContent = userManagementContentEl;
                targetButton = tabUserManagementBtn;
                renderUserList(); // Render the user list
            }

            if (targetContent) {
                targetContent.classList.remove('hidden');
                targetContent.classList.add('flex'); // Ensure flex display for its internal layout
            }
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }

        /**
         * Renders the product inventory list for sales.
         */
        function renderInventory() {
            inventoryLoadingEl.classList.remove('hidden'); // Show loading spinner
            inventoryListEl.innerHTML = ''; // Clear current list

            const searchTerm = inventorySearchInputEl.value.toLowerCase();
            const categoryFilter = categoryFilterSelectEl.value;

            const filteredInventory = inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                const matchesCategory = categoryFilter === 'all' || item.category.toLowerCase() === categoryFilter.toLowerCase();
                return matchesSearch && matchesCategory;
            });

            if (filteredInventory.length === 0) {
                emptyInventoryMessageEl.classList.remove('hidden');
            } else {
                emptyInventoryMessageEl.classList.add('hidden');
                filteredInventory.forEach(item => {
                    const productCard = document.createElement('div');
                    productCard.className = `bg-gray-800 rounded-lg shadow-md border border-gray-700 p-4 mb-4 flex items-center space-x-4
                                             transform transition duration-200 hover:scale-102 cursor-pointer`;
                    productCard.dataset.id = item.id;
                    productCard.innerHTML = `
                        <img src="${item.imageUrl || 'https://via.placeholder.com/100x100?text=No+Image'}" alt="${item.name}" class="w-24 h-24 object-cover rounded-md border border-gray-600">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white">${item.name}</h3>
                            <p class="text-gray-400 text-sm">Category: ${item.category}</p>
                            <p class="text-green-400 font-semibold text-lg">₱${item.price.toFixed(2)}</p>
                            <p class="text-yellow-400 text-sm">Stock: ${item.stock}</p>
                        </div>
                        <button class="add-to-cart-btn bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white px-4 py-2 rounded-md font-semibold transition duration-200"
                                data-id="${item.id}">
                            Add to Cart
                        </button>
                    `;
                    inventoryListEl.appendChild(productCard);
                });
            }
            inventoryLoadingEl.classList.add('hidden'); // Hide loading spinner

            // Attach event listeners for 'Add to Cart' buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.dataset.id;
                    addToCart(productId);
                };
            });

            // Update category filter options
            updateCategoryFilterOptions();
        }

        /**
         * Populates the category filter dropdown with unique categories from inventory.
         */
        function updateCategoryFilterOptions() {
            const categories = new Set(inventory.map(item => item.category));
            categoryFilterSelectEl.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.toLowerCase();
                option.textContent = category;
                categoryFilterSelectEl.appendChild(option);
            });
        }

        /**
         * Renders the master list of inventory items for admin management.
         */
        function renderMasterList() {
            masterListLoadingEl.classList.remove('hidden');
            masterListEl.innerHTML = ''; // Clear current list

            const searchTerm = masterListSearchInputEl.value.toLowerCase();

            const filteredMasterList = inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                item.id.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            );

            if (filteredMasterList.length === 0) {
                masterListEl.innerHTML = '<p class="text-gray-400 text-center py-8">No matching products found in master list.</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'w-full table-auto border-collapse border border-gray-600 text-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left border border-gray-600">ID</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Image</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Name</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Category</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Price (₱)</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Stock</th>
                            <th class="px-4 py-2 text-center border border-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');
                filteredMasterList.forEach((item, index) => {
                    const row = tbody.insertRow();
                    row.className = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-900'; // Zebra stripping
                    row.innerHTML = `
                        <td class="px-4 py-2 border border-gray-700 text-left text-sm">${item.id}</td>
                        <td class="px-4 py-2 border border-gray-700"><img src="${item.imageUrl || 'https://via.placeholder.com/50x50?text=No+Image'}" alt="${item.name}" class="w-12 h-12 object-cover rounded"></td>
                        <td class="px-4 py-2 border border-gray-700 text-left">${item.name}</td>
                        <td class="px-4 py-2 border border-gray-700 text-left">${item.category}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right">${item.price.toFixed(2)}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right">${item.stock}</td>
                        <td class="px-4 py-2 border border-gray-700 text-center">
                            <button class="edit-product-btn bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-md text-sm mr-2" data-id="${item.id}">Edit</button>
                            <button class="delete-product-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm" data-id="${item.id}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                masterListEl.appendChild(table);
            }
            masterListLoadingEl.classList.add('hidden');

            // Attach event listeners for edit and delete buttons
            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.dataset.id;
                    editProduct(productId);
                };
            });
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.dataset.id;
                    deleteProduct(productId);
                };
            });
        }


        /**
         * Renders the items in the shopping cart.
         */
        function renderCart() {
            cartListEl.innerHTML = ''; // Clear current cart list
            if (cart.length === 0) {
                emptyCartMessageEl.classList.remove('hidden');
            } else {
                emptyCartMessageEl.classList.add('hidden');
                cart.forEach(item => {
                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'flex items-center space-x-4 bg-gray-700 p-3 rounded-lg shadow-sm mb-3';
                    cartItemEl.innerHTML = `
                        <img src="${item.imageUrl || 'https://via.placeholder.com/60x60?text=No+Image'}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md border border-gray-600">
                        <div class="flex-1">
                            <h3 class="text-md font-semibold text-white">${item.name}</h3>
                            <p class="text-gray-400 text-sm">₱${item.price.toFixed(2)} x ${item.quantity}</p>
                            <p class="text-green-400 font-bold">₱${(item.price * item.quantity).toFixed(2)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="update-cart-qty-btn bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded-md text-lg" data-id="${item.id}" data-action="decrease">-</button>
                            <span class="text-white font-medium">${item.quantity}</span>
                            <button class="update-cart-qty-btn bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded-md text-lg" data-id="${item.id}" data-action="increase">+</button>
                            <button class="remove-from-cart-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-lg" data-id="${item.id}">&times;</button>
                        </div>
                    `;
                    cartListEl.appendChild(cartItemEl);
                });
            }
            calculateTotals();

            // Attach listeners
            document.querySelectorAll('.update-cart-qty-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.dataset.id;
                    const action = e.target.dataset.action;
                    if (action === 'increase') {
                        updateCartQuantity(productId, 1);
                    } else {
                        updateCartQuantity(productId, -1);
                    }
                };
            });
            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.dataset.id;
                    removeFromCart(productId);
                };
            });
        }

        /**
         * Renders the list of sales logs in the 'Report Logs' tab.
         */
        function renderReportLogs() {
            salesLogLoadingEl.classList.remove('hidden');
            salesLogListEl.innerHTML = ''; // Clear current list

            if (salesLogs.length === 0) {
                emptyLogsMessageEl.classList.remove('hidden');
            } else {
                emptyLogsMessageEl.classList.add('hidden');
                const sortedSalesLogs = [...salesLogs].sort((a, b) => {
                    const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateB - dateA; // Sort by most recent first
                });

                sortedSalesLogs.forEach(log => {
                    const logDate = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleString();
                    const logStatus = log.isVoided ? `<span class="text-red-500 font-bold">VOIDED</span>` : `<span class="text-green-500 font-bold">COMPLETED</span>`;
                    const logDetails = log.items.map(item => `${item.name} (x${item.quantity})`).join(', ');

                    const logCard = document.createElement('div');
                    logCard.className = `bg-gray-800 rounded-lg shadow-md border border-gray-700 p-4 mb-4`;
                    logCard.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-white">${log.salesInvoiceId}</h3>
                            <span class="text-sm text-gray-400">${logDate}</span>
                        </div>
                        <p class="text-gray-300 mb-2">Customer: ${log.customerName || 'N/A'}</p>
                        <p class="text-gray-300 mb-2">Items: ${logDetails}</p>
                        <p class="text-blue-400 font-semibold text-lg">Total: ${formatCurrency(log.total)}</p>
                        <p class="text-gray-300">Status: ${logStatus}</p>
                        <div class="mt-3 flex justify-end space-x-2">
                            <button class="view-receipt-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm" data-id="${log.id}">View Receipt</button>
                            ${!log.isVoided && userRole === 'admin' ? `
                                <button class="void-sale-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm" data-id="${log.id}">Void Sale</button>
                            ` : ''}
                        </div>
                    `;
                    salesLogListEl.appendChild(logCard);
                });
            }
            salesLogLoadingEl.classList.add('hidden');

            // Attach event listeners for 'View Receipt' and 'Void Sale'
            document.querySelectorAll('.view-receipt-btn').forEach(button => {
                button.onclick = (e) => {
                    const salesId = e.target.dataset.id;
                    viewReceipt(salesId);
                };
            });

            document.querySelectorAll('.void-sale-btn').forEach(button => {
                button.onclick = (e) => {
                    const salesId = e.target.dataset.id;
                    voidSale(salesId);
                };
            });
        }

        /**
         * Renders the coupon list in the 'Coupon Management' tab.
         */
        function renderCoupons() {
            existingCouponsListEl.innerHTML = '';
            if (coupons.length === 0) {
                emptyCouponsMessageEl.classList.remove('hidden');
            } else {
                emptyCouponsMessageEl.classList.add('hidden');
                coupons.sort((a, b) => (a.code > b.code ? 1 : -1)).forEach(coupon => {
                    const validFrom = new Date(coupon.validFrom).toLocaleDateString();
                    const validUntil = new Date(coupon.validUntil).toLocaleDateString();
                    const isActive = coupon.isActive ? 'Active' : 'Inactive';
                    const statusColor = coupon.isActive ? 'text-green-400' : 'text-red-400';
                    const usageInfo = coupon.usageLimit > 0 ? `Used: ${coupon.usedCount}/${coupon.usageLimit}` : 'Unlimited Use';
                    const discountValue = coupon.type === 'fixed' ? formatCurrency(coupon.value) : `${coupon.value}%`;

                    const couponCard = document.createElement('div');
                    couponCard.className = `bg-gray-700 rounded-lg shadow-sm border border-gray-600 p-4 mb-3`;
                    couponCard.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-white">${coupon.code}</h3>
                            <span class="${statusColor} font-semibold">${isActive}</span>
                        </div>
                        <p class="text-gray-300">Type: ${coupon.type === 'fixed' ? 'Fixed Amount' : 'Percentage'}</p>
                        <p class="text-gray-300">Discount: ${discountValue}</p>
                        <p class="text-gray-300 text-sm">Valid: ${validFrom} - ${validUntil}</p>
                        <p class="text-gray-300 text-sm">${usageInfo}</p>
                        <div class="mt-3 flex justify-end space-x-2">
                            <button class="toggle-coupon-status-btn bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-md text-sm" data-id="${coupon.id}" data-status="${coupon.isActive}">
                                ${coupon.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="delete-coupon-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm" data-id="${coupon.id}">Delete</button>
                        </div>
                    `;
                    existingCouponsListEl.appendChild(couponCard);
                });

                document.querySelectorAll('.toggle-coupon-status-btn').forEach(button => {
                    button.onclick = async (e) => {
                        const couponId = e.target.dataset.id;
                        const currentStatus = e.target.dataset.status === 'true';
                        await toggleCouponStatus(couponId, !currentStatus);
                    };
                });
                document.querySelectorAll('.delete-coupon-btn').forEach(button => {
                    button.onclick = async (e) => {
                        const couponId = e.target.dataset.id;
                        await deleteCoupon(couponId);
                    };
                });
            }
        }

        /**
         * Renders the sales summary and details for the selected report period.
         */
        function renderSalesReport() {
            reportItemsSummaryEl.innerHTML = ''; // Clear previous summary
            reportDetailsListEl.innerHTML = ''; // Clear previous individual sales logs

            emptyItemsSummaryMessageEl.classList.remove('hidden');
            emptyDetailsListMessageEl.classList.remove('hidden');

            let filteredSales = [];
            const now = new Date();
            let periodText = '';

            // Filter out voided sales for reporting totals and item summary
            const nonVoidedSales = salesLogs.filter(log => !log.isVoided);

            if (currentReportFilter === 'daily') {
                periodText = `Today (${now.toLocaleDateString()})`;
                filteredSales = nonVoidedSales.filter(log => {
                    const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp); // Handle Firestore Timestamp objects
                    return logDate.toDateString() === now.toDateString();
                });
            } else if (currentReportFilter === 'weekly') {
                // Get the start of the current week (Sunday)
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                startOfWeek.setHours(0, 0, 0, 0);

                // Get the end of the current week (Saturday)
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);

                periodText = `This Week (${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()})`;
                filteredSales = nonVoidedSales.filter(log => {
                    const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    return logDate >= startOfWeek && logDate <= endOfWeek;
                });
            } else if (currentReportFilter === 'monthly') {
                // Get the start of the current month
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);

                // Get the end of the current month
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                endOfMonth.setHours(23, 59, 59, 999);

                periodText = `This Month (${startOfMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})`;
                filteredSales = nonVoidedSales.filter(log => {
                    const logDate = log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                    return logDate >= startOfMonth && logDate <= endOfMonth;
                });
            }

            // Calculate total sales for the filtered period
            const totalSales = filteredSales.reduce((sum, log) => sum + log.total, 0);
            reportTotalSalesEl.textContent = formatCurrency(totalSales);
            reportPeriodInfoEl.textContent = periodText;

            // Aggregate item sales for the summary
            const aggregatedItems = {}; // { productId: { name, quantity, totalRevenue } }
            filteredSales.forEach(log => {
                log.items.forEach(item => {
                    if (!aggregatedItems[item.id]) {
                        aggregatedItems[item.id] = { name: item.name, quantity: 0, totalRevenue: 0 };
                    }
                    aggregatedItems[item.id].quantity += item.quantity;
                    aggregatedItems[item.id].totalRevenue += (item.price * item.quantity);
                });
            });

            const sortedAggregatedItems = Object.values(aggregatedItems).sort((a, b) => b.totalRevenue - a.totalRevenue);

            // Display aggregated item summary as a table
            if (sortedAggregatedItems.length === 0) {
                emptyItemsSummaryMessageEl.classList.remove('hidden');
                reportItemsSummaryEl.innerHTML = ''; // Ensure no table is rendered if empty
            } else {
                emptyItemsSummaryMessageEl.classList.add('hidden');
                const summaryTable = document.createElement('table');
                summaryTable.className = 'w-full table-auto border-collapse border border-gray-600 text-gray-200';
                summaryTable.innerHTML = `
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left border border-gray-600">Item Name</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Quantity Sold</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Total Revenue</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = summaryTable.querySelector('tbody');
                sortedAggregatedItems.forEach((item, index) => {
                    const row = tbody.insertRow();
                    row.className = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-900'; // Zebra stripping
                    row.innerHTML = `
                        <td class="px-4 py-2 border border-gray-700 text-left">${item.name}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right">${formatNumber(item.quantity)}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right">${formatCurrency(item.totalRevenue)}</td>
                    `;
                });
                reportItemsSummaryEl.appendChild(summaryTable);
            }

            // Display individual sales in the report details list as a table
            if (filteredSales.length === 0) {
                emptyDetailsListMessageEl.classList.remove('hidden');
                reportDetailsListEl.innerHTML = ''; // Ensure no table is rendered if empty
            } else {
                emptyDetailsListMessageEl.classList.add('hidden');
                const detailsTable = document.createElement('table');
                detailsTable.className = 'w-full table-auto border-collapse border border-gray-600 text-gray-200';
                detailsTable.innerHTML = `
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-4 py-2 text-left border border-gray-600">Invoice ID</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Date/Time</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Customer</th>
                            <th class="px-4 py-2 text-left border border-gray-600">Items Sold</th>
                            <th class="px-4 py-2 text-right border border-gray-600">Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = detailsTable.querySelector('tbody');
                filteredSales.sort((a, b) => {
                    const dateA = a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                    const dateB = b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                    return dateB - dateA;
                });
                filteredSales.forEach((log, index) => {
                    const logDate = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleDateString();
                    const logTime = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const itemsSoldText = log.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                    const row = tbody.insertRow();
                    row.className = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-900'; // Zebra stripping
                    row.innerHTML = `
                        <td class="px-4 py-2 border border-gray-700 text-left text-sm">${log.salesInvoiceId}</td>
                        <td class="px-4 py-2 border border-gray-700 text-left text-sm">${logDate} ${logTime}</td>
                        <td class="px-4 py-2 border border-gray-700 text-left text-sm">${log.customerName || 'N/A'}</td>
                        <td class="px-4 py-2 border border-gray-700 text-left text-sm">${itemsSoldText}</td>
                        <td class="px-4 py-2 border border-gray-700 text-right">${formatCurrency(log.total)}</td>
                    `;
                });
                reportDetailsListEl.appendChild(detailsTable);
            }
        }

        /**
         * Renders the list of existing users for management.
         * This function fetches user roles from Firestore and displays them.
         */
        async function renderUserList() {
            existingUsersListEl.innerHTML = '';
            emptyUsersMessageEl.classList.add('hidden'); // Hide initially

            if (userRole !== 'admin') {
                existingUsersListEl.innerHTML = '<p class="text-red-400 text-center py-8">You do not have permission to view user accounts.</p>';
                return;
            }

            if (users.length === 0) {
                emptyUsersMessageEl.classList.remove('hidden');
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full table-auto border-collapse border border-gray-600 text-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-4 py-2 text-left border border-gray-600">Email</th>
                        <th class="px-4 py-2 text-left border border-gray-600">Role</th>
                        <th class="px-4 py-2 text-center border border-gray-600">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            users.sort((a, b) => (a.email > b.email ? 1 : -1)).forEach((user, index) => {
                const row = tbody.insertRow();
                row.className = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-900'; // Zebra stripping
                row.innerHTML = `
                    <td class="px-4 py-2 border border-gray-700 text-left">${user.email}</td>
                    <td class="px-4 py-2 border border-gray-700 text-left">
                        <select class="user-role-select bg-gray-700 border border-gray-600 rounded-md p-1" data-uid="${user.uid}">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                    <td class="px-4 py-2 border border-gray-700 text-center">
                        ${user.uid !== auth.currentUser.uid ? `
                            <button class="delete-user-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm" data-uid="${user.uid}" data-email="${user.email}">Delete</button>
                        ` : '<span class="text-gray-500 text-sm">Cannot delete self</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
            existingUsersListEl.appendChild(table);

            // Attach event listeners for role changes and delete buttons
            document.querySelectorAll('.user-role-select').forEach(select => {
                select.onchange = async (e) => {
                    const uid = e.target.dataset.uid;
                    const newRole = e.target.value;
                    await changeUserRole(uid, newRole);
                };
            });
            document.querySelectorAll('.delete-user-btn').forEach(button => {
                button.onclick = async (e) => {
                    const uid = e.target.dataset.uid;
                    const email = e.target.dataset.email;
                    await deleteUserFromFirestore(uid, email); // Only delete role from Firestore
                };
            });
        }


        // --- Cart Management Functions ---

        /**
         * Adds a product to the cart.
         * @param {string} productId
         */
        function addToCart(productId) {
            const product = inventory.find(item => item.id === productId);
            if (!product) {
                showMessageBox('Error', 'Product not found.');
                return;
            }
            if (product.stock <= 0) {
                showMessageBox('Out of Stock', `${product.name} is currently out of stock.`);
                return;
            }

            const existingCartItem = cart.find(item => item.id === productId);

            if (existingCartItem) {
                if (existingCartItem.quantity < product.stock) {
                    existingCartItem.quantity++;
                } else {
                    showMessageBox('Stock Limit', `You can only add up to ${product.stock} of ${product.name}.`);
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    imageUrl: product.imageUrl, // Keep image URL for cart display
                    quantity: 1
                });
            }
            renderCart();
        }

        /**
         * Updates the quantity of a product in the cart.
         * @param {string} productId
         * @param {number} change - Quantity to add or subtract (e.g., 1 or -1).
         */
        function updateCartQuantity(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            const product = inventory.find(item => item.id === productId);

            if (cartItem && product) {
                if (change > 0) { // Increase
                    if (cartItem.quantity + change <= product.stock) {
                        cartItem.quantity += change;
                    } else {
                        showMessageBox('Stock Limit', `You can only add up to ${product.stock} of ${product.name}.`);
                    }
                } else { // Decrease
                    cartItem.quantity += change;
                    if (cartItem.quantity <= 0) {
                        removeFromCart(productId);
                        return;
                    }
                }
                renderCart();
            }
        }

        /**
         * Removes a product from the cart.
         * @param {string} productId
         */
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
        }

        /**
         * Calculates and updates the subtotal, tax, discount and total.
         */
        function calculateTotals() {
            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountAmount = 0;

            if (appliedCoupon) {
                if (appliedCoupon.type === 'fixed') {
                    discountAmount = appliedCoupon.value;
                } else if (appliedCoupon.type === 'percentage') {
                    discountAmount = subtotal * (appliedCoupon.value / 100);
                }
                // Ensure discount doesn't exceed subtotal
                discountAmount = Math.min(discountAmount, subtotal);
                appliedDiscountDisplayRowEl.classList.remove('hidden');
            } else {
                appliedDiscountDisplayRowEl.classList.add('hidden');
            }

            const total = subtotal - discountAmount;

            subtotalEl.textContent = formatCurrency(subtotal);
            appliedDiscountEl.textContent = formatCurrency(discountAmount);
            totalEl.textContent = formatCurrency(total);

            // Enable/disable checkout button
            if (cart.length > 0) {
                checkoutButtonEl.classList.remove('opacity-50', 'cursor-not-allowed');
                checkoutButtonEl.disabled = false;
            } else {
                checkoutButtonEl.classList.add('opacity-50', 'cursor-not-allowed');
                checkoutButtonEl.disabled = true;
            }
        }

        /**
         * Handles the application of a coupon code.
         */
        async function applyCoupon() {
            const code = couponCodeInputEl.value.trim().toUpperCase();
            if (!code) {
                appliedCoupon = null; // Clear any previously applied coupon
                couponStatusMessageEl.textContent = 'Enter a coupon code.';
                calculateTotals();
                return;
            }

            const foundCoupon = coupons.find(c => c.code === code);

            if (!foundCoupon) {
                appliedCoupon = null;
                couponStatusMessageEl.textContent = 'Invalid coupon code.';
                calculateTotals();
                return;
            }

            if (!isValidCoupon(foundCoupon, true)) { // Check usage limit as well
                appliedCoupon = null;
                couponStatusMessageEl.textContent = 'Coupon is not active or has expired/exceeded usage limit.';
                calculateTotals();
                return;
            }

            appliedCoupon = foundCoupon;
            couponStatusMessageEl.textContent = `Coupon '${appliedCoupon.code}' applied!`;
            calculateTotals();
        }


        // --- Firebase Operations ---

        /**
         * Initializes Firebase app and services.
         * Uses environment variables for configuration in Canvas environment.
         */
        async function initializeFirebase() {
            try {
                // Check if Firebase config is available from the environment
                const firebaseConfig = window.__firebase_config || JSON.parse(atob(
                    // Fallback to a hardcoded placeholder if not in Canvas environment
                    'eyJhcGlLZXkiOiJBQUFBQUFBQUFBRWdzbXh4WnE2b0hBQUFBQUFBQUFBQWF3RXl2MHFBIiwiYXV0aERvbWFpbiI6ImdhcmFoZS1uaS1odWx5by1wb3MuZmlyZWJhc2VhcHAuY29tIiwicHJvamVjdElkIjoiZ2FyYWhlLW5pLWh1bHlvdC1wb3MiLCJzdG9yYWdlQnVja2V0IjoiZ2FyYWhlLW5pLWh1bHl5by1wb3MuYXBwc3BvdC5jb20iLCJtZXNzYWdpbmdTZW5kZXJJRCI6IjEwNjM4MTAwOTM2MCIsImFwcElkIjoiMTo3OTQwODcwMjk3MzYwOmFuZHJvaWQ6Y2I3ODRkMzU1ZmU2NzA5YzM0NGI2ZSIsIm1lYXN1cmVtZW50SWQiOiJHQS0xMjM0NS1cIlcifQ=='
                ));

                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.getAuth(firebaseApp);
                db = firebase.getFirestore(firebaseApp);
                storage = firebase.getStorage(firebaseApp); // NEW: Initialize Storage

                isFirebaseReady = true;
                console.log("Firebase initialized successfully!");

                // Set up auth state listener
                firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = `User ID: ${userId}`;

                        // Fetch user role from Firestore
                        const userRoleRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/roles`, user.uid);
                        const roleSnap = await firebase.getDoc(userRoleRef);

                        if (roleSnap.exists() && roleSnap.data().role) {
                            userRole = roleSnap.data().role;
                        } else {
                            // Default to 'user' role if no role found in Firestore
                            userRole = 'user';
                            await firebase.setDoc(userRoleRef, { role: 'user', email: user.email }, { merge: true }); // Create role entry if not exists
                        }

                        // Start real-time listeners only after user is authenticated and role is set
                        startRealtimeListeners();
                        closeLoginModal(); // Close login modal on successful login
                        appContentWrapperEl.classList.remove('hidden'); // Show main app content
                    } else {
                        // User is signed out
                        userId = 'guest';
                        userRole = 'guest';
                        userIdDisplayEl.textContent = 'Not Logged In';
                        // Unsubscribe from real-time listeners if they were active
                        if (inventoryUnsubscribe) inventoryUnsubscribe();
                        if (salesLogsUnsubscribe) salesLogsUnsubscribe();
                        if (couponsUnsubscribe) couponsUnsubscribe();
                        if (usersUnsubscribe) usersUnsubscribe(); // NEW: Unsubscribe users
                        openLoginModal(); // Show login modal when logged out
                        appContentWrapperEl.classList.add('hidden'); // Hide main app content
                    }
                    updateUIForUserRole();
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox('Firebase Error', 'Failed to initialize Firebase. Please check your configuration and internet connection.');
            }
        }

        /**
         * Starts real-time listeners for Firestore collections.
         */
        function startRealtimeListeners() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const inventoryCollectionRef = firebase.collection(db, `artifacts/${window.__app_id || 'default'}/public/data/inventory`);
            const salesLogsCollectionRef = firebase.collection(db, `artifacts/${window.__app_id || 'default'}/public/data/sales`);
            const couponsCollectionRef = firebase.collection(db, `artifacts/${window.__app_id || 'default'}/public/data/coupons`);
            const usersCollectionRef = firebase.collection(db, `artifacts/${window.__app_id || 'default'}/public/data/roles`); // NEW: Users collection ref

            // Inventory Listener
            inventoryLoadingEl.classList.remove('hidden');
            inventoryUnsubscribe = firebase.onSnapshot(inventoryCollectionRef, (snapshot) => {
                const fetchedInventory = [];
                let maxProductIdNum = 0; // To ensure productCounter is always higher than existing IDs
                snapshot.forEach(doc => {
                    fetchedInventory.push({ id: doc.id, ...doc.data() });
                    const match = doc.id.match(/ITEM-(\d+)/);
                    if (match) {
                        maxProductIdNum = Math.max(maxProductIdNum, parseInt(match[1]));
                    }
                });
                inventory = fetchedInventory; // Update global inventory array
                productCounter = maxProductIdNum + 1; // Set productCounter for new products
                renderInventory(); // Re-render inventory after data update
                renderMasterList(); // Re-render master list
                inventoryLoadingEl.classList.add('hidden');
            }, (error) => {
                console.error("Error listening to inventory:", error);
                if (auth.currentUser && userRole === 'admin') {
                    showMessageBox('Data Error', 'Failed to load inventory data. Please check your connection and security rules.');
                }
                inventoryLoadingEl.classList.add('hidden');
                masterListLoadingEl.classList.add('hidden');
            });

            // Sales Logs Listener
            salesLogLoadingEl.classList.remove('hidden');
            salesLogsUnsubscribe = firebase.onSnapshot(salesLogsCollectionRef, (snapshot) => {
                const fetchedSalesLogs = [];
                snapshot.forEach(doc => {
                    fetchedSalesLogs.push({ id: doc.id, ...doc.data() });
                });
                salesLogs = fetchedSalesLogs; // Update global salesLogs array
                renderReportLogs(); // Re-render the report logs
                renderSalesReport(); // Re-render the sales report with new data
                salesLogLoadingEl.classList.add('hidden');
                // Update salesInvoiceCounter to ensure unique new IDs
                if (salesLogs.length > 0) {
                    const maxInvoiceNum = salesLogs.reduce((max, log) => {
                        const match = log.salesInvoiceId ? log.salesInvoiceId.match(/INV-(\d+)/) : null;
                        return match ? Math.max(max, parseInt(match[1])) : max;
                    }, 1000); // Start from 1000 if no logs
                    salesInvoiceCounter = maxInvoiceNum + 1;
                }
            }, (error) => {
                console.error("Error listening to sales logs:", error);
                // Only show data error if user is logged in and is admin
                if (auth.currentUser && userRole === 'admin') {
                    showMessageBox('Data Error', 'Failed to load sales log data. Please check your connection and security rules.');
                }
                salesLogLoadingEl.classList.add('hidden');
            });

            // Coupons Listener
            couponsUnsubscribe = firebase.onSnapshot(couponsCollectionRef, (snapshot) => {
                const fetchedCoupons = [];
                snapshot.forEach(doc => {
                    fetchedCoupons.push({ id: doc.id, ...doc.data() });
                });
                coupons = fetchedCoupons; // Update global coupons array
                renderCoupons(); // Render the coupon list
                // If the currently applied coupon is no longer valid, clear it
                if (appliedCoupon) {
                    const updatedAppliedCoupon = coupons.find(c => c.id === appliedCoupon.id);
                    if (!updatedAppliedCoupon || !isValidCoupon(updatedAppliedCoupon, true)) { // Pass true to also check usage limit
                        appliedCoupon = null;
                        couponCodeInputEl.value = '';
                        couponStatusMessageEl.textContent = 'Applied coupon is no longer valid.';
                        calculateTotals(); // Recalculate if coupon became invalid
                    } else {
                        // If still valid, update the appliedCoupon object in case its state changed
                        appliedCoupon = updatedAppliedCoupon;
                        calculateTotals(); // Recalculate to ensure discount is correct with any changes
                    }
                }
            }, (error) => {
                console.error("Error listening to coupons:", error);
                if (auth.currentUser && userRole === 'admin') {
                    showMessageBox('Data Error', 'Failed to load coupon data. Please check your connection and security rules.');
                }
            });

            // NEW: Users Listener
            usersUnsubscribe = firebase.onSnapshot(usersCollectionRef, (snapshot) => {
                const fetchedUsers = [];
                snapshot.forEach(doc => {
                    fetchedUsers.push({ uid: doc.id, ...doc.data() });
                });
                users = fetchedUsers; // Update global users array
                if (document.getElementById('user-management-content').classList.contains('flex')) {
                     renderUserList(); // Re-render user list if user management tab is active
                }
            }, (error) => {
                console.error("Error listening to user roles:", error);
                if (auth.currentUser && userRole === 'admin') {
                    showMessageBox('Data Error', 'Failed to load user data. Please check your connection and security rules.');
                }
            });
        }

        // Helper function for coupon validation (can be reused)
        function isValidCoupon(coupon, checkUsageLimit = false) {
            const now = new Date();
            const validFromDate = new Date(coupon.validFrom);
            const validUntilDate = new Date(coupon.validUntil);

            if (!coupon.isActive) return false;
            if (now < validFromDate) return false;
            if (now > validUntilDate) return false;
            if (checkUsageLimit && coupon.usageLimit > 0 && coupon.usedCount >= coupon.usageLimit) return false;

            return true;
        }

        // --- Authentication and Authorization Functions ---

        /**
         * Updates the UI based on the current user's authentication state and role.
         */
        function updateUIForUserRole() {
            currentUserRoleEl.textContent = `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;

            // Hide/Show navigation tabs based on role
            document.querySelectorAll('.admin-only').forEach(el => {
                if (userRole === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // Hide/Show main content areas based on role
            document.querySelectorAll('.admin-only-content').forEach(el => {
                if (userRole === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // If a restricted tab is currently active, switch to dashboard
            const activeTabButton = document.querySelector('.tab-button.active');
            if (activeTabButton && activeTabButton.classList.contains('admin-only') && userRole !== 'admin') {
                switchMainTab('inventory');
            }

            // Update Login/Logout button text
            if (userRole === 'guest') {
                loginLogoutButtonEl.textContent = 'Login';
                loginLogoutButtonEl.classList.remove('bg-red-600', 'hover:bg-red-700', 'active:bg-red-800');
                loginLogoutButtonEl.classList.add('bg-purple-600', 'hover:bg-purple-700', 'active:bg-purple-800');
            } else {
                loginLogoutButtonEl.textContent = 'Logout';
                loginLogoutButtonEl.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'active:bg-purple-800');
                loginLogoutButtonEl.classList.add('bg-red-600', 'hover:bg-red-700', 'active:bg-red-800');
            }
        }

        /**
         * Opens the login modal.
         */
        function openLoginModal() {
            loginModalContainerEl.classList.remove('hidden');
            appContentWrapperEl.classList.add('hidden'); // Hide main app when showing login modal
            loginEmailEl.value = '';
            loginPasswordEl.value = '';
        }

        /**
         * Closes the login modal.
         */
        function closeLoginModal() {
            loginModalContainerEl.classList.add('hidden');
            appContentWrapperEl.classList.remove('hidden'); // Show main app after login modal is closed
        }

        /**
         * Handles user login with email and password.
         */
        async function handleLogin() {
            const email = loginEmailEl.value;
            const password = loginPasswordEl.value;

            if (!email || !password) {
                showMessageBox('Login Error', 'Please enter both email and password.');
                return;
            }

            try {
                const userCredential = await firebase.signInWithEmailAndPassword(auth, email, password);
                // Auth state listener will handle updating UI and userRole
                // No need to call closeLoginModal() here, onAuthStateChanged handles it.
                showMessageBox('Login Success', `Welcome, ${userCredential.user.email}!`);
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = 'Login failed. Please check your credentials.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed login attempts. Please try again later.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'Email/Password sign-in is not enabled. Please enable it in Firebase Authentication.';
                }
                showMessageBox('Login Error', errorMessage);
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            const confirmed = await showMessageBox('Confirm Logout', 'Are you sure you want to log out?', true);
            if (confirmed) {
                try {
                    await firebase.signOut(auth);
                    showMessageBox('Logout Success', 'You have been logged out.');
                    // onAuthStateChanged will handle role and UI update and showing login modal
                } catch (error) {
                    console.error("Logout error:", error);
                    showMessageBox('Logout Error', 'Failed to log out. Please try again.');
                }
            }
        }

        /**
         * Adds a new user to Firebase Authentication and sets their role in Firestore.
         */
        async function addNewUser() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to add new users.');
                return;
            }
            const email = newUserEmailEl.value.trim();
            const password = newUserPasswordEl.value.trim();
            const role = newUserRoleEl.value;

            if (!email || !password || !role) {
                showMessageBox('Input Error', 'Please fill in all fields (Email, Password, Role).');
                return;
            }
            if (password.length < 6) {
                showMessageBox('Input Error', 'Password must be at least 6 characters long.');
                return;
            }

            try {
                // Create user in Firebase Authentication
                const userCredential = await firebase.createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                // Set user role in Firestore
                await firebase.setDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/roles`, uid), {
                    email: email,
                    role: role,
                    createdAt: firebase.serverTimestamp()
                });

                showMessageBox('Success', `User ${email} added with role: ${role}.`);
                newUserEmailEl.value = '';
                newUserPasswordEl.value = '';
                newUserRoleEl.value = 'user'; // Reset to default
                // User list will automatically update via listener
            } catch (error) {
                console.error("Error adding new user:", error);
                let errorMessage = 'Failed to add user.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'The email address is already in use by another account.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'The password is too weak. Please choose a stronger password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'The email address is not valid.';
                }
                showMessageBox('Error', errorMessage);
            }
        }

        /**
         * Changes a user's role in Firestore.
         * @param {string} uid - User ID.
         * @param {string} newRole - New role ('user' or 'admin').
         */
        async function changeUserRole(uid, newRole) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to change user roles.');
                return;
            }
            if (uid === auth.currentUser.uid && newRole !== 'admin') {
                const confirmed = await showMessageBox('Confirm Role Change', 'Changing your own role from admin to user might prevent you from managing other users. Are you sure?', true);
                if (!confirmed) {
                    // Revert the dropdown selection if user cancels
                    const selectEl = document.querySelector(`.user-role-select[data-uid="${uid}"]`);
                    if (selectEl) selectEl.value = userRole; // Revert to old role
                    return;
                }
            }

            try {
                await firebase.updateDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/roles`, uid), {
                    role: newRole
                });
                showMessageBox('Success', `User role updated to ${newRole}.`);
            } catch (error) {
                console.error("Error updating user role:", error);
                showMessageBox('Error', 'Failed to update user role. ' + error.message);
            }
        }

        /**
         * Deletes a user's role document from Firestore.
         * Note: Directly deleting a user from Firebase Auth client-side is complex and requires re-authentication.
         * This function removes the user's *role* entry, effectively limiting their access.
         * Full Firebase Auth user deletion should ideally be done via a Cloud Function.
         * @param {string} uid - User ID to delete.
         * @param {string} email - User email for confirmation.
         */
        async function deleteUserFromFirestore(uid, email) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to delete users.');
                return;
            }
            if (uid === auth.currentUser.uid) {
                showMessageBox('Error', 'You cannot delete your own account from this interface.');
                return;
            }

            const confirmed = await showMessageBox('Confirm Deletion', `Are you sure you want to delete the role for user "${email}"? This will limit their access to the system. Full account deletion requires re-authentication or server-side operation.`, true);
            if (!confirmed) return;

            try {
                await firebase.deleteDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/roles`, uid));
                showMessageBox('Success', `User role for ${email} deleted. Their access will be limited.`);
            } catch (error) {
                console.error("Error deleting user role:", error);
                showMessageBox('Error', 'Failed to delete user role. ' + error.message);
            }
        }

        // --- Product Management Functions (Add/Edit/Delete/Restock) ---

        /**
         * Opens the "Manage Products" modal.
         */
        function openManageProductModal() {
            manageProductModalContainerEl.classList.remove('hidden');
            // Default to Add Product tab
            switchModalTab('add-product');
            resetAddProductForm(); // Clear form when opening
        }

        /**
         * Closes the "Manage Products" modal.
         */
        function closeManageProductModal() {
            manageProductModalContainerEl.classList.add('hidden');
        }

        /**
         * Switches the active tab within the "Manage Products" modal.
         * @param {string} tabName - 'add-product' or 'restock'.
         */
        function switchModalTab(tabName) {
            document.querySelectorAll('.modal-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.modal-tab-button').forEach(button => {
                button.classList.remove('active');
            });

            if (tabName === 'add-product') {
                addProductFormEl.classList.remove('hidden');
                addProductFormEl.classList.add('flex'); // Ensure flex
                modalTabAddProductBtn.classList.add('active');
                addProductBtnEl.classList.remove('hidden'); // Show Add button
                updateProductBtnEl.classList.add('hidden'); // Hide Update button
                resetAddProductForm();
            } else if (tabName === 'restock') {
                restockProductFormEl.classList.remove('hidden');
                restockProductFormEl.classList.add('flex'); // Ensure flex
                modalTabRestockBtn.classList.add('active');
                renderModalRestockList(); // Render restock list
            }
        }

        /**
         * Resets the Add Product form fields.
         */
        function resetAddProductForm() {
            productIdEl.value = `ITEM-${String(productCounter).padStart(3, '0')}`; // Auto-generate ID
            productNameEl.value = '';
            productCategoryEl.value = '';
            productPriceEl.value = '';
            productStockEl.value = '';
            productImageInputEl.value = ''; // Clear file input
            addProductBtnEl.classList.remove('hidden');
            updateProductBtnEl.classList.add('hidden');
        }

        /**
         * Adds a new product to Firestore.
         */
        async function addNewProduct() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to add products.');
                return;
            }

            const id = productIdEl.value;
            const name = productNameEl.value.trim();
            const category = productCategoryEl.value.trim();
            const price = parseFloat(productPriceEl.value);
            const stock = parseInt(productStockEl.value);
            const imageFile = productImageInputEl.files[0]; // Get the File object

            if (!name || !category || isNaN(price) || price < 0 || isNaN(stock) || stock < 0) {
                showMessageBox('Input Error', 'Please fill in all product details correctly.');
                return;
            }

            try {
                let imageUrl = '';
                if (imageFile) {
                    const storageRef = firebase.ref(storage, `product_images/${id}/${imageFile.name}`);
                    const uploadTask = await firebase.uploadBytes(storageRef, imageFile);
                    imageUrl = await firebase.getDownloadURL(uploadTask.ref);
                }

                await firebase.setDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/inventory`, id), {
                    name: name,
                    category: category,
                    price: price,
                    stock: stock,
                    imageUrl: imageUrl, // Store the URL
                    createdAt: firebase.serverTimestamp(),
                    updatedAt: firebase.serverTimestamp()
                });

                showMessageBox('Success', `Product "${name}" added successfully!`);
                resetAddProductForm();
                closeManageProductModal();
                renderInventory(); // Refresh inventory list
                renderMasterList(); // Refresh master list
            } catch (error) {
                console.error("Error adding product:", error);
                showMessageBox('Error', 'Failed to add product. ' + error.message);
            }
        }

        /**
         * Populates the form with product data for editing.
         * @param {string} productId
         */
        function editProduct(productId) {
            if (userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to edit products.');
                return;
            }

            const productToEdit = inventory.find(item => item.id === productId);
            if (!productToEdit) {
                showMessageBox('Error', 'Product not found for editing.');
                return;
            }

            openManageProductModal();
            switchModalTab('add-product'); // Use the add product form for editing

            productIdEl.value = productToEdit.id;
            productNameEl.value = productToEdit.name;
            productCategoryEl.value = productToEdit.category;
            productPriceEl.value = productToEdit.price;
            productStockEl.value = productToEdit.stock;
            // productImageInputEl.value = ''; // Do not pre-fill file input, user selects new if needed

            addProductBtnEl.classList.add('hidden'); // Hide Add button
            updateProductBtnEl.classList.remove('hidden'); // Show Update button
            updateProductBtnEl.dataset.id = productToEdit.id; // Store ID for update operation
        }

        /**
         * Updates an existing product in Firestore.
         */
        async function updateProduct() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to update products.');
                return;
            }

            const id = updateProductBtnEl.dataset.id;
            const name = productNameEl.value.trim();
            const category = productCategoryEl.value.trim();
            const price = parseFloat(productPriceEl.value);
            const stock = parseInt(productStockEl.value);
            const imageFile = productImageInputEl.files[0];

            if (!id || !name || !category || isNaN(price) || price < 0 || isNaN(stock) || stock < 0) {
                showMessageBox('Input Error', 'Please fill in all product details correctly.');
                return;
            }

            try {
                let updatedData = {
                    name: name,
                    category: category,
                    price: price,
                    stock: stock,
                    updatedAt: firebase.serverTimestamp()
                };

                // Handle image update
                if (imageFile) {
                    const storageRef = firebase.ref(storage, `product_images/${id}/${imageFile.name}`);
                    const uploadTask = await firebase.uploadBytes(storageRef, imageFile);
                    updatedData.imageUrl = await firebase.getDownloadURL(uploadTask.ref);
                    // Optional: Delete old image if a new one is uploaded and URL changes
                    // This would require storing the old imageUrl and comparing/deleting.
                    // For simplicity, we'll just update the URL.
                }

                await firebase.updateDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/inventory`, id), updatedData);

                showMessageBox('Success', `Product "${name}" updated successfully!`);
                closeManageProductModal();
                renderInventory(); // Refresh inventory list
                renderMasterList(); // Refresh master list
            } catch (error) {
                console.error("Error updating product:", error);
                showMessageBox('Error', 'Failed to update product. ' + error.message);
            }
        }


        /**
         * Deletes a product from Firestore.
         * @param {string} productId
         */
        async function deleteProduct(productId) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to delete products.');
                return;
            }

            const productToDelete = inventory.find(item => item.id === productId);
            if (!productToDelete) {
                showMessageBox('Error', 'Product not found.');
                return;
            }

            const confirmed = await showMessageBox('Confirm Deletion', `Are you sure you want to delete "${productToDelete.name}"? This action cannot be undone.`, true);
            if (!confirmed) return;

            try {
                // Optional: Delete image from Firebase Storage if it exists
                if (productToDelete.imageUrl) {
                    const imageRef = firebase.ref(storage, productToDelete.imageUrl); // This assumes imageUrl is a full gs:// or https:// URL, which can be parsed by ref()
                    try {
                        await firebase.deleteObject(imageRef);
                        console.log("Image deleted from storage.");
                    } catch (storageError) {
                        if (storageError.code === 'storage/object-not-found') {
                            console.warn("Image not found in storage, skipping deletion.");
                        } else {
                            console.error("Error deleting image from storage:", storageError);
                            showMessageBox('Storage Error', 'Failed to delete product image from storage. Product record deleted anyway.');
                        }
                    }
                }

                await firebase.deleteDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/inventory`, productId));
                showMessageBox('Success', `Product "${productToDelete.name}" deleted successfully!`);
                // Lists will refresh via real-time listener
            } catch (error) {
                console.error("Error deleting product:", error);
                showMessageBox('Error', 'Failed to delete product. ' + error.message);
            }
        }

        /**
         * Renders the list of products for restock selection in the modal.
         */
        function renderModalRestockList() {
            restockProductListEl.innerHTML = '';
            emptyRestockMessageEl.classList.remove('hidden');

            const searchTerm = restockSearchInputEl.value.toLowerCase();
            const filteredProducts = inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm) || item.id.toLowerCase().includes(searchTerm)
            );

            if (filteredProducts.length === 0) {
                emptyRestockMessageEl.classList.remove('hidden');
                restockProductListEl.innerHTML = '<p class="text-gray-400 text-center py-8">No matching products found.</p>';
            } else {
                emptyRestockMessageEl.classList.add('hidden');
                filteredProducts.forEach(item => {
                    const productDiv = document.createElement('div');
                    productDiv.className = `flex items-center justify-between p-3 mb-2 bg-gray-800 rounded-lg border border-gray-700
                                            cursor-pointer hover:bg-gray-700 transition duration-200`;
                    productDiv.innerHTML = `
                        <div>
                            <p class="text-white font-semibold">${item.name} (${item.id})</p>
                            <p class="text-gray-400 text-sm">Current Stock: ${item.stock}</p>
                        </div>
                        <button class="select-restock-product-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm"
                                data-id="${item.id}" data-name="${item.name}" data-stock="${item.stock}">
                            Select
                        </button>
                    `;
                    restockProductListEl.appendChild(productDiv);
                });

                document.querySelectorAll('.select-restock-product-btn').forEach(button => {
                    button.onclick = (e) => {
                        const id = e.target.dataset.id;
                        const name = e.target.dataset.name;
                        const stock = e.target.dataset.stock;
                        restockSelectedProductIdEl.value = id;
                        restockSelectedProductEl.value = `${name} (Current Stock: ${stock})`;
                        restockQuantityEl.value = ''; // Clear quantity
                    };
                });
            }
        }

        /**
         * Confirms and performs the restock operation.
         */
        async function confirmRestock() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to restock products.');
                return;
            }

            const productId = restockSelectedProductIdEl.value;
            const quantityToAdd = parseInt(restockQuantityEl.value);

            if (!productId) {
                showMessageBox('Input Error', 'Please select a product to restock.');
                return;
            }
            if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                showMessageBox('Input Error', 'Please enter a valid quantity to add (must be a positive number).');
                return;
            }

            const productRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/inventory`, productId);

            try {
                await firebase.runTransaction(db, async (transaction) => {
                    const productDoc = await transaction.get(productRef);
                    if (!productDoc.exists()) {
                        throw "Product does not exist!";
                    }

                    const newStock = productDoc.data().stock + quantityToAdd;
                    transaction.update(productRef, { stock: newStock, updatedAt: firebase.serverTimestamp() });
                });

                showMessageBox('Success', `Successfully restocked ${quantityToAdd} units for product ${productId}.`);
                closeManageProductModal();
                // Lists will auto-refresh via listener
            } catch (error) {
                console.error("Error during restock transaction:", error);
                showMessageBox('Restock Error', 'Failed to restock product: ' + error);
            }
        }


        // --- Sales and Checkout Functions ---

        /**
         * Finalizes the sale transaction.
         */
        async function finalizeSale() {
            if (!isFirebaseReady) {
                showMessageBox('Error', 'System not ready. Please try again.');
                return;
            }
            if (cart.length === 0) {
                showMessageBox('Cart Empty', 'Please add items to the cart before processing a sale.');
                return;
            }

            const confirmed = await showMessageBox('Confirm Sale', `Confirm sale for total: ${totalEl.textContent}?`, true);
            if (!confirmed) return;

            // Optional: Ask for customer name (can be implemented with an input modal)
            const customerName = 'Walk-in Customer'; // For simplicity, hardcoded for now

            const batch = firebase.writeBatch(db); // Use batch writes for atomicity

            // Check stock levels before proceeding with transaction
            for (const cartItem of cart) {
                const product = inventory.find(invItem => invItem.id === cartItem.id);
                if (!product || product.stock < cartItem.quantity) {
                    showMessageBox('Stock Error', `Not enough stock for ${cartItem.name}. Available: ${product ? product.stock : 0}, In Cart: ${cartItem.quantity}`);
                    return; // Stop the sale process
                }
            }

            const saleInvoiceId = `INV-${String(salesInvoiceCounter++).padStart(4, '0')}-${Date.now().toString().slice(-4)}`;

            try {
                // Update product stocks
                for (const item of cart) {
                    const productRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/inventory`, item.id);
                    batch.update(productRef, {
                        stock: firebase.increment(-item.quantity), // Decrement stock
                        updatedAt: firebase.serverTimestamp()
                    });
                }

                // Add sales log entry
                const saleLogRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/sales`, saleInvoiceId);
                const saleData = {
                    salesInvoiceId: saleInvoiceId,
                    timestamp: firebase.serverTimestamp(),
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    subtotal: parseFloat(subtotalEl.textContent.replace(/[₱,]/g, '')),
                    discount: parseFloat(appliedDiscountEl.textContent.replace(/[₱,]/g, '')),
                    total: parseFloat(totalEl.textContent.replace(/[₱,]/g, '')),
                    customerName: customerName,
                    userId: userId,
                    userRole: userRole,
                    isVoided: false
                };
                batch.set(saleLogRef, saleData);

                // Increment coupon usedCount if a coupon was applied
                if (appliedCoupon) {
                    const couponRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/coupons`, appliedCoupon.id);
                    batch.update(couponRef, {
                        usedCount: firebase.increment(1),
                        updatedAt: firebase.serverTimestamp()
                    });
                }

                await batch.commit(); // Commit all operations as a single batch

                showMessageBox('Sale Completed', `Sale ${saleInvoiceId} processed successfully!`);
                await viewReceipt(saleInvoiceId); // Show receipt
                cart = []; // Clear cart after successful sale
                appliedCoupon = null; // Clear applied coupon
                couponCodeInputEl.value = ''; // Clear coupon input
                couponStatusMessageEl.textContent = '';
                renderCart(); // Re-render cart (will show empty)
            } catch (error) {
                console.error("Error processing sale:", error);
                showMessageBox('Transaction Error', 'Failed to process sale. Please try again.');
            }
        }

        /**
         * Voids a completed sale, returning items to stock.
         * Uses a Firestore Transaction for atomicity.
         * @param {string} salesId - The ID of the sale to void.
         */
        async function voidSale(salesId) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to void sales.');
                return;
            }

            const confirmed = await showMessageBox('Confirm Void', `Are you sure you want to void sale ${salesId}? This will return all items to stock.`, true);
            if (!confirmed) return;

            const salesDocRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/sales`, salesId);

            try {
                await firebase.runTransaction(db, async (transaction) => {
                    const saleDoc = await transaction.get(salesDocRef);

                    if (!saleDoc.exists()) {
                        throw "Sale document does not exist!";
                    }
                    if (saleDoc.data().isVoided) {
                        throw "Sale is already voided!";
                    }

                    // Update stock for each item in the voided sale
                    for (const item of saleDoc.data().items) {
                        const productRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/inventory`, item.id);
                        transaction.update(productRef, {
                            stock: firebase.increment(item.quantity) // Return stock
                        });
                    }

                    // Mark the sale as voided
                    transaction.update(salesDocRef, {
                        isVoided: true,
                        voidedAt: firebase.serverTimestamp(),
                        voidedBy: userId
                    });

                    // Decrement coupon usedCount if a coupon was used in this voided sale
                    const couponCodeUsed = saleDoc.data().couponCode; // Assuming you add couponCode to sales data
                    if (couponCodeUsed) {
                         const coupon = coupons.find(c => c.code === couponCodeUsed);
                         if (coupon) {
                            const couponRef = firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/coupons`, coupon.id);
                            // Ensure usedCount does not go below 0
                            if (coupon.usedCount > 0) {
                                transaction.update(couponRef, {
                                    usedCount: firebase.increment(-1)
                                });
                            }
                         }
                    }
                });

                showMessageBox('Success', `Sale ${salesId} has been voided and items returned to stock.`);
                // sales logs will re-render automatically via listener
            } catch (error) {
                console.error("Error voiding sale:", error);
                showMessageBox('Void Error', 'Failed to void sale: ' + error);
            }
        }


        // --- Receipt and Report Functions ---

        /**
         * Displays a detailed receipt in a new window.
         * @param {string} salesId - The ID of the sale to view the receipt for.
         */
        async function viewReceipt(salesId) {
            const sale = salesLogs.find(log => log.id === salesId);
            if (!sale) {
                showMessageBox('Error', 'Sale not found.');
                return;
            }

            const receiptContent = renderReceiptContent(sale);

            const printWindow = window.open('', '_blank', 'width=600,height=800,scrollbars=yes,resizable=yes');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Sales Receipt - ${sale.salesInvoiceId}</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; color: #333; }
                        .receipt-container { width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #eee; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 24px; color: #1a202c; }
                        .header p { margin: 5px 0; font-size: 14px; color: #555; }
                        .details { margin-bottom: 20px; font-size: 14px; }
                        .details div { margin-bottom: 5px; }
                        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .items-table th, .items-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .items-table th { background-color: #f2f2f2; }
                        .totals { text-align: right; font-size: 16px; font-weight: bold; }
                        .totals div { margin-bottom: 5px; }
                        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #777; }
                        @media print {
                            body { margin: 0; }
                            .receipt-container { border: none; box-shadow: none; padding: 0; max-width: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        ${receiptContent}
                    </div>
                    <script>
                        // Automatically print when content is loaded
                        window.onload = function() {
                            window.print();
                        };
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        /**
         * Generates the HTML content for a sales receipt.
         * @param {Object} sale - The sale object.
         * @returns {string} HTML string for the receipt.
         */
        function renderReceiptContent(sale) {
            const saleDate = (sale.timestamp.toDate ? sale.timestamp.toDate() : new Date(sale.timestamp)).toLocaleString();
            const itemsHtml = sale.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${formatCurrency(item.price * item.quantity)}</td>
                </tr>
            `).join('');

            return `
                <div class="header">
                    <h1>Garahe ni Hulyo</h1>
                    <p>Your Trusted Auto Parts Partner</p>
                    <p>Quezon City, Metro Manila</p>
                </div>
                <div class="details">
                    <div><strong>Invoice ID:</strong> ${sale.salesInvoiceId}</div>
                    <div><strong>Date:</strong> ${saleDate}</div>
                    <div><strong>Cashier:</strong> ${sale.userId} (${sale.userRole})</div>
                    <div><strong>Customer:</strong> ${sale.customerName || 'N/A'}</div>
                </div>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                <div class="totals">
                    <div>Subtotal: ${formatCurrency(sale.subtotal)}</div>
                    ${sale.discount > 0 ? `<div>Discount: ${formatCurrency(sale.discount)}</div>` : ''}
                    <div><strong>Total: ${formatCurrency(sale.total)}</strong></div>
                </div>
                <div class="footer">
                    <p>Thank you for your purchase!</p>
                    <p>This is an official receipt.</p>
                </div>
            `;
        }

        /**
         * Generates a PDF report of sales.
         */
        async function generatePdfReport() {
            if (!salesLogs || salesLogs.length === 0) {
                showMessageBox('No Data', 'No sales data available to generate a report.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' size

            const margin = 10;
            let yOffset = margin;
            const lineHeight = 7;
            const cellPadding = 2;

            // Header
            doc.setFontSize(18);
            doc.text('Garahe ni Hulyo Sales Report', doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += lineHeight;

            doc.setFontSize(12);
            doc.text(`Report Period: ${reportPeriodInfoEl.textContent}`, doc.internal.pageSize.width / 2, yOffset, { align: 'center' });
            yOffset += lineHeight * 2;

            doc.setFontSize(14);
            doc.text(`Total Sales: ${reportTotalSalesEl.textContent}`, margin, yOffset);
            yOffset += lineHeight * 2;

            // Aggregated Items Summary Table
            const aggregatedItemsTableData = [];
            const aggregatedItemsTableHeaders = [['Item Name', 'Quantity Sold', 'Total Revenue']];
            const itemsSummaryContent = document.getElementById('report-items-summary');
            if (itemsSummaryContent && itemsSummaryContent.querySelector('table')) {
                itemsSummaryContent.querySelectorAll('#report-items-summary tbody tr').forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        rowData.push(cell.textContent.trim());
                    });
                    aggregatedItemsTableData.push(rowData);
                });
            }

            if (aggregatedItemsTableData.length > 0) {
                doc.setFontSize(12);
                doc.text('Items Sold Summary', margin, yOffset);
                yOffset += lineHeight;

                doc.autoTable({
                    head: aggregatedItemsTableHeaders,
                    body: aggregatedItemsTableData,
                    startY: yOffset,
                    theme: 'striped',
                    styles: { fontSize: 10, cellPadding: cellPadding, valign: 'middle' },
                    headStyles: { fillColor: [59, 130, 246], textColor: 255, fontStyle: 'bold', halign: 'center' },
                    columnStyles: {
                        0: { halign: 'left', cellWidth: 70 },
                        1: { halign: 'right', cellWidth: 40 },
                        2: { halign: 'right', cellWidth: 40 }
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        yOffset = data.cursor.y + lineHeight; // Update yOffset after table
                    }
                });
            }

            // Individual Sales Logs Table
            const salesLogTableData = [];
            const salesLogTableHeaders = [['Invoice ID', 'Date/Time', 'Customer', 'Items Sold', 'Total']];
            const detailsListContent = document.getElementById('report-details-list');
            if (detailsListContent && detailsListContent.querySelector('table')) {
                detailsListContent.querySelectorAll('#report-details-list tbody tr').forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        rowData.push(cell.textContent.trim());
                    });
                    salesLogTableData.push(rowData);
                });
            }

            if (salesLogTableData.length > 0) {
                doc.addPage(); // Start a new page for detailed sales logs if summary is long
                yOffset = margin;
                doc.setFontSize(12);
                doc.text('Individual Sales Logs', margin, yOffset);
                yOffset += lineHeight;

                doc.autoTable({
                    head: salesLogTableHeaders,
                    body: salesLogTableData,
                    startY: yOffset,
                    theme: 'striped',
                    styles: { fontSize: 8, cellPadding: cellPadding, valign: 'middle' },
                    headStyles: { fillColor: [59, 130, 246], textColor: 255, fontStyle: 'bold', halign: 'center' },
                    columnStyles: {
                        0: { halign: 'left', cellWidth: 25 },
                        1: { halign: 'left', cellWidth: 35 },
                        2: { halign: 'left', cellWidth: 30 },
                        3: { halign: 'left', cellWidth: 60 },
                        4: { halign: 'right', cellWidth: 30 }
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        // Footer for each page
                        doc.setFontSize(8);
                        doc.text(`Page ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - margin);
                    }
                });
            } else if (aggregatedItemsTableData.length === 0) {
                 // If both are empty, inform the user in the PDF
                 doc.setFontSize(12);
                 doc.text('No sales data available for the selected period.', doc.internal.pageSize.width / 2, yOffset + lineHeight, { align: 'center' });
            }


            doc.save('Garahe_ni_Hulyo_Sales_Report.pdf');
            showMessageBox('PDF Generated', 'Sales report downloaded successfully!');
        }

        // --- Coupon Management Functions ---
        async function createCoupon() {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to create coupons.');
                return;
            }

            const code = newCouponCodeEl.value.trim().toUpperCase();
            const type = newCouponTypeEl.value;
            const value = parseFloat(newCouponValueEl.value);
            const validFrom = newCouponValidFromEl.value; // YYYY-MM-DD
            const validUntil = newCouponValidUntilEl.value; // YYYY-MM-DD
            const usageLimit = parseInt(newCouponUsageLimitEl.value);

            if (!code || !type || isNaN(value) || value <= 0 || !validFrom || !validUntil || isNaN(usageLimit) || usageLimit < 0) {
                showMessageBox('Input Error', 'Please fill in all coupon fields correctly.');
                return;
            }
            if (new Date(validFrom) > new Date(validUntil)) {
                showMessageBox('Input Error', 'Valid From date cannot be after Valid Until date.');
                return;
            }
            if (coupons.some(c => c.code === code)) {
                showMessageBox('Error', 'Coupon code already exists. Please choose a unique code.');
                return;
            }

            try {
                await firebase.addDoc(firebase.collection(db, `artifacts/${window.__app_id || 'default'}/public/data/coupons`), {
                    code: code,
                    type: type,
                    value: value,
                    validFrom: validFrom,
                    validUntil: validUntil,
                    usageLimit: usageLimit,
                    usedCount: 0,
                    isActive: true,
                    createdAt: firebase.serverTimestamp(),
                    createdBy: userId
                });
                showMessageBox('Success', `Coupon "${code}" created successfully!`);
                newCouponCodeEl.value = '';
                newCouponTypeEl.value = 'fixed';
                newCouponValueEl.value = '';
                newCouponValidFromEl.value = '';
                newCouponValidUntilEl.value = '';
                newCouponUsageLimitEl.value = '0';
            } catch (error) {
                console.error("Error creating coupon:", error);
                showMessageBox('Error', 'Failed to create coupon. ' + error.message);
            }
        }

        async function toggleCouponStatus(couponId, newStatus) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to change coupon status.');
                return;
            }
            try {
                await firebase.updateDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/coupons`, couponId), {
                    isActive: newStatus,
                    updatedAt: firebase.serverTimestamp()
                });
                showMessageBox('Success', `Coupon status updated to ${newStatus ? 'Active' : 'Inactive'}.`);
            } catch (error) {
                console.error("Error toggling coupon status:", error);
                showMessageBox('Error', 'Failed to update coupon status. ' + error.message);
            }
        }

        async function deleteCoupon(couponId) {
            if (!isFirebaseReady || userRole !== 'admin') {
                showMessageBox('Access Denied', 'You do not have permission to delete coupons.');
                return;
            }
            const confirmed = await showMessageBox('Confirm Deletion', 'Are you sure you want to delete this coupon? This action cannot be undone.', true);
            if (!confirmed) return;

            try {
                await firebase.deleteDoc(firebase.doc(db, `artifacts/${window.__app_id || 'default'}/public/data/coupons`, couponId));
                showMessageBox('Success', 'Coupon deleted successfully!');
            } catch (error) {
                console.error("Error deleting coupon:", error);
                showMessageBox('Error', 'Failed to delete coupon. ' + error.message);
            }
        }

        // --- Event Listeners and Initial Load ---
        window.onload = async () => {
            await initializeFirebase();

            // Main Tab Navigation
            tabInventoryBtn.addEventListener('click', () => switchMainTab('inventory'));
            tabManageProductsBtn.addEventListener('click', () => switchMainTab('manage-products'));
            tabInventoryMasterBtn.addEventListener('click', () => switchMainTab('inventory-master'));
            tabReportLogsBtn.addEventListener('click', () => switchMainTab('report-logs'));
            tabSalesReportBtn.addEventListener('click', () => switchMainTab('sales-report'));
            tabCouponManagementBtn.addEventListener('click', () => switchMainTab('coupon-management'));
            tabUserManagementBtn.addEventListener('click', () => switchMainTab('user-management')); // NEW: User Management Tab Listener

            // Login/Logout Button
            loginLogoutButtonEl.addEventListener('click', () => {
                if (userRole === 'guest') {
                    openLoginModal();
                } else {
                    handleLogout();
                }
            });

            // Login Modal
            loginSubmitBtnEl.addEventListener('click', handleLogin);
            loginEmailEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            loginPasswordEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

            // Manage Product Modal
            manageProductModalCloseBtn.addEventListener('click', closeManageProductModal);
            modalTabAddProductBtn.addEventListener('click', () => switchModalTab('add-product'));
            modalTabRestockBtn.addEventListener('click', () => switchModalTab('restock'));

            // Add/Update Product
            addProductBtnEl.addEventListener('click', addNewProduct);
            updateProductBtnEl.addEventListener('click', updateProduct); // Attach update handler

            // Restock Product
            restockSearchInputEl.addEventListener('input', debounce(renderModalRestockList, 300)); // Debounced search
            confirmRestockBtnEl.addEventListener('click', confirmRestock);

            // Inventory Search & Filter (Debounced)
            inventorySearchInputEl.addEventListener('input', debounce(renderInventory, 300));
            categoryFilterSelectEl.addEventListener('change', renderInventory);

            // Master List Search (Debounced)
            masterListSearchInputEl.addEventListener('input', debounce(renderMasterList, 300));

            // Cart & Checkout
            applyCouponBtnEl.addEventListener('click', applyCoupon);
            checkoutButtonEl.addEventListener('click', finalizeSale);

            // Sales Report Filters
            filterDailyBtn.addEventListener('click', () => {
                currentReportFilter = 'daily';
                document.querySelectorAll('#sales-report-content button').forEach(btn => btn.classList.remove('active'));
                filterDailyBtn.classList.add('active');
                renderSalesReport();
            });
            filterWeeklyBtn.addEventListener('click', () => {
                currentReportFilter = 'weekly';
                document.querySelectorAll('#sales-report-content button').forEach(btn => btn.classList.remove('active'));
                filterWeeklyBtn.classList.add('active');
                renderSalesReport();
            });
            filterMonthlyBtn.addEventListener('click', () => {
                currentReportFilter = 'monthly';
                document.querySelectorAll('#sales-report-content button').forEach(btn => btn.classList.remove('active'));
                filterMonthlyBtn.classList.add('active');
                renderSalesReport();
            });
            downloadReportPdfBtn.addEventListener('click', generatePdfReport);

            // Coupon Management listeners
            createNewCouponBtn.addEventListener('click', createCoupon);

            // User Management Listener
            addNewUserBtnEl.addEventListener('click', addNewUser);

            // Initial renders (these will be empty/default until login occurs and data loads)
            renderCart();
            filterDailyBtn.classList.add('active'); // Set daily as default active filter for sales report
            updateUIForUserRole(); // Initial UI update based on default role (guest)
        };
    </script>
</body>
</html>
